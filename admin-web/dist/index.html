<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBQ Admin</title>
    <style>
        /* â”€â”€â”€ Reset + Variables â”€â”€â”€ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-card-hover: #222636;
            --border: #2e3244;
            --text: #e2e4ea;
            --text-muted: #8b8fa3;
            --accent: #6c63ff;
            --accent-hover: #7d76ff;
            --green: #34c759;
            --green-dim: rgba(52,199,89,0.15);
            --yellow: #ffd60a;
            --yellow-dim: rgba(255,214,10,0.15);
            --red: #ff3b30;
            --red-dim: rgba(255,59,48,0.15);
            --blue: #0a84ff;
            --blue-dim: rgba(10,132,255,0.15);
            --radius: 10px;
            --sidebar-w: 220px;
        }
        html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: var(--bg); color: var(--text); }

        /* â”€â”€â”€ Layout â”€â”€â”€ */
        .app-shell { display: flex; height: 100vh; }
        .sidebar {
            width: var(--sidebar-w); background: var(--bg-card); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-logo { padding: 24px 20px; font-size: 20px; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; }
        .sidebar-nav { flex: 1; padding: 8px 12px; }
        .nav-section-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.8px; padding: 16px 8px 6px; }
        .nav-item {
            display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-radius: 8px;
            color: var(--text-muted); cursor: pointer; font-size: 14px; transition: all 0.15s;
            text-decoration: none;
        }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text); }
        .nav-item.active { background: rgba(108,99,255,0.12); color: var(--accent); }
        .nav-item .icon { width: 18px; text-align: center; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .user-badge { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
        .user-info { font-size: 13px; }
        .user-info .user-role { font-size: 11px; color: var(--text-muted); }
        .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; padding: 4px 0; }
        .logout-btn:hover { color: var(--red); }

        .main { flex: 1; overflow-y: auto; }
        .page-header { padding: 28px 32px 12px; }
        .page-header h1 { font-size: 22px; font-weight: 600; }
        .page-header p { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .content { padding: 0 32px 32px; }

        /* â”€â”€â”€ Cards / Tables â”€â”€â”€ */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 15px; font-weight: 600; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* â”€â”€â”€ Buttons â”€â”€â”€ */
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
        .btn-danger { background: var(--red-dim); color: var(--red); }
        .btn-danger:hover { background: var(--red); color: white; }

        /* â”€â”€â”€ Badges â”€â”€â”€ */
        .badge { display: inline-block; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
        .badge-red { background: var(--red-dim); color: var(--red); }
        .badge-blue { background: var(--blue-dim); color: var(--blue); }
        .badge-muted { background: rgba(139,143,163,0.15); color: var(--text-muted); }

        /* â”€â”€â”€ Stats Grid â”€â”€â”€ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .stat-value { font-size: 26px; font-weight: 700; }

        /* â”€â”€â”€ Inputs â”€â”€â”€ */
        input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 8px; font-size: 13px; outline: none; width: 100%; }
        input:focus, select:focus { border-color: var(--accent); }
        input::placeholder { color: var(--text-muted); }
        .input-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px; }
        .input-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
        .input-group label { font-size: 12px; color: var(--text-muted); }

        /* â”€â”€â”€ Modal â”€â”€â”€ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 28px; width: 90%; max-width: 480px; max-height: 80vh; overflow-y: auto; }
        .modal h2 { font-size: 18px; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

        /* â”€â”€â”€ Toast â”€â”€â”€ */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-card); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; font-size: 14px; z-index: 200; display: none; align-items: center; gap: 10px; }
        .toast.show { display: flex; }
        .toast.error { border-color: var(--red); }

        /* â”€â”€â”€ Login Page â”€â”€â”€ */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 48px 40px; width: 380px; }
        .login-card h1 { font-size: 24px; text-align: center; margin-bottom: 8px; }
        .login-card p { color: var(--text-muted); text-align: center; font-size: 14px; margin-bottom: 28px; }
        .login-card .input-group { margin-bottom: 16px; }
        .login-card .btn-primary { width: 100%; justify-content: center; padding: 10px; font-size: 15px; }

        /* â”€â”€â”€ Ops Today â”€â”€â”€ */
        .ops-section { margin-bottom: 24px; }
        .ops-section-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .ops-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .ops-item-left { display: flex; flex-direction: column; gap: 3px; }
        .ops-item-name { font-size: 14px; font-weight: 600; }
        .ops-item-meta { font-size: 12px; color: var(--text-muted); }
        .ops-item-actions { display: flex; gap: 6px; }

        /* â”€â”€â”€ Utility â”€â”€â”€ */
        .hidden { display: none !important; }
        .mt-8 { margin-top: 8px; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .loading { color: var(--text-muted); font-size: 14px; padding: 24px; text-align: center; }
    </style>
</head>
<body>

<!-- â”€â”€â”€ LOGIN PAGE â”€â”€â”€ -->
<div id="login-page" class="login-container">
    <div class="login-card">
        <h1>TBQ Admin</h1>
        <p>Quáº£n trá»‹ há»‡ thá»‘ng</p>
        <div class="input-group">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="admin@example.com">
        </div>
        <div class="input-group">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="doLogin()" style="margin-top:8px;">ÄÄƒng nháº­p</button>
        <p id="login-error" class="text-muted" style="margin-top:12px; font-size:13px; color:var(--red); display:none;"></p>
    </div>
</div>

<!-- â”€â”€â”€ APP SHELL (hidden until logged in) â”€â”€â”€ -->
<div id="app-shell" class="app-shell hidden">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">TBQ Admin</div>
        <div class="sidebar-nav">
            <!-- Admin section -->
            <div class="nav-section-label">Admin</div>
            <a class="nav-item" data-route="admin-stock" onclick="navigate('admin-stock')">
                <span class="icon">ğŸ“¦</span> Stock
            </a>
            <a class="nav-item" data-route="admin-orders" onclick="navigate('admin-orders')">
                <span class="icon">ğŸ“‹</span> Orders
            </a>
            <a class="nav-item" data-route="admin-logs" onclick="navigate('admin-logs')">
                <span class="icon">ğŸ“</span> Audit Logs
            </a>
            <a class="nav-item" data-route="admin-users" onclick="navigate('admin-users')">
                <span class="icon">ğŸ‘¥</span> Users
            </a>
            <!-- Ops section -->
            <div class="nav-section-label">Ops</div>
            <a class="nav-item" data-route="ops-today" onclick="navigate('ops-today')">
                <span class="icon">ğŸ“…</span> Today
            </a>
            <a class="nav-item" data-route="ops-renewals" onclick="navigate('ops-renewals')">
                <span class="icon">ğŸ”„</span> Renewals
            </a>
        </div>
        <div class="sidebar-footer">
            <div class="user-badge">
                <div class="user-avatar" id="avatar-initials">A</div>
                <div class="user-info">
                    <div id="user-email-display">â€”</div>
                    <div class="user-role" id="user-role-display">â€”</div>
                </div>
            </div>
            <button class="logout-btn" onclick="doLogout()" style="margin-top:10px;">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main">
        <!-- Each page is a div; only one visible at a time -->

        <!-- â”€â”€â”€ ADMIN STOCK â”€â”€â”€ -->
        <div id="page-admin-stock" class="hidden">
            <div class="page-header"><h1>Stock Management</h1><p>Quáº£n lÃ½ kho TK/MK</p></div>
            <div class="content">
                <div class="input-row">
                    <div class="input-group" style="max-width:200px;">
                        <label>Filter Status</label>
                        <select id="stock-filter-status" onchange="loadStock()">
                            <option value="">All</option>
                            <option value="available">Available</option>
                            <option value="reserved">Reserved</option>
                            <option value="sold">Sold</option>
                            <option value="disabled">Disabled</option>
                            <option value="warranty_hold">Warranty Hold</option>
                        </select>
                    </div>
                    <div class="input-group" style="max-width:200px;">
                        <label>Product ID</label>
                        <input type="number" id="stock-filter-product" placeholder="e.g. 1" onchange="loadStock()">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="openAddStock()">+ Add Unit</button>
                    <button class="btn btn-ghost btn-sm" onclick="openBulkStock()">+ Bulk Import</button>
                </div>
                <div class="card">
                    <div id="stock-table-wrap"><div class="loading">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>

        <!-- â”€â”€â”€ ADMIN ORDERS â”€â”€â”€ -->
        <div id="page-admin-orders" class="hidden">
            <div class="page-header"><h1>Orders</h1><p>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</p></div>
            <div class="content">
                <div class="input-row">
                    <div class="input-group" style="max-width:200px;">
                        <label>Status</label>
                        <select id="order-filter-status" onchange="loadOrders()">
                            <option value="">All</option>
                            <option value="pending_payment">Pending</option>
                            <option value="fulfilled">Fulfilled</option>
                            <option value="expired">Expired</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Search</label>
                        <input type="text" id="order-search" placeholder="TBQ... or email" onkeyup="loadOrders()">
                    </div>
                </div>
                <div class="card">
                    <div id="orders-table-wrap"><div class="loading">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>

        <!-- â”€â”€â”€ ADMIN AUDIT LOGS â”€â”€â”€ -->
        <div id="page-admin-logs" class="hidden">
            <div class="page-header"><h1>Audit Logs</h1><p>ToÃ n bá»™ log há»‡ thá»‘ng</p></div>
            <div class="content">
                <div class="input-row">
                    <div class="input-group" style="max-width:220px;">
                        <label>Event Type</label>
                        <select id="log-filter-event" onchange="loadLogs()">
                            <option value="">All</option>
                            <option value="ORDER_CREATED">ORDER_CREATED</option>
                            <option value="PAYMENT_CONFIRMED">PAYMENT_CONFIRMED</option>
                            <option value="ORDER_FULFILLED">ORDER_FULFILLED</option>
                            <option value="ORDER_CANCELLED">ORDER_CANCELLED</option>
                            <option value="STOCK_ADDED">STOCK_ADDED</option>
                            <option value="STOCK_DISABLED">STOCK_DISABLED</option>
                            <option value="OPS_STEP_DONE">OPS_STEP_DONE</option>
                            <option value="OPS_RENEW">OPS_RENEW</option>
                            <option value="USER_LOGIN">USER_LOGIN</option>
                        </select>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="exportOrders()">â¬‡ Export CSV</button>
                </div>
                <div class="card">
                    <div id="logs-table-wrap"><div class="loading">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>

        <!-- â”€â”€â”€ ADMIN USERS â”€â”€â”€ -->
        <div id="page-admin-users" class="hidden">
            <div class="page-header"><h1>Users</h1><p>RBAC quáº£n lÃ½ tÃ i khoáº£n</p></div>
            <div class="content">
                <div style="margin-bottom:12px;"><button class="btn btn-primary btn-sm" onclick="openAddUser()">+ Add User</button></div>
                <div class="card">
                    <div id="users-table-wrap"><div class="loading">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>

        <!-- â”€â”€â”€ OPS TODAY â”€â”€â”€ -->
        <div id="page-ops-today" class="hidden">
            <div class="page-header"><h1>Today</h1><p>Workflow hÃ´m nay</p></div>
            <div class="content">
                <div class="stats-grid" id="ops-stats"></div>
                <div id="ops-sections"><div class="loading">Loadingâ€¦</div></div>
            </div>
        </div>

        <!-- â”€â”€â”€ OPS RENEWALS â”€â”€â”€ -->
        <div id="page-ops-renewals" class="hidden">
            <div class="page-header"><h1>Renewals</h1><p>Subscriptions sáº¯p háº¿t háº¡n</p></div>
            <div class="content">
                <div class="input-row">
                    <div class="input-group" style="max-width:120px;">
                        <label>Days</label>
                        <input type="number" id="renewal-days" value="7" min="1" max="90" onchange="loadRenewals()">
                    </div>
                </div>
                <div class="card">
                    <div id="renewals-table-wrap"><div class="loading">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ MODALS â”€â”€â”€ -->
<div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content"></div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€ -->
<div class="toast" id="toast"><span id="toast-msg"></span></div>

<!-- â”€â”€â”€ SCRIPT â”€â”€â”€ -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let TOKEN = null;
let ROLE  = null;
let EMAIL = null;
let currentRoute = null;

// Use clean /api base that Netlify redirects to functions
// (see admin-web/netlify.toml)
const API = '/api';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errEl = document.getElementById('login-error');
    errEl.style.display = 'none';

    if (!email || !password) { errEl.style.display = 'block'; errEl.textContent = 'Email and password required'; return; }

    try {
        const res = await fetch(`${API}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) { errEl.style.display = 'block'; errEl.textContent = data.error || 'Login failed'; return; }

        TOKEN = data.token;
        ROLE  = data.role;
        EMAIL = data.email;
        sessionStorage.setItem('tbq_admin_token', TOKEN);
        sessionStorage.setItem('tbq_admin_role', ROLE);
        sessionStorage.setItem('tbq_admin_email', EMAIL);

        showApp();
    } catch (e) {
        errEl.style.display = 'block'; errEl.textContent = 'Network error';
    }
}

function doLogout() {
    TOKEN = ROLE = EMAIL = null;
    sessionStorage.clear();
    document.getElementById('app-shell').classList.add('hidden');
    document.getElementById('login-page').classList.remove('hidden');
}

function showApp() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('app-shell').classList.remove('hidden');
    document.getElementById('user-email-display').textContent = EMAIL;
    document.getElementById('user-role-display').textContent = ROLE;
    document.getElementById('avatar-initials').textContent = EMAIL[0].toUpperCase();

    // Hide admin nav if not ADMIN
    if (ROLE !== 'ADMIN') {
        document.querySelectorAll('[data-route^="admin-"]').forEach(el => {
            if (el.dataset.route === 'admin-orders') return; // OPS can see orders
            el.style.display = 'none';
        });
    }

    navigate('ops-today'); // default page
}

// Restore session on load
window.addEventListener('DOMContentLoaded', () => {
    TOKEN = sessionStorage.getItem('tbq_admin_token');
    ROLE  = sessionStorage.getItem('tbq_admin_role');
    EMAIL = sessionStorage.getItem('tbq_admin_email');
    if (TOKEN && EMAIL) showApp();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(route) {
    // Hide all pages
    document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
    // Deactivate nav
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    // Show target
    const page = document.getElementById('page-' + route);
    if (page) page.classList.remove('hidden');

    // Activate nav
    const nav = document.querySelector(`[data-route="${route}"]`);
    if (nav) nav.classList.add('active');

    currentRoute = route;

    // Load data for route
    switch (route) {
        case 'admin-stock':    loadStock();    break;
        case 'admin-orders':   loadOrders();   break;
        case 'admin-logs':     loadLogs();     break;
        case 'admin-users':    loadUsers();    break;
        case 'ops-today':      loadOpsToday(); break;
        case 'ops-renewals':   loadRenewals(); break;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiGet(url) {
    const res = await fetch(url, { headers: { Authorization: `Bearer ${TOKEN}` } });
    if (res.status === 401) { doLogout(); return null; }
    return res.json();
}

async function apiPost(url, body) {
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${TOKEN}` },
        body: JSON.stringify(body)
    });
    if (res.status === 401) { doLogout(); return null; }
    return { ok: res.ok, status: res.status, data: await res.json() };
}

async function apiPatch(url, body) {
    const res = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${TOKEN}` },
        body: JSON.stringify(body)
    });
    if (res.status === 401) { doLogout(); return null; }
    return { ok: res.ok, status: res.status, data: await res.json() };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStock() {
    const status = document.getElementById('stock-filter-status').value;
    const productId = document.getElementById('stock-filter-product').value;
    let url = `${API}/admin/stock?limit=100`;
    if (status)    url += `&status=${status}`;
    if (productId) url += `&product_id=${productId}`;

    const data = await apiGet(url);
    if (!data) return;

    const wrap = document.getElementById('stock-table-wrap');
    if (!data.data || !data.data.length) { wrap.innerHTML = '<div class="loading">No stock units found.</div>'; return; }

    wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <span class="text-muted" style="font-size:13px;">Total: ${data.total}</span>
        </div>
        <table>
            <thead><tr><th>ID</th><th>Product</th><th>Username</th><th>Status</th><th>Sold At</th><th>Actions</th></tr></thead>
            <tbody>${data.data.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.product_name || u.product_code || u.product_id}</td>
                    <td>${u.username}</td>
                    <td>${badgeForStockStatus(u.status)}</td>
                    <td class="text-muted">${u.sold_at || 'â€”'}</td>
                    <td>
                        ${u.status !== 'sold' ? `
                            <button class="btn btn-ghost btn-sm" onclick="patchStockStatus(${u.id}, '${u.status === 'disabled' ? 'available' : 'disabled'}')">
                                ${u.status === 'disabled' ? 'Enable' : 'Disable'}
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('')}</tbody>
        </table>`;
}

async function patchStockStatus(id, newStatus) {
    const res = await apiPatch(`${API}/admin/stock/${id}`, { status: newStatus });
    if (res && res.ok) { toast(`Stock ${id} â†’ ${newStatus}`); loadStock(); }
    else { toast(`Failed: ${res?.data?.error || 'unknown'}`, true); }
}

function openAddStock() {
    document.getElementById('modal-content').innerHTML = `
        <h2>Add Stock Unit</h2>
        <div class="input-group"><label>Product ID</label><input type="number" id="m-product-id" placeholder="e.g. 1"></div>
        <div class="input-group mt-8"><label>Username</label><input type="text" id="m-username"></div>
        <div class="input-group mt-8"><label>Password</label><input type="password" id="m-password"></div>
        <div class="input-group mt-8"><label>Extra Info (optional)</label><input type="text" id="m-extra"></div>
        <div class="input-group mt-8"><label>Cost Price (VND)</label><input type="number" id="m-cost" value="0"></div>
        <div class="modal-actions">
            <button class="btn btn-ghost btn-sm" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="submitAddStock()">Add</button>
        </div>`;
    openModal();
}

async function submitAddStock() {
    const res = await apiPost(`${API}/admin/stock`, {
        product_id: parseInt(document.getElementById('m-product-id').value),
        username:   document.getElementById('m-username').value,
        password:   document.getElementById('m-password').value,
        extra_info: document.getElementById('m-extra').value || null,
        cost_price: parseInt(document.getElementById('m-cost').value) || 0
    });
    if (res && res.ok) { toast('Stock unit added'); closeModal(); loadStock(); }
    else { toast(`Error: ${res?.data?.error || 'unknown'}`, true); }
}

function openBulkStock() {
    document.getElementById('modal-content').innerHTML = `
        <h2>Bulk Import Stock</h2>
        <div class="input-group"><label>Product ID</label><input type="number" id="m-bulk-product-id"></div>
        <div class="input-group mt-8">
            <label>Items (one per line: username|password)</label>
            <textarea id="m-bulk-items" style="height:140px; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:8px; font-family:monospace; font-size:13px; resize:vertical;" placeholder="user1@gmail.com|pass123&#10;user2@gmail.com|pass456"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost btn-sm" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="submitBulkStock()">Import</button>
        </div>`;
    openModal();
}

async function submitBulkStock() {
    const productId = parseInt(document.getElementById('m-bulk-product-id').value);
    const lines = document.getElementById('m-bulk-items').value.trim().split('\n').filter(l => l.trim());
    const items = lines.map(l => {
        const [username, password, ...rest] = l.split('|');
        return { username: username?.trim(), password: password?.trim(), extra_info: rest.join('|').trim() || null };
    });

    const res = await apiPost(`${API}/admin/stock/bulk`, { product_id: productId, items });
    if (res && res.ok) { toast(`Imported: ${res.data.added} units`); closeModal(); loadStock(); }
    else { toast(`Error: ${res?.data?.error || 'unknown'}`, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadOrders() {
    const status = document.getElementById('order-filter-status').value;
    const search = document.getElementById('order-search').value;
    let url = `${API}/admin/orders?limit=100`;
    if (status) url += `&status=${status}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;

    const data = await apiGet(url);
    if (!data) return;

    const wrap = document.getElementById('orders-table-wrap');
    if (!data.data || !data.data.length) { wrap.innerHTML = '<div class="loading">No orders found.</div>'; return; }

    wrap.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
            <span class="text-muted" style="font-size:13px;">Total: ${data.total}</span>
        </div>
        <table>
            <thead><tr><th>Order Code</th><th>Customer</th><th>Status</th><th>Amount</th><th>Invoice</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>${data.data.map(o => `
                <tr>
                    <td><code>${o.order_code}</code></td>
                    <td>${o.customer_name || o.customer_email}</td>
                    <td>${badgeForOrderStatus(o.status)}</td>
                    <td>${o.amount_total?.toLocaleString()} VND</td>
                    <td class="text-muted">${o.invoice_number || 'â€”'}</td>
                    <td class="text-muted">${o.created_at?.slice(0,16) || 'â€”'}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="viewOrderDetail('${o.order_code}')">Detail</button>
                        ${o.status === 'pending_payment' ? `<button class="btn btn-danger btn-sm" onclick="cancelOrder('${o.order_code}')">Cancel</button>` : ''}
                    </td>
                </tr>
            `).join('')}</tbody>
        </table>`;
}

async function viewOrderDetail(orderCode) {
    const data = await apiGet(`${API}/admin/orders/${orderCode}`);
    if (!data) return;

    const { order, lines, allocations, payment, invoice, audit } = data;
    document.getElementById('modal-content').innerHTML = `
        <h2>Order: ${order.order_code}</h2>
        <p class="text-muted" style="margin-bottom:16px;">${order.customer_name} â€” ${order.customer_email} â€” ${order.customer_phone || 'â€”'}</p>
        <div style="display:flex;gap:10px;margin-bottom:16px;">
            ${badgeForOrderStatus(order.status)}
            <span class="text-muted" style="font-size:13px;">${order.amount_total?.toLocaleString()} VND</span>
        </div>

        <strong style="font-size:13px;">Lines</strong>
        <table style="margin:8px 0 16px;">
            <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead>
            <tbody>${(lines||[]).map(l => `<tr><td>${l.product_name}</td><td>${l.quantity}</td><td>${l.unit_price?.toLocaleString()}</td><td>${l.subtotal?.toLocaleString()}</td></tr>`).join('')}</tbody>
        </table>

        <strong style="font-size:13px;">Allocations</strong>
        <table style="margin:8px 0 16px;">
            <thead><tr><th>Unit ID</th><th>Username</th><th>Alloc Status</th><th>Unit Status</th></tr></thead>
            <tbody>${(allocations||[]).map(a => `<tr><td>${a.unit_id}</td><td>${a.username}</td><td>${badgeForAllocStatus(a.status)}</td><td>${badgeForStockStatus(a.unit_status)}</td></tr>`).join('')}</tbody>
        </table>

        ${payment ? `<strong style="font-size:13px;">Payment</strong><p style="font-size:13px;margin:4px 0 16px;">${badgeForPaymentStatus(payment.status)} â€” Txn: ${payment.transaction_id || 'â€”'}</p>` : ''}
        ${invoice ? `<strong style="font-size:13px;">Invoice</strong><p style="font-size:13px;margin:4px 0 16px;">${invoice.invoice_number}</p>` : ''}

        <strong style="font-size:13px;">Audit Trail</strong>
        <div style="margin-top:8px; max-height:120px; overflow-y:auto;">
            ${(audit||[]).map(a => `<div style="font-size:12px;color:var(--text-muted);padding:4px 0;border-bottom:1px solid var(--border);">${a.created_at?.slice(0,16)} â€” <strong>${a.event_type}</strong> by ${a.actor}</div>`).join('')}
        </div>
        <div class="modal-actions"><button class="btn btn-ghost btn-sm" onclick="closeModal()">Close</button></div>`;
    openModal();
}

async function cancelOrder(orderCode) {
    if (!confirm(`Cancel order ${orderCode}?`)) return;
    const res = await apiPost(`${API}/admin/orders/${orderCode}/cancel`, { reason: 'Manual cancel via admin' });
    if (res && res.ok) { toast('Order cancelled'); closeModal(); loadOrders(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIT LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLogs() {
    const eventType = document.getElementById('log-filter-event').value;
    let url = `${API}/admin/audit-logs?limit=100`;
    if (eventType) url += `&event_type=${eventType}`;

    const data = await apiGet(url);
    if (!data) return;

    const wrap = document.getElementById('logs-table-wrap');
    if (!data.data || !data.data.length) { wrap.innerHTML = '<div class="loading">No logs.</div>'; return; }

    wrap.innerHTML = `
        <div style="margin-bottom:12px;"><span class="text-muted" style="font-size:13px;">Total: ${data.total}</span></div>
        <table>
            <thead><tr><th>Time</th><th>Event</th><th>Entity</th><th>ID</th><th>Actor</th><th>Source</th><th>Payload</th></tr></thead>
            <tbody>${data.data.map(l => `
                <tr>
                    <td class="text-muted">${l.created_at?.slice(0,16)}</td>
                    <td><strong>${l.event_type}</strong></td>
                    <td>${l.entity_type}</td>
                    <td>${l.entity_id || 'â€”'}</td>
                    <td>${l.actor}</td>
                    <td class="text-muted">${l.source}</td>
                    <td><code style="font-size:11px;color:var(--text-muted);">${(l.payload||'').slice(0,80)}</code></td>
                </tr>
            `).join('')}</tbody>
        </table>`;
}

async function exportOrders() {
    // Quick export: last 30 days
    const to = new Date().toISOString().slice(0,10);
    const from = new Date(Date.now() - 30*86400000).toISOString().slice(0,10);
    const res = await fetch(`${API}/admin/export/orders?from=${from}&to=${to}&format=csv`, {
        headers: { Authorization: `Bearer ${TOKEN}` }
    });
    if (res.ok) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `tbq-orders-${from}-to-${to}.csv`; a.click();
        URL.revokeObjectURL(url);
        toast('CSV exported');
    } else { toast('Export failed', true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsers() {
    const data = await apiGet(`${API}/admin/users`);
    if (!data) return;

    const wrap = document.getElementById('users-table-wrap');
    wrap.innerHTML = `
        <table>
            <thead><tr><th>Email</th><th>Role</th><th>Active</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody>${(data.data||[]).map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td>${badgeForRole(u.role)}</td>
                    <td>${u.is_active ? 'âœ“' : 'âœ—'}</td>
                    <td class="text-muted">${u.created_at?.slice(0,10)}</td>
                    <td>
                        <select onchange="updateUserRole(${u.id}, this.value)" style="width:auto;padding:4px 8px;font-size:12px;">
                            ${['ADMIN','OPS','ACCOUNTANT'].map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
                        </select>
                        <button class="btn btn-ghost btn-sm" onclick="toggleUserActive(${u.id}, ${u.is_active ? 0 : 1})">${u.is_active ? 'Deactivate' : 'Activate'}</button>
                    </td>
                </tr>
            `).join('')}</tbody>
        </table>`;
}

async function updateUserRole(id, role) {
    const res = await apiPatch(`${API}/admin/users/${id}`, { role });
    if (res && res.ok) { toast(`User ${id} role â†’ ${role}`); loadUsers(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

async function toggleUserActive(id, isActive) {
    const res = await apiPatch(`${API}/admin/users/${id}`, { is_active: isActive });
    if (res && res.ok) { toast(`User ${id} ${isActive ? 'activated' : 'deactivated'}`); loadUsers(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

function openAddUser() {
    document.getElementById('modal-content').innerHTML = `
        <h2>Add User</h2>
        <div class="input-group"><label>Email</label><input type="email" id="m-user-email"></div>
        <div class="input-group mt-8"><label>Password (min 8 chars)</label><input type="password" id="m-user-password"></div>
        <div class="input-group mt-8">
            <label>Role</label>
            <select id="m-user-role"><option value="OPS">OPS</option><option value="ADMIN">ADMIN</option><option value="ACCOUNTANT">ACCOUNTANT</option></select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost btn-sm" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="submitAddUser()">Create</button>
        </div>`;
    openModal();
}

async function submitAddUser() {
    const res = await apiPost(`${API}/admin/users`, {
        email: document.getElementById('m-user-email').value,
        password: document.getElementById('m-user-password').value,
        role: document.getElementById('m-user-role').value
    });
    if (res && res.ok) { toast('User created'); closeModal(); loadUsers(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPS TODAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadOpsToday() {
    const data = await apiGet(`${API}/ops/today`);
    if (!data) return;

    const { stats, needs_reminder, overdue, awaiting_payment, completed_today } = data;

    document.getElementById('ops-stats').innerHTML = `
        <div class="stat-card"><div class="stat-label">Needs Reminder</div><div class="stat-value" style="color:var(--yellow);">${stats.needs_reminder_count}</div></div>
        <div class="stat-card"><div class="stat-label">Overdue</div><div class="stat-value" style="color:var(--red);">${stats.overdue_count}</div></div>
        <div class="stat-card"><div class="stat-label">Awaiting Payment</div><div class="stat-value" style="color:var(--blue);">${stats.awaiting_count}</div></div>
        <div class="stat-card"><div class="stat-label">Completed Today</div><div class="stat-value" style="color:var(--green);">${stats.completed_count}</div></div>
        <div class="stat-card"><div class="stat-label">Revenue Today</div><div class="stat-value" style="color:var(--green);">${(stats.revenue_today||0).toLocaleString()}</div></div>`;

    const renderBucket = (title, color, items, actions) => {
        if (!items.length) return '';
        return `
            <div class="ops-section">
                <div class="ops-section-title" style="color:${color};">${title} (${items.length})</div>
                ${items.map(s => `
                    <div class="ops-item">
                        <div class="ops-item-left">
                            <div class="ops-item-name">${s.customer_name || 'Unknown'} â€” ${s.service}</div>
                            <div class="ops-item-meta">ID: ${s.id} | End: ${s.end_date} | Contact: ${s.customer_contact || 'â€”'} (${s.customer_source || 'â€”'}) | Contacted: ${s.contact_count || 0}x</div>
                        </div>
                        <div class="ops-item-actions">${actions(s)}</div>
                    </div>
                `).join('')}
            </div>`;
    };

    document.getElementById('ops-sections').innerHTML =
        renderBucket('Cáº§n nháº¯c láº¡i', 'var(--yellow)', needs_reminder, s => `
            <button class="btn btn-primary btn-sm" onclick="opsStep(${s.id},'contacted')">ÄÃ£ nháº¯n</button>
            <button class="btn btn-ghost btn-sm" onclick="opsStep(${s.id},'closed')">ÄÃ³ng</button>
        `) +
        renderBucket('QuÃ¡ háº¡n', 'var(--red)', overdue, s => `
            <button class="btn btn-primary btn-sm" onclick="opsStep(${s.id},'contacted')">ÄÃ£ nháº¯n</button>
            <button class="btn btn-ghost btn-sm" onclick="opsStep(${s.id},'closed')">ÄÃ³ng</button>
        `) +
        renderBucket('Chá» thanh toÃ¡n', 'var(--blue)', awaiting_payment, s => `
            <button class="btn btn-primary btn-sm" onclick="opsStep(${s.id},'paid')">ÄÃ£ thanh toÃ¡n</button>
            <button class="btn btn-ghost btn-sm" onclick="openOpsRenew(${s.id})">Gia háº¡n</button>
        `) +
        renderBucket('HoÃ n thÃ nh hÃ´m nay', 'var(--green)', completed_today, s => `
            <span class="badge badge-green">Done</span>
        `) ||
        '<div class="loading">KhÃ´ng cÃ³ viá»‡c nÃ o hÃ´m nay.</div>';
}

async function opsStep(subId, step, note) {
    const res = await apiPost(`${API}/ops/step/${subId}`, { step, note: note || null });
    if (res && res.ok) { toast(`Step: ${step}`); loadOpsToday(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

function openOpsRenew(subId) {
    // Default dates: today + 1 month
    const today = new Date();
    const nextMonth = new Date(today);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    const fmt = d => d.toISOString().slice(0,10);

    document.getElementById('modal-content').innerHTML = `
        <h2>Gia háº¡n Subscription ${subId}</h2>
        <div class="input-group"><label>Start Date</label><input type="date" id="m-renew-start" value="${fmt(today)}"></div>
        <div class="input-group mt-8"><label>End Date</label><input type="date" id="m-renew-end" value="${fmt(nextMonth)}"></div>
        <div class="input-group mt-8"><label>Price (VND, optional)</label><input type="number" id="m-renew-price" placeholder="giá»¯ giÃ¡ cÅ©"></div>
        <div class="input-group mt-8"><label>Stock Unit ID (optional)</label><input type="number" id="m-renew-stock" placeholder="Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng cáº§n"></div>
        <div class="modal-actions">
            <button class="btn btn-ghost btn-sm" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="submitRenew(${subId})">Gia háº¡n</button>
        </div>`;
    openModal();
}

async function submitRenew(subId) {
    const body = {
        new_start_date: document.getElementById('m-renew-start').value,
        new_end_date:   document.getElementById('m-renew-end').value
    };
    const price = document.getElementById('m-renew-price').value;
    const stock = document.getElementById('m-renew-stock').value;
    if (price) body.price = parseInt(price);
    if (stock) body.stock_unit_id = parseInt(stock);

    const res = await apiPost(`${API}/ops/renew/${subId}`, body);
    if (res && res.ok) { toast('Gia háº¡n thÃ nh cÃ´ng'); closeModal(); loadOpsToday(); }
    else { toast(`Error: ${res?.data?.error}`, true); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPS RENEWALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRenewals() {
    const days = document.getElementById('renewal-days').value || 7;
    const data = await apiGet(`${API}/ops/renewals?days=${days}`);
    if (!data) return;

    const wrap = document.getElementById('renewals-table-wrap');
    if (!data.data || !data.data.length) { wrap.innerHTML = '<div class="loading">None expiring in this window.</div>'; return; }

    wrap.innerHTML = `
        <table>
            <thead><tr><th>Customer</th><th>Service</th><th>End Date</th><th>Days Left</th><th>Contact</th><th>Actions</th></tr></thead>
            <tbody>${data.data.map(s => `
                <tr>
                    <td>${s.customer_name}</td>
                    <td>${s.service}</td>
                    <td>${s.end_date}</td>
                    <td style="color:${s.days_left<=1?'var(--red)':s.days_left<=3?'var(--yellow)':'var(--green)'}; font-weight:600;">${Math.round(s.days_left)}</td>
                    <td class="text-muted">${s.customer_contact || 'â€”'} (${s.customer_source || 'â€”'})</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="opsStep(${s.id},'contacted')">Nháº¯n</button>
                        <button class="btn btn-ghost btn-sm" onclick="openOpsRenew(${s.id})">Gia háº¡n</button>
                    </td>
                </tr>
            `).join('')}</tbody>
        </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL + TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal() { document.getElementById('modal-overlay').classList.add('open'); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

function toast(msg, isError = false) {
    const el = document.getElementById('toast');
    document.getElementById('toast-msg').textContent = msg;
    el.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => el.classList.remove('show'), 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BADGE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function badgeForStockStatus(s) {
    const map = { available:'badge-green', reserved:'badge-yellow', sold:'badge-muted', disabled:'badge-red', warranty_hold:'badge-blue' };
    return `<span class="badge ${map[s]||'badge-muted'}">${s}</span>`;
}
function badgeForOrderStatus(s) {
    const map = { pending_payment:'badge-yellow', fulfilled:'badge-green', expired:'badge-muted', cancelled:'badge-red', refunded:'badge-blue' };
    return `<span class="badge ${map[s]||'badge-muted'}">${s}</span>`;
}
function badgeForAllocStatus(s) {
    const map = { reserved:'badge-yellow', sold:'badge-green', released:'badge-muted', replaced:'badge-blue' };
    return `<span class="badge ${map[s]||'badge-muted'}">${s}</span>`;
}
function badgeForPaymentStatus(s) {
    const map = { initiated:'badge-yellow', confirmed:'badge-green', failed:'badge-red', refunded:'badge-blue' };
    return `<span class="badge ${map[s]||'badge-muted'}">${s}</span>`;
}
function badgeForRole(r) {
    const map = { ADMIN:'badge-red', OPS:'badge-blue', ACCOUNTANT:'badge-green' };
    return `<span class="badge ${map[r]||'badge-muted'}">${r}</span>`;
}
</script>
</body>
</html>
