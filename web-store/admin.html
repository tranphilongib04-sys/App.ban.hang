<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBQ Admin â€“ Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€â”€â”€ Admin Ä‘á»“ng bá»™ phong cÃ¡ch web bÃ¡n hÃ ng TBQ Homie â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f0f8ff;
  --bg-page:#f7f9fc;
  --surface:#ffffff;
  --surface2:#f9fafb;
  --border:#e5e7eb;
  --border-light:#f3f4f6;
  --text:#1f2937;
  --text2:#6b7280;
  --text-muted:#9ca3af;
  --accent:#2563eb;
  --accent-dim:rgba(37,99,235,0.1);
  --green:#10b981;
  --green-dim:#ecfdf5;
  --yellow:#f59e0b;
  --yellow-dim:#fffbeb;
  --red:#ef4444;
  --red-dim:#fef2f2;
  --purple:#8b5cf6;
  --purple-dim:#f5f3ff;
  --orange:#f97316;
  --orange-dim:#fff7ed;
  --radius:12px;
  --radius-sm:8px;
  --shadow-sm:0 1px 2px rgba(0,0,0,0.05);
  --shadow-md:0 4px 6px -1px rgba(0,0,0,0.07),0 2px 4px -1px rgba(0,0,0,0.04);
  --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.08),0 4px 6px -2px rgba(0,0,0,0.04);
  --font:'Be Vietnam Pro','Inter',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.6;-webkit-font-smoothing:antialiased}

/* â”€â”€â”€â”€â”€ layout â”€â”€â”€â”€â”€ */
.shell{display:flex;min-height:100vh}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);padding:24px 0;display:flex;flex-direction:column;flex-shrink:0;box-shadow:var(--shadow-sm)}
.sidebar-logo{padding:0 20px;margin-bottom:28px;font-size:20px;font-weight:700;color:var(--text);letter-spacing:-0.5px}
.sidebar-logo span{color:var(--text2);font-weight:500}
.nav-item{display:flex;align-items:center;gap:10px;padding:12px 20px;cursor:pointer;color:var(--text2);border-left:3px solid transparent;transition:.15s;font-size:14px}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{border-left-color:var(--accent);background:var(--accent-dim);color:var(--accent);font-weight:600}
.nav-icon{width:20px;text-align:center;font-size:16px}
.sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted)}

.main{flex:1;overflow-y:auto;padding:32px;background:var(--bg-page)}
.page{display:none}
.page.active{display:block}

/* â”€â”€â”€â”€â”€ header row â”€â”€â”€â”€â”€ */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:8px}
.page-header h1{font-size:22px;font-weight:700;letter-spacing:-.5px;color:var(--text)}
.page-header .header-right{display:flex;align-items:center;gap:10px}
.refresh-btn{background:var(--surface);border:1px solid var(--border);color:var(--text2);padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:13px;transition:.15s;box-shadow:var(--shadow-sm);font-family:inherit}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.refresh-btn:disabled{opacity:.7;cursor:not-allowed}
.inventory-status{font-size:13px;color:var(--text2);margin-right:12px}
.inventory-status.error{color:var(--red)}

/* â”€â”€â”€â”€â”€ stat cards â”€â”€â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;margin-bottom:28px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-md)}
.stat-card .label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px}
.stat-card .value{font-size:28px;font-weight:700;color:var(--text)}
.stat-card.green .value{color:var(--green)}
.stat-card.yellow .value{color:var(--yellow)}
.stat-card.red .value{color:var(--red)}
.stat-card.purple .value{color:var(--purple)}
.stat-card.blue .value{color:var(--accent)}

/* â”€â”€â”€â”€â”€ table â”€â”€â”€â”€â”€ */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-md)}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:14px 18px;font-size:11px;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);font-weight:600;white-space:nowrap;background:var(--surface2)}
td{padding:12px 18px;border-bottom:1px solid var(--border-light);white-space:nowrap;color:var(--text)}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--surface2)}

/* â”€â”€â”€â”€â”€ badges â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap}
.badge-pending{background:var(--yellow-dim);color:#b45309}
.badge-paid{background:var(--accent-dim);color:var(--accent)}
.badge-fulfilled{background:var(--green-dim);color:#047857}
.badge-failed,.badge-cancelled,.badge-expired{background:var(--red-dim);color:var(--red)}
.badge-refunded{background:var(--purple-dim);color:var(--purple)}

/* â”€â”€â”€â”€â”€ filter bar â”€â”€â”€â”€â”€ */
.filter-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:var(--radius-sm);font-size:13px;font-family:inherit}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}

/* â”€â”€â”€â”€â”€ Order management â”€â”€â”€â”€â”€ */
.order-management .order-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.order-management .order-stats-row .stat-card{margin-bottom:0}
.order-management .order-toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px}
.order-management .order-toolbar .search-wrap{flex:1;min-width:200px}
.order-management .order-toolbar .search-wrap input{width:100%;padding:8px 12px 8px 36px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:inherit}
.order-management .order-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border)}
.order-management .order-tab{padding:10px 16px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text2);border:none;background:transparent;border-bottom:2px solid transparent;margin-bottom:-1px;border-radius:var(--radius-sm) var(--radius-sm) 0 0;font-family:inherit}
.order-management .order-tab:hover{color:var(--text);background:var(--surface2)}
.order-management .order-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--accent-dim)}
.order-management .order-table-wrap{overflow-x:auto}
.order-management .order-table-wrap table{font-size:13px}
.order-management .order-table-wrap th,.order-management .order-table-wrap td{padding:12px 14px}
.order-management .order-table-wrap .col-code{font-weight:600;color:var(--accent)}
.order-management .order-table-wrap .col-actions{white-space:nowrap}
.order-management .order-table-wrap .btn-link{padding:4px 10px;border-radius:6px;font-size:12px;background:var(--surface2);color:var(--accent);border:1px solid var(--border);cursor:pointer;text-decoration:none;display:inline-block;font-family:inherit}
.order-management .order-table-wrap .btn-link:hover{background:var(--accent-dim)}

/* â”€â”€â”€â”€â”€ Order credential detail panel â”€â”€â”€â”€â”€ */
.order-detail-row td{padding:0!important;background:var(--surface2)!important}
.order-detail-panel{padding:16px 20px;border-top:1px solid var(--border)}
.cred-cards{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.cred-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;min-width:280px;flex:1;max-width:420px}
.cred-card .cred-sku{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:8px;font-weight:600}
.cred-field{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:13px}
.cred-field .cred-label{color:var(--text2);min-width:32px;font-weight:600;font-size:12px}
.cred-field .cred-value{flex:1;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:13px;word-break:break-all;color:var(--text)}
.cred-field .cred-value.blurred{filter:blur(5px);user-select:none;cursor:pointer}
.cred-field .cred-btn{padding:3px 8px;border:1px solid var(--border);border-radius:6px;background:var(--surface2);cursor:pointer;font-size:11px;color:var(--text2);transition:.15s;flex-shrink:0}
.cred-field .cred-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.cred-loading{color:var(--text2);font-size:13px;padding:8px 0}
.cred-empty{color:var(--text-muted);font-size:13px;font-style:italic;padding:8px 0}

/* â”€â”€â”€â”€â”€ login overlay â”€â”€â”€â”€â”€ */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:380px;text-align:center;box-shadow:var(--shadow-lg)}
.login-box h2{margin-bottom:8px;font-size:20px;color:var(--text)}
.login-box p{color:var(--text2);margin-bottom:24px;font-size:14px}
.login-box input{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:15px;margin-bottom:16px;font-family:inherit}
.login-box input:focus{outline:none;border-color:var(--accent)}
.login-box button{width:100%;padding:12px;background:#000;border:none;border-radius:var(--radius);color:#fff;font-size:15px;font-weight:600;cursor:pointer;transition:opacity .2s;font-family:inherit}
.login-box button:hover{opacity:.9}
.login-err{color:var(--red);font-size:13px;margin-top:12px;min-height:18px}

/* â”€â”€â”€â”€â”€ empty / loading â”€â”€â”€â”€â”€ */
.empty{color:var(--text2);text-align:center;padding:48px 0;font-size:15px}
.loading{color:var(--text2);padding:24px 0;text-align:center;font-size:14px}

/* â”€â”€â”€â”€â”€ SKU Card Grid (nháº­p kho nhanh) â”€â”€â”€â”€â”€ */
.sku-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.sku-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:all .2s;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.sku-card:hover{border-color:var(--accent);box-shadow:var(--shadow-md);transform:translateY(-2px)}
.sku-card:active{transform:translateY(0)}
.sku-card.in-stock{border-color:var(--green)}
.sku-card.low-stock{border-color:var(--orange)}
.sku-card.out-of-stock{border-color:var(--red);opacity:.85}
.sku-card .sku-icon{font-size:32px;margin-bottom:10px;line-height:1}
.sku-card .sku-name{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px;line-height:1.3}
.sku-card .sku-code{font-size:11px;color:var(--text-muted);font-family:monospace;margin-bottom:12px}
.sku-card .sku-stock{display:flex;align-items:center;gap:8px}
.sku-card .sku-stock-count{font-size:24px;font-weight:700}
.sku-card.in-stock .sku-stock-count{color:var(--green)}
.sku-card.low-stock .sku-stock-count{color:var(--orange)}
.sku-card.out-of-stock .sku-stock-count{color:var(--red)}
.sku-card .sku-stock-label{font-size:12px;color:var(--text2)}
.sku-card .sku-import-hint{position:absolute;bottom:0;left:0;right:0;background:var(--accent);color:#fff;text-align:center;padding:6px;font-size:12px;font-weight:600;transform:translateY(100%);transition:transform .2s}
.sku-card:hover .sku-import-hint{transform:translateY(0)}

/* â”€â”€â”€â”€â”€ Nháº­p kho nÃ¢ng cao (collapsible) â”€â”€â”€â”€â”€ */
.advanced-import{margin-bottom:24px}
.advanced-toggle{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--text2);transition:.15s;width:100%}
.advanced-toggle:hover{border-color:var(--accent);color:var(--accent)}
.advanced-toggle .toggle-arrow{transition:transform .2s;font-size:10px}
.advanced-toggle.open .toggle-arrow{transform:rotate(90deg)}
.advanced-content{display:none;margin-top:8px}
.advanced-content.show{display:block}

.quick-import-super{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow-md)}
.quick-import-super h3{margin-bottom:8px;font-size:16px;color:var(--text)}
.quick-import-super .paste-area{width:100%;min-height:140px;padding:12px;font-family:monospace;font-size:13px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);color:var(--text);resize:vertical;margin-bottom:12px}
.quick-import-super .tool-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
.quick-import-super .tool-row select{padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:inherit}
.quick-import-super .preview-wrap{overflow-x:auto;margin-bottom:12px;max-height:320px;overflow-y:auto}
.quick-import-super .preview-table{font-size:12px}
.quick-import-super .preview-table th,.quick-import-super .preview-table td{padding:8px 10px;white-space:nowrap}
.quick-import-super .preview-table .col-account{max-width:180px;overflow:hidden;text-overflow:ellipsis}
.quick-import-super .preview-table .col-secret{font-family:monospace;color:var(--text2)}.quick-import-super .preview-table .col-secret.masked{filter:blur(4px);user-select:none}
.quick-import-super .preview-table .cell-copy{cursor:pointer;opacity:.7}
.quick-import-super .row-status-valid{color:var(--green)}
.quick-import-super .row-status-error{color:var(--red)}
.quick-import-super .confidence-bar{display:inline-block;height:6px;border-radius:3px;background:var(--border);min-width:40px;vertical-align:middle}
.quick-import-super .confidence-bar span{display:block;height:100%;border-radius:3px;background:var(--green)}
.quick-import-super .sku-panel{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm)}
.quick-import-super .import-result{margin-top:12px;padding:12px;border-radius:var(--radius-sm);font-size:13px}

/* â”€â”€â”€â”€â”€ Modal â”€â”€â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-box h4{margin-bottom:16px;font-size:16px;color:var(--text)}
.modal-box label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px}
.modal-box input,.modal-box textarea{width:100%;padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;margin-bottom:12px;font-family:inherit}
.modal-box input:focus,.modal-box textarea:focus{outline:none;border-color:var(--accent)}
.modal-box textarea{min-height:60px;resize:vertical}
.modal-box .modal-actions{display:flex;gap:10px;margin-top:16px}
.modal-box .modal-actions button{padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:13px;border:none;font-family:inherit}
.modal-box .modal-actions .btn-primary{background:#000;color:#fff}
.modal-box .modal-actions .btn-primary:hover{opacity:.9}
.modal-box .modal-actions .btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}

/* â”€â”€â”€â”€â”€ Paste import modal â”€â”€â”€â”€â”€ */
.paste-import-box .paste-import-hint{font-size:12px;color:var(--text2);margin-bottom:10px}
.paste-import-box .paste-import-hint code{background:var(--surface2);padding:2px 6px;border-radius:4px;font-size:11px;border:1px solid var(--border)}
.paste-import-box #pasteImportText{min-height:140px;font-family:monospace;font-size:13px}
.paste-import-box .paste-preview{margin-top:8px;font-size:12px;color:var(--text2)}
.paste-import-box .paste-preview .preview-line{display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--border-light)}
.paste-import-box .paste-preview .preview-line .pv-account{font-weight:600;color:var(--text);min-width:160px}
.paste-import-box .paste-preview .preview-line .pv-pass{font-family:monospace;color:var(--text2)}
.paste-import-box .paste-preview .preview-line .pv-2fa{font-family:monospace;color:var(--accent)}

/* â”€â”€â”€â”€â”€ Toast â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:24px;right:24px;background:#1f2937;color:#fff;padding:12px 20px;border-radius:var(--radius);font-size:14px;font-weight:500;z-index:2000;transform:translateY(100px);opacity:0;transition:all .3s;box-shadow:var(--shadow-lg)}
.toast.show{transform:translateY(0);opacity:1}

/* â”€â”€â”€â”€â”€ responsive â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .shell{flex-direction:column}
  .sidebar{flex-direction:row;width:100%;padding:12px 16px;gap:8px;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border)}
  .sidebar-logo{margin-bottom:0;margin-right:12px;font-size:16px}
  .nav-item{padding:8px 12px;border-left:none;border-bottom:2px solid transparent;white-space:nowrap}
  .nav-item.active{border-left-color:transparent;border-bottom-color:var(--accent)}
  .sidebar-footer{display:none}
  .main{padding:16px}
  .sku-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
  .sku-card{padding:14px}
  .sku-card .sku-icon{font-size:24px}
  .order-management .order-stats-row{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>TBQ Admin</h2>
    <p>Nháº­p Admin Token Ä‘á»ƒ Ä‘Äƒng nháº­p</p>
    <input type="password" id="tokenInput" placeholder="Admin token..." onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">ÄÄƒng nháº­p</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- â”€â”€ SHELL â”€â”€ -->
<div class="shell" id="shell" style="display:none">

  <!-- sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">TBQ<span>Admin</span></div>
    <div class="nav-item active" onclick="nav('dashboard')"><span class="nav-icon">ğŸ“Š</span> Tá»•ng quan</div>
    <div class="nav-item" onclick="nav('orders')"><span class="nav-icon">ğŸ“¦</span> ÄÆ¡n hÃ ng</div>
    <div class="nav-item" onclick="nav('inventory')"><span class="nav-icon">ğŸ“‹</span> Kho hÃ ng</div>
    <div class="nav-item" onclick="nav('logs')"><span class="nav-icon">ğŸ“</span> Nháº­t kÃ½</div>
    <div class="sidebar-footer">Äá»“ng bá»™: <span id="lastSync">--</span></div>
  </aside>

  <!-- main -->
  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <h1>Tá»•ng quan</h1>
        <button class="refresh-btn" onclick="loadDashboard()">LÃ m má»›i</button>
      </div>
      <div class="stats-row" id="statsRow">
        <div class="stat-card blue"><div class="label">Tá»•ng Ä‘Æ¡n</div><div class="value" id="statTotal">--</div></div>
        <div class="stat-card yellow"><div class="label">Chá» thanh toÃ¡n</div><div class="value" id="statPending">--</div></div>
        <div class="stat-card green"><div class="label">ÄÃ£ giao</div><div class="value" id="statFulfilled">--</div></div>
        <div class="stat-card purple"><div class="label">Doanh thu</div><div class="value" id="statRevenue">--</div></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>MÃ£ Ä‘Æ¡n</th><th>KhÃ¡ch</th><th>Sá»‘ tiá»n</th><th>Tráº¡ng thÃ¡i</th><th>Thá»i gian</th>
          </tr></thead>
          <tbody id="dashboardOrders"><tr><td colspan="5" class="loading">Äang táº£i...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="page order-management" id="page-orders">
      <div class="page-header">
        <div>
          <h1>ÄÆ¡n hÃ ng</h1>
          <p style="color:var(--text2);font-size:13px;margin-top:4px">Báº¥m vÃ o Ä‘Æ¡n Ä‘á»ƒ xem tk|mk|2fa</p>
        </div>
      </div>
      <div class="order-stats-row">
        <div class="stat-card blue"><div class="label">Tá»•ng cá»™ng</div><div class="value" id="orderStatTotal">--</div></div>
        <div class="stat-card yellow"><div class="label">Chá» thanh toÃ¡n</div><div class="value" id="orderStatPending">--</div></div>
        <div class="stat-card green"><div class="label">ÄÃ£ giao</div><div class="value" id="orderStatDelivered">--</div></div>
        <div class="stat-card red"><div class="label">Lá»—i / Huá»·</div><div class="value" id="orderStatError">--</div></div>
      </div>
      <div class="order-toolbar">
        <div class="search-wrap" style="position:relative">
          <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:14px;">ğŸ”</span>
          <input type="text" id="orderSearch" placeholder="TÃ¬m mÃ£ Ä‘Æ¡n, email..." oninput="loadOrders()">
        </div>
        <select id="orderStatusFilter" onchange="setOrderTabFromFilter();loadOrders()">
          <option value="">Táº¥t cáº£ tráº¡ng thÃ¡i</option>
          <option value="pending_payment">Chá» thanh toÃ¡n</option>
          <option value="paid">ÄÃ£ thanh toÃ¡n</option>
          <option value="fulfilled">ÄÃ£ giao</option>
          <option value="failed">Lá»—i</option>
          <option value="cancelled">Huá»·</option>
          <option value="refunded">HoÃ n tiá»n</option>
          <option value="expired">Háº¿t háº¡n</option>
        </select>
        <button class="refresh-btn" onclick="loadOrders()">LÃ m má»›i</button>
      </div>
      <div class="order-tabs">
        <button type="button" class="order-tab active" data-status="" onclick="setOrderTab('')">Táº¥t cáº£</button>
        <button type="button" class="order-tab" data-status="pending_payment" onclick="setOrderTab('pending_payment')">Chá» TT</button>
        <button type="button" class="order-tab" data-status="paid" onclick="setOrderTab('paid')">ÄÃ£ TT</button>
        <button type="button" class="order-tab" data-status="fulfilled" onclick="setOrderTab('fulfilled')">ÄÃ£ giao</button>
        <button type="button" class="order-tab" data-status="failed" onclick="setOrderTab('failed')">Lá»—i / Huá»·</button>
      </div>
      <div class="order-table-wrap table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>MÃ£ Ä‘Æ¡n</th><th>KhÃ¡ch</th><th>Email</th><th>Sáº£n pháº©m</th><th>Sá»‘ tiá»n</th><th>Tráº¡ng thÃ¡i</th><th>NgÃ y táº¡o</th><th>Thao tÃ¡c</th>
          </tr></thead>
          <tbody id="ordersBody"><tr><td colspan="9" class="loading">Äang táº£i...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <div>
          <h1>Kho hÃ ng</h1>
          <p style="color:var(--text2);font-size:13px;margin-top:4px">Báº¥m vÃ o sáº£n pháº©m Ä‘á»ƒ nháº­p tk|mk|2fa</p>
        </div>
        <div class="header-right">
          <span id="inventoryStatus" class="inventory-status"></span>
          <button class="refresh-btn" id="inventoryRefreshBtn" onclick="loadInventory()">LÃ m má»›i</button>
        </div>
      </div>

      <!-- SKU Card Grid -->
      <div class="sku-grid" id="skuGrid">
        <div class="loading" style="grid-column:1/-1">Äang táº£i...</div>
      </div>

      <!-- Advanced import (collapsed) -->
      <div class="advanced-import">
        <button class="advanced-toggle" id="advancedToggle" onclick="toggleAdvancedImport()">
          <span class="toggle-arrow">&#9654;</span>
          Nháº­p nÃ¢ng cao (dÃ¡n nhiá»u dÃ²ng, phÃ¢n tÃ­ch tá»± Ä‘á»™ng)
        </button>
        <div class="advanced-content" id="advancedContent">
          <div class="quick-import-super">
            <h3>Nháº­p kho nÃ¢ng cao</h3>
            <p style="color:var(--text2);font-size:13px;margin-bottom:12px;">DÃ¡n nhiá»u dÃ²ng <strong>tk|mk|2fa</strong> (hoáº·c <code>tk:mk</code>, <code>tk mk</code>). Há»‡ thá»‘ng tá»± tÃ¡ch, chuáº©n hoÃ¡ vÃ  Ä‘á» xuáº¥t SKU.</p>
            <textarea id="superPasteRaw" class="paste-area" placeholder="user1@mail.com|pass1|2fa1&#10;user2@gmail.com|pass2&#10;user3:pass3:"></textarea>
            <div class="tool-row">
              <label>SKU Æ°u tiÃªn:</label>
              <select id="superProfileSku">
                <option value="">-- Chá»n SKU --</option>
              </select>
              <button type="button" class="refresh-btn" onclick="doParseStock()" style="background:#000;color:#fff;border:none;">PhÃ¢n tÃ­ch</button>
            </div>
            <div id="superPreviewWrap" style="display:none;">
              <div class="preview-wrap">
                <table class="preview-table table-wrap" id="superPreviewTable"></table>
              </div>
              <div class="sku-panel">
                <span style="color:var(--text2);font-size:13px;">Ãp dá»¥ng SKU cho táº¥t cáº£ dÃ²ng há»£p lá»‡:</span>
                <select id="superApplySkuSelect"></select>
                <button type="button" class="refresh-btn" onclick="applySkuToAllValid()" style="background:var(--accent);color:#fff;border:none;">Ãp dá»¥ng</button>
                <button type="button" class="refresh-btn" onclick="doSuperImport()" style="background:#000;color:#fff;border:none;">Nháº­p lÃªn kho</button>
              </div>
              <div id="superImportResult" class="import-result" style="display:none;"></div>
            </div>
            <div id="superParseFeedback" style="font-size:13px;color:var(--text2);"></div>
          </div>
        </div>
      </div>

      <!-- Inventory summary table -->
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>SKU</th><th>CÃ³ sáºµn</th><th>ÄÃ£ bÃ¡n</th><th>ÄÃ£ giá»¯</th><th>Tá»•ng</th>
          </tr></thead>
          <tbody id="inventoryBody"><tr><td colspan="5" class="loading">Äang táº£i...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Modal: Paste Import (click SKU card) -->
    <div id="pasteImportModal" class="modal-overlay" onclick="if(event.target===this)closePasteImportModal()">
      <div class="modal-box paste-import-box" onclick="event.stopPropagation()">
        <h4 id="pasteImportTitle">Nháº­p tk|mk|2fa</h4>
        <p class="paste-import-hint">Má»—i dÃ²ng má»™t tÃ i khoáº£n. Äá»‹nh dáº¡ng: <code>email|máº­t_kháº©u|2fa</code> (2fa cÃ³ thá»ƒ bá» trá»‘ng).</p>
        <textarea id="pasteImportText" placeholder="user@mail.com|password123|abc2fa&#10;user2@mail.com|pass2|" rows="6" oninput="previewPasteLines()"></textarea>
        <div id="pastePreview" class="paste-preview"></div>
        <div id="pasteImportFeedback" style="font-size:13px;margin-top:8px;min-height:20px;color:var(--text2)"></div>
        <div class="modal-actions">
          <button type="button" class="btn-primary" onclick="submitPasteImport()">Nháº­p kho</button>
          <button type="button" class="btn-secondary" onclick="closePasteImportModal()">Huá»·</button>
        </div>
      </div>
    </div>

    <!-- AUDIT LOGS -->
    <div class="page" id="page-logs">
      <div class="page-header">
        <h1>Nháº­t kÃ½</h1>
        <button class="refresh-btn" onclick="loadLogs()">LÃ m má»›i</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Sá»± kiá»‡n</th><th>Loáº¡i</th><th>ID</th><th>Nguá»“n</th><th>Chi tiáº¿t</th><th>Thá»i gian</th>
          </tr></thead>
          <tbody id="logsBody"><tr><td colspan="6" class="loading">Äang táº£i...</td></tr></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<!-- Toast notification -->
<div class="toast" id="globalToast"></div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resolveBase() {
  const qs = new URLSearchParams(location.search);
  const fromQuery = (qs.get('base') || '').trim();
  if (fromQuery) return fromQuery.replace(/\/+$/, '');
  if (location.protocol === 'file:') return 'http://localhost:8888/.netlify/functions';
  return '/.netlify/functions';
}

const BASE = resolveBase();
let ADMIN_TOKEN = '';
const POLL_INTERVAL = 10000;
let pollTimer = null;

// SKUs to hide from the grid (discontinued)
var SKU_HIDDEN = { chatgpt_plus_3m: true };

// SKU metadata
var SKU_META = {
  chatgpt_plus_1m:     { icon: '\u{1F916}', name: 'ChatGPT Plus 1 thÃ¡ng' },
  chatgpt_plus_3m:     { icon: '\u{1F916}', name: 'ChatGPT Plus 3 thÃ¡ng (ngá»«ng bÃ¡n)' },
  chatgpt_code_1m_vn:  { icon: '\u{1F4BB}', name: 'Code ChatGPT 1 thÃ¡ng (VN)' },
  grok_7d:             { icon: '\u{1F9E0}', name: 'Grok 7 ngÃ y' },
  netflix_1m:          { icon: '\u{1F3AC}', name: 'Netflix 1 thÃ¡ng' },
  spotify_premium_1m:  { icon: '\u{1F3B5}', name: 'Spotify Premium 1 thÃ¡ng' },
  youtube_premium_1m:  { icon: '\u{25B6}\u{FE0F}', name: 'YouTube Premium 1 thÃ¡ng' },
  canva_pro_1y:        { icon: '\u{1F3A8}', name: 'Canva Pro 1 nÄƒm' },
  capcut_pro_1y:       { icon: '\u{1F3AC}', name: 'CapCut Pro 1 nÄƒm' },
  capcut_7d:           { icon: '\u{1F3AC}', name: 'CapCut 7 ngÃ y' },
  capcut_14d:          { icon: '\u{1F3AC}', name: 'CapCut 14 ngÃ y' },
  capcut_1m:           { icon: '\u{1F3AC}', name: 'CapCut Pro 1 thÃ¡ng' },
  capcut_6m:           { icon: '\u{1F3AC}', name: 'CapCut Pro 6 thÃ¡ng' },
  adobe_1m:            { icon: '\u{1F58C}\u{FE0F}', name: 'Adobe 1 thÃ¡ng' },
  microsoft365_1y:     { icon: '\u{1F4BC}', name: 'Microsoft 365 1 nÄƒm' },
  duolingo_1m:         { icon: '\u{1F989}', name: 'Duolingo Plus 1 thÃ¡ng' },
  quizlet_1m:          { icon: '\u{1F4DA}', name: 'Quizlet Plus 1 thÃ¡ng' }
};

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  var t = document.getElementById('tokenInput').value.trim();
  if (!t) return;
  try {
    var r = await fetch(BASE + '/admin-orders', { headers: { Authorization: 'Bearer ' + t } });
    if (r.status === 401) {
      document.getElementById('loginErr').textContent = 'Token khÃ´ng há»£p lá»‡';
      return;
    }
    ADMIN_TOKEN = t;
    sessionStorage.setItem('tbq_admin_token', t);
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('shell').style.display = 'flex';
    startAutoRefresh();
    loadDashboard();
  } catch (e) {
    var hint = (location.protocol === 'file:')
      ? 'Báº¡n Ä‘ang má»Ÿ báº±ng file://. HÃ£y cháº¡y "netlify dev" vÃ  má»Ÿ admin táº¡i http://localhost:8888/admin.html.'
      : 'Kiá»ƒm tra máº¡ng / endpoint Netlify Functions.';
    document.getElementById('loginErr').textContent = 'KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c mÃ¡y chá»§. (' + hint + ')';
  }
}

// Auto-restore session
(function () {
  var saved = sessionStorage.getItem('tbq_admin_token');
  if (saved) ADMIN_TOKEN = saved;
})();

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(page) {
  document.querySelectorAll('.nav-item').forEach(function (n) { n.classList.remove('active'); });
  event.currentTarget.classList.add('active');
  document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
  document.getElementById('page-' + page).classList.add('active');
  var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs };
  if (loaders[page]) loaders[page]();
}

// â”€â”€ AUTO REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoRefresh() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(function () {
    var active = document.querySelector('.page.active');
    if (!active) return;
    var id = active.id.replace('page-', '');
    var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs };
    if (loaders[id]) loaders[id]();
  }, POLL_INTERVAL);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders() {
  return { Authorization: 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' };
}
function fmtTime(iso) {
  if (!iso) return '--';
  try { return new Date(iso).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'medium' }); } catch (e) { return iso; }
}
function fmtVND(n) { return (Number(n) || 0).toLocaleString('vi-VN') + 'â‚«'; }
function badgeClass(s) {
  var map = { pending_payment:'badge-pending', paid:'badge-paid', fulfilled:'badge-fulfilled',
              failed:'badge-failed', cancelled:'badge-cancelled', expired:'badge-expired', refunded:'badge-refunded' };
  return map[s] || 'badge-pending';
}
function badgeLabel(s) {
  var map = { pending_payment:'Chá» TT', paid:'ÄÃ£ TT', fulfilled:'ÄÃ£ giao', failed:'Lá»—i', cancelled:'Huá»·', expired:'Háº¿t háº¡n', refunded:'HoÃ n tiá»n' };
  return map[s] || s;
}
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function updateClock() { document.getElementById('lastSync').textContent = new Date().toLocaleTimeString('vi-VN'); }

function showToast(msg) {
  var t = document.getElementById('globalToast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function () { t.classList.remove('show'); }, 2500);
}

function copyText(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(function () { showToast('ÄÃ£ sao chÃ©p!'); });
  }
}

function getSkuName(code) {
  var m = SKU_META[code];
  return m ? m.name : code;
}
function getSkuIcon(code) {
  var m = SKU_META[code];
  return m ? m.icon : '\u{1F4E6}';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    var r = await fetch(BASE + '/admin-orders?limit=10', { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    var data = await r.json();
    var s = data.stats || {};
    document.getElementById('statTotal').textContent = s.total || 0;
    document.getElementById('statPending').textContent = s.pending || 0;
    document.getElementById('statFulfilled').textContent = s.delivered || s.fulfilled || 0;
    document.getElementById('statRevenue').textContent = fmtVND(s.total_revenue || 0);

    var rows = data.orders || [];
    document.getElementById('dashboardOrders').innerHTML = rows.length
      ? rows.map(function (o) {
          return '<tr>' +
            '<td style="font-weight:600;color:var(--accent)">' + escHtml(o.order_code) + '</td>' +
            '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
            '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
            '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
            '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td></tr>';
        }).join('')
      : '<tr><td colspan="5" class="empty">ChÆ°a cÃ³ Ä‘Æ¡n nÃ o</td></tr>';
    updateClock();
  } catch (e) { console.error('[admin] dashboard', e); }
}

// â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _expandedOrder = null;
var _orderCredCache = {};

function setOrderTab(status) {
  document.getElementById('orderStatusFilter').value = status || '';
  document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
    t.classList.toggle('active', (t.dataset.status || '') === (status || ''));
  });
  loadOrders();
}

function setOrderTabFromFilter() {
  var v = document.getElementById('orderStatusFilter').value;
  document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
    t.classList.toggle('active', (t.dataset.status || '') === (v || ''));
  });
}

async function loadOrders() {
  try {
    var status = document.getElementById('orderStatusFilter').value;
    var search = document.getElementById('orderSearch').value.trim();
    var url = BASE + '/admin-orders?limit=200';
    if (status) url += '&status=' + status;

    var r = await fetch(url, { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    var data = await r.json();

    var stats = data.stats || {};
    document.getElementById('orderStatTotal').textContent = stats.total != null ? stats.total : '--';
    document.getElementById('orderStatPending').textContent = stats.pending != null ? stats.pending : '--';
    document.getElementById('orderStatDelivered').textContent = stats.delivered != null ? stats.delivered : '--';
    var errCount = (stats.error_count || 0) + (stats.expired || 0);
    document.getElementById('orderStatError').textContent = errCount;

    var rows = data.orders || [];
    var byCode = {};
    rows.forEach(function (o) {
      var code = o.order_code || o.id || '';
      if (!code) return;
      if (!byCode[code]) byCode[code] = { order: o, products: [] };
      if (o.product_name && byCode[code].products.indexOf(o.product_name) === -1) byCode[code].products.push(o.product_name);
    });
    var list = Object.keys(byCode).map(function (code) {
      var rec = byCode[code].order;
      if (!rec.order_code) rec.order_code = code;
      return rec;
    });

    if (search) {
      var q = search.toLowerCase();
      list = list.filter(function (o) {
        return (o.order_code || '').toLowerCase().includes(q) ||
          (o.customer_email || o.customerEmail || '').toLowerCase().includes(q) ||
          (o.customer_name || o.customerName || '').toLowerCase().includes(q);
      });
    }

    var deliveryBase = (location.protocol === 'file:' ? 'http://localhost:8888' : location.origin) + (location.protocol === 'file:' ? '' : location.pathname.replace(/admin\.html.*$/, ''));

    var html = '';
    list.forEach(function (o, i) {
      var products = (byCode[o.order_code] && byCode[o.order_code].products && byCode[o.order_code].products.length)
        ? byCode[o.order_code].products.join(', ') : (o.product_name || '--');
      var deliveryUrl = o.delivery_token ? (deliveryBase + '/.netlify/functions/delivery?token=' + encodeURIComponent(o.delivery_token) + '&order=' + encodeURIComponent(o.order_code)) : '';
      var actionHtml = deliveryUrl
        ? '<a href="' + deliveryUrl + '" target="_blank" class="btn-link">Giao hÃ ng</a>'
        : '<span style="color:var(--text-muted)">--</span>';

      var isExpanded = _expandedOrder === o.order_code;
      html += '<tr style="cursor:pointer" onclick="toggleOrderDetail(\'' + escAttr(o.order_code) + '\', this)">' +
        '<td>' + (i + 1) + '</td>' +
        '<td class="col-code">' + escHtml(o.order_code) + '</td>' +
        '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
        '<td style="color:var(--text2)">' + escHtml(o.customer_email || o.customerEmail || '--') + '</td>' +
        '<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis" title="' + escAttr(products) + '">' + escHtml(products) + '</td>' +
        '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
        '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
        '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td>' +
        '<td class="col-actions" onclick="event.stopPropagation()">' + actionHtml + '</td></tr>';

      // Detail row (hidden by default)
      html += '<tr class="order-detail-row" id="detail-' + escAttr(o.order_code) + '" style="display:' + (isExpanded ? 'table-row' : 'none') + '">' +
        '<td colspan="9"><div class="order-detail-panel" id="detail-panel-' + escAttr(o.order_code) + '">' +
        (isExpanded ? '' : '<div class="cred-loading">Äang táº£i...</div>') +
        '</div></td></tr>';
    });

    document.getElementById('ordersBody').innerHTML = html || '<tr><td colspan="9" class="empty">KhÃ´ng cÃ³ Ä‘Æ¡n nÃ o</td></tr>';

    // Re-load expanded order detail if any
    if (_expandedOrder && _orderCredCache[_expandedOrder]) {
      renderOrderDetail(_expandedOrder, _orderCredCache[_expandedOrder]);
    }

    updateClock();
  } catch (e) { console.error('[admin] orders', e); }
}

async function toggleOrderDetail(orderCode, rowEl) {
  var detailRow = document.getElementById('detail-' + orderCode);
  if (!detailRow) return;

  if (_expandedOrder === orderCode) {
    // Collapse
    detailRow.style.display = 'none';
    _expandedOrder = null;
    return;
  }

  // Collapse previous
  if (_expandedOrder) {
    var prev = document.getElementById('detail-' + _expandedOrder);
    if (prev) prev.style.display = 'none';
  }

  _expandedOrder = orderCode;
  detailRow.style.display = 'table-row';

  // Check cache
  if (_orderCredCache[orderCode]) {
    renderOrderDetail(orderCode, _orderCredCache[orderCode]);
    return;
  }

  // Fetch
  var panel = document.getElementById('detail-panel-' + orderCode);
  if (panel) panel.innerHTML = '<div class="cred-loading">Äang táº£i thÃ´ng tin tÃ i khoáº£n...</div>';

  try {
    var r = await fetch(BASE + '/admin-orders?action=order_detail&order_code=' + encodeURIComponent(orderCode), { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    var data = await r.json();
    _orderCredCache[orderCode] = data;
    renderOrderDetail(orderCode, data);
  } catch (e) {
    if (panel) panel.innerHTML = '<div class="cred-loading" style="color:var(--red)">Lá»—i táº£i dá»¯ liá»‡u: ' + escHtml(e.message) + '</div>';
  }
}

function renderOrderDetail(orderCode, data) {
  var panel = document.getElementById('detail-panel-' + orderCode);
  if (!panel) return;

  var creds = data.credentials || [];
  var lines = data.lines || [];

  if (creds.length === 0 && lines.length === 0) {
    panel.innerHTML = '<div class="cred-empty">KhÃ´ng cÃ³ thÃ´ng tin tÃ i khoáº£n (Ä‘Æ¡n Ä‘áº·t trÆ°á»›c hoáº·c chÆ°a nháº­p kho)</div>';
    return;
  }

  var html = '';

  // Show order lines info
  if (lines.length > 0) {
    html += '<div style="margin-bottom:12px;font-size:13px;color:var(--text2)">Sáº£n pháº©m: ' +
      lines.map(function (l) { return '<strong>' + escHtml(l.sku_name || l.product_name || l.sku_code || '--') + '</strong>'; }).join(', ') +
      '</div>';
  }

  if (creds.length === 0) {
    html += '<div class="cred-empty">ChÆ°a cÃ³ tÃ i khoáº£n Ä‘Æ°á»£c gÃ¡n cho Ä‘Æ¡n nÃ y</div>';
  } else {
    html += '<div class="cred-cards">';
    creds.forEach(function (c, idx) {
      var note = c.note || '';
      var twofa = '';
      // Extract 2FA from note if present
      if (note.indexOf('2FA:') === 0) {
        var parts = note.split('|');
        twofa = parts[0].replace('2FA:', '').trim();
        note = parts.slice(1).join('|').trim();
      } else if (note && !note.includes(' ') && note.length < 40) {
        twofa = note;
        note = '';
      }

      html += '<div class="cred-card">' +
        '<div class="cred-sku">' + escHtml(c.sku_name || c.sku_code || 'TÃ i khoáº£n ' + (idx + 1)) +
        ' <span class="badge ' + (c.stock_status === 'sold' ? 'badge-fulfilled' : c.stock_status === 'reserved' ? 'badge-paid' : 'badge-pending') + '" style="font-size:10px;padding:2px 8px">' + escHtml(c.stock_status || '--') + '</span></div>' +
        '<div class="cred-field">' +
          '<span class="cred-label">TK</span>' +
          '<span class="cred-value">' + escHtml(c.account_info || '--') + '</span>' +
          '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.account_info || '') + '\')">ğŸ“‹</button>' +
        '</div>' +
        '<div class="cred-field">' +
          '<span class="cred-label">MK</span>' +
          '<span class="cred-value blurred" id="mk-' + orderCode + '-' + idx + '" onclick="this.classList.remove(\'blurred\')">' + escHtml(c.secret_key || '--') + '</span>' +
          '<button class="cred-btn" onclick="event.stopPropagation();document.getElementById(\'mk-' + orderCode + '-' + idx + '\').classList.remove(\'blurred\')" title="Hiá»‡n">ğŸ‘</button>' +
          '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.secret_key || '') + '\')">ğŸ“‹</button>' +
        '</div>';

      if (twofa) {
        html += '<div class="cred-field">' +
          '<span class="cred-label">2FA</span>' +
          '<span class="cred-value" style="color:var(--accent)">' + escHtml(twofa) + '</span>' +
          '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(twofa) + '\')">ğŸ“‹</button>' +
        '</div>';
      }

      if (note) {
        html += '<div class="cred-field">' +
          '<span class="cred-label" style="min-width:auto">Note</span>' +
          '<span class="cred-value" style="font-family:inherit;font-size:12px;color:var(--text2)">' + escHtml(note) + '</span>' +
        '</div>';
      }

      html += '</div>';
    });
    html += '</div>';

    // Copy all button
    html += '<button style="margin-top:10px;padding:6px 14px;border-radius:6px;font-size:12px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-family:inherit" onclick="event.stopPropagation();copyAllCreds(\'' + escAttr(orderCode) + '\')">ğŸ“‹ Sao chÃ©p táº¥t cáº£</button>';
  }

  panel.innerHTML = html;
}

function copyAllCreds(orderCode) {
  var data = _orderCredCache[orderCode];
  if (!data || !data.credentials) return;
  var text = data.credentials.map(function (c, i) {
    var note = c.note || '';
    var twofa = '';
    if (note.indexOf('2FA:') === 0) {
      var parts = note.split('|');
      twofa = parts[0].replace('2FA:', '').trim();
    } else if (note && !note.includes(' ') && note.length < 40) {
      twofa = note;
    }
    return 'TK: ' + (c.account_info || '') + '\nMK: ' + (c.secret_key || '') + (twofa ? '\n2FA: ' + twofa : '');
  }).join('\n---\n');
  copyText(text);
}

// â”€â”€ INVENTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setInventoryStatus(msg, isError) {
  var el = document.getElementById('inventoryStatus');
  if (el) { el.textContent = msg; el.className = 'inventory-status' + (isError ? ' error' : ''); }
}

async function loadInventory() {
  var btn = document.getElementById('inventoryRefreshBtn');
  setInventoryStatus('Äang táº£i...');
  if (btn) btn.disabled = true;
  try {
    var r = await fetch(BASE + '/inventory?action=all');
    if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
    var data = await r.json();
    var rows = data.inventory || [];
    window._lastInventoryRows = rows;

    // Render SKU card grid (only auto delivery = giao lien)
    renderSkuGrid(rows);

    // Populate advanced import SKU dropdown
    populateSkuDropdown(rows);

    // Render summary table (exclude hidden SKUs)
    var visibleRows = rows.filter(function (r) { return !SKU_HIDDEN[(r.sku || r.product_code || '').trim()]; });
    document.getElementById('inventoryBody').innerHTML = visibleRows.length
      ? visibleRows.map(function (i) {
          var avail = i.available || i.available_units || 0;
          var isPreorder = (i.delivery_type || 'auto') === 'owner_upgrade';
          return '<tr>' +
            '<td style="font-weight:600">' + escHtml(i.sku || i.code || i.product_code) + '</td>' +
            '<td style="color:var(--green);font-weight:600">' + (isPreorder ? 'N/A' : avail) + '</td>' +
            '<td style="color:var(--red)">' + (i.sold_units || i.sold || 0) + '</td>' +
            '<td style="color:var(--yellow)">' + (i.reserved_units || i.reserved || 0) + '</td>' +
            '<td>' + (i.total || i.total_units || 0) + '</td></tr>';
        }).join('')
      : '<tr><td colspan="5" class="empty">ChÆ°a cÃ³ hÃ ng trong kho</td></tr>';

    setInventoryStatus('');
    updateClock();
  } catch (e) {
    console.error('[admin] inventory', e);
    setInventoryStatus('KhÃ´ng táº£i Ä‘Æ°á»£c. Cháº¡y netlify dev vÃ  má»Ÿ http://localhost:8888/admin.html', true);
  }
  if (btn) btn.disabled = false;
}

function renderSkuGrid(rows) {
  var grid = document.getElementById('skuGrid');
  if (!grid) return;

  // Filter to only auto delivery (giao lien) SKUs, exclude hidden
  var autoSkus = rows.filter(function (r) {
    var sku = (r.sku || r.product_code || '').trim();
    return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku];
  });

  if (autoSkus.length === 0) {
    grid.innerHTML = '<div class="empty" style="grid-column:1/-1">ChÆ°a cÃ³ SKU giao liá»n nÃ o</div>';
    return;
  }

  // Sort: out of stock first, then by name
  autoSkus.sort(function (a, b) {
    var aAvail = a.available || 0;
    var bAvail = b.available || 0;
    if (aAvail === 0 && bAvail > 0) return -1;
    if (aAvail > 0 && bAvail === 0) return 1;
    return (getSkuName(a.sku || a.product_code) || '').localeCompare(getSkuName(b.sku || b.product_code) || '');
  });

  grid.innerHTML = autoSkus.map(function (r) {
    var sku = r.sku || r.product_code || '';
    var avail = r.available || 0;
    var total = r.total || 0;
    var stockClass = avail === 0 ? 'out-of-stock' : avail <= 3 ? 'low-stock' : 'in-stock';

    return '<div class="sku-card ' + stockClass + '" onclick="openPasteImportForSku(\'' + escAttr(sku) + '\')">' +
      '<div class="sku-icon">' + getSkuIcon(sku) + '</div>' +
      '<div class="sku-name">' + escHtml(getSkuName(sku)) + '</div>' +
      '<div class="sku-code">' + escHtml(sku) + '</div>' +
      '<div class="sku-stock">' +
        '<span class="sku-stock-count">' + avail + '</span>' +
        '<span class="sku-stock-label">cÃ³ sáºµn / ' + total + ' tá»•ng</span>' +
      '</div>' +
      '<div class="sku-import-hint">+ Nháº­p kho</div>' +
    '</div>';
  }).join('');
}

function populateSkuDropdown(rows) {
  var sel = document.getElementById('superProfileSku');
  if (!sel) return;
  var autoSkus = rows.filter(function (r) { var sku = (r.sku || r.product_code || '').trim(); return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku]; });
  sel.innerHTML = '<option value="">-- Chá»n SKU --</option>' +
    autoSkus.map(function (r) {
      var sku = r.sku || r.product_code || '';
      return '<option value="' + escAttr(sku) + '">' + escHtml(getSkuName(sku)) + '</option>';
    }).join('');
}

// â”€â”€ PASTE IMPORT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._pasteImportSku = '';

function openPasteImportForSku(skuCode) {
  window._pasteImportSku = skuCode;
  document.getElementById('pasteImportTitle').textContent = 'Nháº­p kho: ' + getSkuName(skuCode);
  document.getElementById('pasteImportText').value = '';
  document.getElementById('pasteImportFeedback').textContent = '';
  document.getElementById('pastePreview').innerHTML = '';
  document.getElementById('pasteImportModal').classList.add('show');
  setTimeout(function () { document.getElementById('pasteImportText').focus(); }, 100);
}

function closePasteImportModal() {
  document.getElementById('pasteImportModal').classList.remove('show');
  window._pasteImportSku = '';
}

function parsePasteLines(text) {
  return text.split(/\n/).map(function (line) {
    var trimmed = line.trim();
    if (!trimmed) return null;
    // Support: pipe, colon, tab, multiple spaces
    var parts = trimmed.split(/[|:\t]+/);
    if (parts.length < 2) {
      // Try splitting by 2+ spaces
      parts = trimmed.split(/\s{2,}/);
    }
    return {
      account_info: (parts[0] || '').trim(),
      secret_key: (parts[1] || '').trim(),
      note: (parts[2] || '').trim()
    };
  }).filter(function (row) { return row && row.account_info !== ''; });
}

function previewPasteLines() {
  var text = (document.getElementById('pasteImportText').value || '').trim();
  var previewEl = document.getElementById('pastePreview');
  if (!text) { previewEl.innerHTML = ''; return; }

  var rows = parsePasteLines(text);
  if (rows.length === 0) { previewEl.innerHTML = ''; return; }

  var html = '<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">' + rows.length + ' tÃ i khoáº£n</div>';
  rows.slice(0, 10).forEach(function (r) {
    html += '<div class="preview-line">' +
      '<span class="pv-account">' + escHtml(r.account_info) + '</span>' +
      '<span class="pv-pass">' + (r.secret_key ? '******' : '--') + '</span>' +
      (r.note ? '<span class="pv-2fa">' + escHtml(r.note) + '</span>' : '') +
    '</div>';
  });
  if (rows.length > 10) {
    html += '<div style="color:var(--text-muted);font-size:11px;padding:4px 0">... vÃ  ' + (rows.length - 10) + ' dÃ²ng ná»¯a</div>';
  }
  previewEl.innerHTML = html;
}

async function submitPasteImport() {
  var sku = window._pasteImportSku;
  if (!sku) return;
  var raw = (document.getElementById('pasteImportText').value || '').trim();
  var fb = document.getElementById('pasteImportFeedback');
  if (!raw) { fb.textContent = 'DÃ¡n Ã­t nháº¥t má»™t dÃ²ng tk|mk|2fa.'; fb.style.color = 'var(--yellow)'; return; }

  var rows = parsePasteLines(raw);
  if (rows.length === 0) { fb.textContent = 'Má»—i dÃ²ng cáº§n cÃ³ Ã­t nháº¥t pháº§n tÃ i khoáº£n.'; fb.style.color = 'var(--yellow)'; return; }

  fb.textContent = 'Äang nháº­p ' + rows.length + ' dÃ²ng...';
  fb.style.color = 'var(--text2)';

  var items = rows.map(function (r) {
    var note = r.note ? ('2FA: ' + r.note) : '';
    return { sku_code: sku, account_info: r.account_info, secret_key: r.secret_key, note: note };
  });

  try {
    var r = await fetch(BASE + '/import-stock', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    });
    var data = await r.json().catch(function () { return {}; });
    if (r.status === 401) { fb.textContent = 'Token háº¿t háº¡n - Ä‘Äƒng nháº­p láº¡i.'; fb.style.color = 'var(--red)'; return; }
    if (!r.ok) { fb.textContent = 'Lá»—i: ' + (data.error || data.message || r.status); fb.style.color = 'var(--red)'; return; }

    fb.style.color = 'var(--green)';
    fb.textContent = 'ÄÃ£ thÃªm ' + (data.inserted || 0) + ', trÃ¹ng ' + (data.skipped_duplicate || 0) + '.';
    showToast('ÄÃ£ nháº­p ' + (data.inserted || 0) + ' tÃ i khoáº£n vÃ o ' + getSkuName(sku));
    loadInventory();
    document.getElementById('pasteImportText').value = '';
    document.getElementById('pastePreview').innerHTML = '';
    setTimeout(closePasteImportModal, 1200);
  } catch (e) {
    fb.textContent = 'Lá»—i máº¡ng: ' + e.message;
    fb.style.color = 'var(--red)';
  }
}

// â”€â”€ ADVANCED IMPORT (toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAdvancedImport() {
  var btn = document.getElementById('advancedToggle');
  var content = document.getElementById('advancedContent');
  btn.classList.toggle('open');
  content.classList.toggle('show');
}

// â”€â”€ NHAP KHO SIEU NHANH (parse -> preview -> import) â”€â”€â”€â”€â”€â”€â”€â”€â”€
var LAST_USED_SKU_KEY = 'tbq_last_used_sku';
var _superParsedRows = [];

async function doParseStock() {
  var raw = (document.getElementById('superPasteRaw') && document.getElementById('superPasteRaw').value) ? document.getElementById('superPasteRaw').value.trim() : '';
  var fb = document.getElementById('superParseFeedback');
  if (!raw) { if (fb) fb.textContent = 'DÃ¡n dá»¯ liá»‡u (tk|mk|2fa) vÃ o Ã´ trÃªn rá»“i báº¥m PhÃ¢n tÃ­ch.'; return; }
  if (fb) fb.textContent = 'Äang phÃ¢n tÃ­ch...';
  var profileSku = (document.getElementById('superProfileSku') && document.getElementById('superProfileSku').value) || '';
  var lastUsedSku = localStorage.getItem(LAST_USED_SKU_KEY) || '';
  try {
    var r = await fetch(BASE + '/parse-stock', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ raw: raw, last_used_sku: lastUsedSku || undefined, profile_sku: profileSku || undefined })
    });
    var data = await r.json().catch(function () { return {}; });
    if (r.status === 401) { if (fb) fb.textContent = 'Token háº¿t háº¡n - Ä‘Äƒng nháº­p láº¡i.'; return; }
    if (!r.ok) { if (fb) fb.textContent = 'Lá»—i: ' + (data.error || r.status); return; }
    _superParsedRows = data.rows || [];
    if (fb) fb.textContent = 'ÄÃ£ phÃ¢n tÃ­ch: ' + (data.summary && data.summary.valid) + ' há»£p lá»‡, ' + (data.summary && data.summary.error) + ' lá»—i.';
    renderSuperPreviewTable();
    document.getElementById('superPreviewWrap').style.display = 'block';
    fillSuperApplySkuSelect();
  } catch (e) {
    if (fb) fb.textContent = 'Lá»—i: ' + e.message;
  }
}

function fillSuperApplySkuSelect() {
  var sel = document.getElementById('superApplySkuSelect');
  if (!sel) return;
  var codes = new Set();
  _superParsedRows.forEach(function (row) {
    (row.suggested_skus || []).forEach(function (s) { codes.add(s.sku_code); });
  });
  var opts = Array.from(codes).sort();
  sel.innerHTML = '<option value="">-- Chá»n SKU --</option>' + opts.map(function (c) {
    return '<option value="' + escAttr(c) + '">' + escHtml(getSkuName(c)) + '</option>';
  }).join('');
}

function renderSuperPreviewTable() {
  var tbody = document.getElementById('superPreviewTable');
  if (!tbody) return;
  var rows = _superParsedRows;
  if (!rows.length) { tbody.innerHTML = '<tbody><tr><td class="empty">KhÃ´ng cÃ³ dÃ²ng nÃ o</td></tr></tbody>'; return; }
  var thead = '<thead><tr><th></th><th>#</th><th>TÃ i khoáº£n</th><th>Máº­t kháº©u</th><th>2FA</th><th>SKU</th><th>Tráº¡ng thÃ¡i</th></tr></thead>';
  var bodyRows = rows.map(function (row, i) {
    var suggested = row.suggested_skus || [];
    var top = suggested[0];
    var selected = row.selected_sku || (top && top.sku_code) || '';
    var opts = suggested.map(function (s) {
      return '<option value="' + escAttr(s.sku_code) + '"' + (s.sku_code === selected ? ' selected' : '') + '>' + getSkuName(s.sku_code) + ' (' + (s.confidence || 0) + '%)</option>';
    }).join('');
    if (selected && suggested.every(function (s) { return s.sku_code !== selected; })) {
      opts = '<option value="' + escAttr(selected) + '" selected>' + getSkuName(selected) + '</option>' + opts;
    }
    var statusCls = row.status === 'valid' ? 'row-status-valid' : 'row-status-error';
    var statusText = row.status === 'valid' ? 'OK' : (row.error || 'Lá»—i');
    var cb = row.status === 'valid' ? '<input type="checkbox" class="super-row-cb" data-index="' + i + '" checked>' : '';
    return '<tr data-index="' + i + '">' +
      '<td>' + cb + '</td>' +
      '<td>' + (row.rowIndex || i + 1) + '</td>' +
      '<td class="col-account" title="' + escAttr(row.account) + '">' + escHtml(row.account) + '</td>' +
      '<td class="col-secret masked">********</td>' +
      '<td>' + (row.twofa || '--') + '</td>' +
      '<td><select class="super-sku-select" data-index="' + i + '">' + opts + '</select></td>' +
      '<td class="' + statusCls + '">' + statusText + '</td></tr>';
  }).join('');
  tbody.innerHTML = thead + '<tbody>' + bodyRows + '</tbody>';
  tbody.querySelectorAll('.super-sku-select').forEach(function (sel) {
    sel.addEventListener('change', function () {
      var idx = parseInt(sel.dataset.index, 10);
      if (_superParsedRows[idx]) _superParsedRows[idx].selected_sku = sel.value;
    });
  });
}

function applySkuToAllValid() {
  var sel = document.getElementById('superApplySkuSelect');
  var sku = sel && sel.value ? sel.value.trim() : '';
  if (!sku) return;
  _superParsedRows.forEach(function (row) {
    if (row.status === 'valid') row.selected_sku = sku;
  });
  renderSuperPreviewTable();
}

async function doSuperImport() {
  var validRows = _superParsedRows.filter(function (r) { return r.status === 'valid'; });
  var items = validRows.map(function (row) {
    var sku = row.selected_sku || (row.suggested_skus && row.suggested_skus[0] && row.suggested_skus[0].sku_code) || '';
    var note = row.twofa ? ('2FA: ' + row.twofa + (row.notes ? ' | ' + row.notes : '')) : (row.notes || '');
    return { sku_code: sku, account_info: row.account, secret_key: row.password || '', note: note };
  }).filter(function (item) { return item.sku_code; });
  if (items.length === 0) {
    var resEl = document.getElementById('superImportResult');
    if (resEl) { resEl.style.display = 'block'; resEl.innerHTML = 'Chá»n SKU cho Ã­t nháº¥t má»™t dÃ²ng há»£p lá»‡.'; }
    return;
  }
  var resEl = document.getElementById('superImportResult');
  if (resEl) { resEl.style.display = 'block'; resEl.textContent = 'Äang nháº­p ' + items.length + ' dÃ²ng...'; }
  try {
    var r = await fetch(BASE + '/import-stock', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items })
    });
    var data = await r.json().catch(function () { return {}; });
    if (r.status === 401) { if (resEl) resEl.innerHTML = 'Token háº¿t háº¡n - Ä‘Äƒng nháº­p láº¡i.'; return; }
    if (!r.ok) { if (resEl) resEl.innerHTML = 'Lá»—i: ' + (data.error || data.message || r.status); return; }
    if (items[0] && items[0].sku_code) localStorage.setItem(LAST_USED_SKU_KEY, items[0].sku_code);
    if (resEl) resEl.innerHTML = 'ÄÃ£ thÃªm <strong>' + (data.inserted || 0) + '</strong>, trÃ¹ng <strong>' + (data.skipped_duplicate || 0) + '</strong>' + (data.errors && data.errors.length ? ', lá»—i: ' + data.errors.length : '') + '.';
    showToast('ÄÃ£ nháº­p ' + (data.inserted || 0) + ' tÃ i khoáº£n');
    loadInventory();
  } catch (e) {
    if (resEl) resEl.innerHTML = 'Lá»—i máº¡ng: ' + e.message;
  }
}

// â”€â”€ AUDIT LOGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLogs() {
  try {
    var r = await fetch(BASE + '/webhook-logs?limit=50', { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    var data = await r.json();
    var rows = data.logs || [];
    document.getElementById('logsBody').innerHTML = rows.length
      ? rows.map(function (l) {
          return '<tr>' +
            '<td style="font-weight:600;color:var(--accent)">' + escHtml(l.event_type || l.event || '--') + '</td>' +
            '<td>' + escHtml(l.entity_type || '--') + '</td>' +
            '<td>' + escHtml(l.entity_id || l.order_id || '--') + '</td>' +
            '<td style="color:var(--text2)">' + escHtml(l.source || l.actor || '--') + '</td>' +
            '<td style="color:var(--text2);font-size:12px;max-width:260px;overflow:hidden;text-overflow:ellipsis">' + escHtml(l.payload || l.message || '--') + '</td>' +
            '<td style="color:var(--text2)">' + fmtTime(l.created_at) + '</td></tr>';
        }).join('')
      : '<tr><td colspan="6" class="empty">ChÆ°a cÃ³ nháº­t kÃ½ nÃ o</td></tr>';
    updateClock();
  } catch (e) { console.error('[admin] logs', e); }
}

// â”€â”€ UNAUTH handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleUnauth() {
  sessionStorage.removeItem('tbq_admin_token');
  ADMIN_TOKEN = '';
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('shell').style.display = 'none';
  document.getElementById('loginErr').textContent = 'Token háº¿t háº¡n - Ä‘Äƒng nháº­p láº¡i';
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function () {
  if (ADMIN_TOKEN) {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('shell').style.display = 'flex';
    startAutoRefresh();
    loadDashboard();
  }
};
</script>
</body>
</html>
