<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TBQ Admin ‚Äì Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin ƒë·ªìng b·ªô phong c√°ch web b√°n h√†ng TBQ Homie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    :root {
      --bg: #f0f8ff;
      --bg-page: #f7f9fc;
      --surface: #ffffff;
      --surface2: #f9fafb;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --text: #1f2937;
      --text2: #6b7280;
      --text-muted: #9ca3af;
      --accent: #2563eb;
      --accent-dim: rgba(37, 99, 235, 0.1);
      --green: #10b981;
      --green-dim: #ecfdf5;
      --yellow: #f59e0b;
      --yellow-dim: #fffbeb;
      --red: #ef4444;
      --red-dim: #fef2f2;
      --purple: #8b5cf6;
      --purple-dim: #f5f3ff;
      --orange: #f97316;
      --orange-dim: #fff7ed;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      --font: 'Be Vietnam Pro', 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .shell {
      display: flex;
      min-height: 100vh
    }

    .sidebar {
      width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm)
    }

    .sidebar-logo {
      padding: 0 20px;
      margin-bottom: 28px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.5px
    }

    .sidebar-logo span {
      color: var(--text2);
      font-weight: 500
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      cursor: pointer;
      color: var(--text2);
      border-left: 3px solid transparent;
      transition: .15s;
      font-size: 14px
    }

    .nav-item:hover {
      background: var(--surface2);
      color: var(--text)
    }

    .nav-item.active {
      border-left-color: var(--accent);
      background: var(--accent-dim);
      color: var(--accent);
      font-weight: 600
    }

    .nav-icon {
      width: 20px;
      text-align: center;
      font-size: 16px
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted)
    }

    .main {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      background: var(--bg-page)
    }

    .page {
      display: none
    }

    .page.active {
      display: block
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ header row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 8px
    }

    .page-header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -.5px;
      color: var(--text)
    }

    .page-header .header-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .refresh-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      transition: .15s;
      box-shadow: var(--shadow-sm);
      font-family: inherit
    }

    .refresh-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim)
    }

    .refresh-btn:disabled {
      opacity: .7;
      cursor: not-allowed
    }

    .inventory-status {
      font-size: 13px;
      color: var(--text2);
      margin-right: 12px
    }

    .inventory-status.error {
      color: var(--red)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ stat cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin-bottom: 28px
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-md)
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 8px
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text)
    }

    .stat-card.green .value {
      color: var(--green)
    }

    .stat-card.yellow .value {
      color: var(--yellow)
    }

    .stat-card.red .value {
      color: var(--red)
    }

    .stat-card.purple .value {
      color: var(--purple)
    }

    .stat-card.blue .value {
      color: var(--accent)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-md)
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th {
      text-align: left;
      padding: 14px 18px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: var(--text2);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      white-space: nowrap;
      background: var(--surface2)
    }

    td {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border-light);
      white-space: nowrap;
      color: var(--text)
    }

    tr:last-child td {
      border-bottom: none
    }

    tr:hover td {
      background: var(--surface2)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap
    }

    .badge-pending {
      background: var(--yellow-dim);
      color: #b45309
    }

    .badge-paid {
      background: var(--accent-dim);
      color: var(--accent)
    }

    .badge-fulfilled {
      background: var(--green-dim);
      color: #047857
    }

    .badge-failed,
    .badge-cancelled,
    .badge-expired {
      background: var(--red-dim);
      color: var(--red)
    }

    .badge-refunded {
      background: var(--purple-dim);
      color: var(--purple)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ filter bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center
    }

    .filter-bar select,
    .filter-bar input {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit
    }

    .filter-bar select:focus,
    .filter-bar input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Order management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .order-management .order-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px
    }

    .order-management .order-stats-row .stat-card {
      margin-bottom: 0
    }

    .order-management .order-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px
    }

    .order-management .order-toolbar .search-wrap {
      flex: 1;
      min-width: 200px
    }

    .order-management .order-toolbar .search-wrap input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit
    }

    .order-management .order-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border)
    }

    .order-management .order-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text2);
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      font-family: inherit
    }

    .order-management .order-tab:hover {
      color: var(--text);
      background: var(--surface2)
    }

    .order-management .order-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--accent-dim)
    }

    .order-management .order-table-wrap {
      overflow-x: auto
    }

    .order-management .order-table-wrap table {
      font-size: 13px
    }

    .order-management .order-table-wrap th,
    .order-management .order-table-wrap td {
      padding: 12px 14px
    }

    .order-management .order-table-wrap .col-code {
      font-weight: 600;
      color: var(--accent)
    }

    .order-management .order-table-wrap .col-actions {
      white-space: nowrap
    }

    .order-management .order-table-wrap .btn-link {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      background: var(--surface2);
      color: var(--accent);
      border: 1px solid var(--border);
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-family: inherit
    }

    .order-management .order-table-wrap .btn-link:hover {
      background: var(--accent-dim)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Order credential detail panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .order-detail-row td {
      padding: 0 !important;
      background: var(--surface2) !important
    }

    .order-detail-panel {
      padding: 16px 20px;
      border-top: 1px solid var(--border)
    }

    .cred-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px
    }

    .cred-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      min-width: 280px;
      flex: 1;
      max-width: 420px
    }

    .cred-card .cred-sku {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--text2);
      margin-bottom: 8px;
      font-weight: 600
    }

    .cred-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px
    }

    .cred-field .cred-label {
      color: var(--text2);
      min-width: 32px;
      font-weight: 600;
      font-size: 12px
    }

    .cred-field .cred-value {
      flex: 1;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
      word-break: break-all;
      color: var(--text)
    }

    .cred-field .cred-value.blurred {
      filter: blur(5px);
      user-select: none;
      cursor: pointer
    }

    .cred-field .cred-btn {
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface2);
      cursor: pointer;
      font-size: 11px;
      color: var(--text2);
      transition: .15s;
      flex-shrink: 0
    }

    .cred-field .cred-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim)
    }

    .cred-loading {
      color: var(--text2);
      font-size: 13px;
      padding: 8px 0
    }

    .cred-empty {
      color: var(--text-muted);
      font-size: 13px;
      font-style: italic;
      padding: 8px 0
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ login overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 380px;
      text-align: center;
      box-shadow: var(--shadow-lg)
    }

    .login-box h2 {
      margin-bottom: 8px;
      font-size: 20px;
      color: var(--text)
    }

    .login-box p {
      color: var(--text2);
      margin-bottom: 24px;
      font-size: 14px
    }

    .login-box input {
      width: 100%;
      padding: 12px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
      margin-bottom: 16px;
      font-family: inherit
    }

    .login-box input:focus {
      outline: none;
      border-color: var(--accent)
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      background: #000;
      border: none;
      border-radius: var(--radius);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .2s;
      font-family: inherit
    }

    .login-box button:hover {
      opacity: .9
    }

    .login-err {
      color: var(--red);
      font-size: 13px;
      margin-top: 12px;
      min-height: 18px
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ empty / loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .empty {
      color: var(--text2);
      text-align: center;
      padding: 48px 0;
      font-size: 15px
    }

    .loading {
      color: var(--text2);
      padding: 24px 0;
      text-align: center;
      font-size: 14px
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SKU Card Grid (nh·∫≠p kho nhanh) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sku-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px
    }

    .sku-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all .2s;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden
    }

    .sku-card:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px)
    }

    .sku-card:active {
      transform: translateY(0)
    }

    .sku-card.in-stock {
      border-color: var(--green)
    }

    .sku-card.low-stock {
      border-color: var(--orange)
    }

    .sku-card.out-of-stock {
      border-color: var(--red);
      opacity: .85
    }

    .sku-card .sku-icon {
      font-size: 32px;
      margin-bottom: 10px;
      line-height: 1
    }

    .sku-card .sku-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3
    }

    .sku-card .sku-code {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
      margin-bottom: 12px
    }

    .sku-card .sku-stock {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .sku-card .sku-stock-count {
      font-size: 24px;
      font-weight: 700
    }

    .sku-card.in-stock .sku-stock-count {
      color: var(--green)
    }

    .sku-card.low-stock .sku-stock-count {
      color: var(--orange)
    }

    .sku-card.out-of-stock .sku-stock-count {
      color: var(--red)
    }

    .sku-card .sku-stock-label {
      font-size: 12px;
      color: var(--text2)
    }

    .sku-card .sku-import-hint {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--accent);
      color: #fff;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      font-weight: 600;
      transform: translateY(100%);
      transition: transform .2s
    }

    .sku-card:hover .sku-import-hint {
      transform: translateY(0)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Nh·∫≠p kho n√¢ng cao (collapsible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .advanced-import {
      margin-bottom: 24px
    }

    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      color: var(--text2);
      transition: .15s;
      width: 100%
    }

    .advanced-toggle:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .advanced-toggle .toggle-arrow {
      transition: transform .2s;
      font-size: 10px
    }

    .advanced-toggle.open .toggle-arrow {
      transform: rotate(90deg)
    }

    .advanced-content {
      display: none;
      margin-top: 8px
    }

    .advanced-content.show {
      display: block
    }

    .quick-import-super {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md)
    }

    .quick-import-super h3 {
      margin-bottom: 8px;
      font-size: 16px;
      color: var(--text)
    }

    .quick-import-super .paste-area {
      width: 100%;
      min-height: 140px;
      padding: 12px;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface2);
      color: var(--text);
      resize: vertical;
      margin-bottom: 12px
    }

    .quick-import-super .tool-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px
    }

    .quick-import-super .tool-row select {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit
    }

    .quick-import-super .preview-wrap {
      overflow-x: auto;
      margin-bottom: 12px;
      max-height: 320px;
      overflow-y: auto
    }

    .quick-import-super .preview-table {
      font-size: 12px
    }

    .quick-import-super .preview-table th,
    .quick-import-super .preview-table td {
      padding: 8px 10px;
      white-space: nowrap
    }

    .quick-import-super .preview-table .col-account {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .quick-import-super .preview-table .col-secret {
      font-family: monospace;
      color: var(--text2)
    }

    .quick-import-super .preview-table .col-secret.masked {
      filter: blur(4px);
      user-select: none
    }

    .quick-import-super .preview-table .cell-copy {
      cursor: pointer;
      opacity: .7
    }

    .quick-import-super .row-status-valid {
      color: var(--green)
    }

    .quick-import-super .row-status-error {
      color: var(--red)
    }

    .quick-import-super .confidence-bar {
      display: inline-block;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      min-width: 40px;
      vertical-align: middle
    }

    .quick-import-super .confidence-bar span {
      display: block;
      height: 100%;
      border-radius: 3px;
      background: var(--green)
    }

    .quick-import-super .sku-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm)
    }

    .quick-import-super .import-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      font-size: 13px
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      backdrop-filter: blur(2px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .modal-overlay.show {
      display: flex
    }

    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg)
    }

    .modal-box h4 {
      margin-bottom: 16px;
      font-size: 16px;
      color: var(--text)
    }

    .modal-box label {
      display: block;
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 4px
    }

    .modal-box input,
    .modal-box textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 13px;
      margin-bottom: 12px;
      font-family: inherit
    }

    .modal-box input:focus,
    .modal-box textarea:focus {
      outline: none;
      border-color: var(--accent)
    }

    .modal-box textarea {
      min-height: 60px;
      resize: vertical
    }

    .modal-box .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px
    }

    .modal-box .modal-actions button {
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      border: none;
      font-family: inherit
    }

    .modal-box .modal-actions .btn-primary {
      background: #000;
      color: #fff
    }

    .modal-box .modal-actions .btn-primary:hover {
      opacity: .9
    }

    .modal-box .modal-actions .btn-secondary {
      background: var(--surface2);
      color: var(--text2);
      border: 1px solid var(--border)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Discounts UX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .discount-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap
    }

    .discount-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: end
    }

    .form-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      display: block;
      margin-bottom: 6px
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: var(--surface)
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12)
    }

    .btn-primary-sm {
      padding: 10px 18px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap
    }

    .btn-ghost {
      padding: 6px 12px;
      border: 1px solid var(--border);
      color: var(--text2);
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px
    }

    .btn-ghost.primary {
      border-color: #2563eb;
      color: #2563eb
    }

    .btn-ghost.warn {
      border-color: #f59e0b;
      color: #f59e0b
    }

    .btn-ghost.danger {
      border-color: #ef4444;
      color: #ef4444
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700
    }

    .pill.active {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #10b981
    }

    .pill.inactive {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #ef4444
    }

    .code-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight: 700;
      letter-spacing: 0.02em
    }

    .muted {
      color: var(--text2)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Modal (CTV usage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .35);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 24px
    }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 960px;
      max-height: 88vh;
      overflow: auto;
      box-shadow: var(--shadow-lg)
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid var(--border)
    }

    .modal-header h2 {
      font-size: 18px;
      font-weight: 700
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface2);
      cursor: pointer;
      font-size: 18px
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid var(--border)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Paste import modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .paste-import-box .paste-import-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .paste-import-box .paste-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text2);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .paste-import-box .paste-tab:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .paste-import-box .paste-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--accent-dim);
    }

    .paste-import-box .tab-content {
      display: none;
    }

    .paste-import-box .tab-content.active {
      display: block;
    }

    .paste-import-box .paste-import-hint {
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 10px
    }

    .paste-import-box .paste-import-hint code {
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid var(--border)
    }

    .paste-import-box #pasteImportText {
      min-height: 140px;
      font-family: monospace;
      font-size: 13px
    }

    .paste-import-box .paste-preview {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text2)
    }

    .paste-import-box .paste-preview .preview-line {
      display: flex;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid var(--border-light)
    }

    .paste-import-box .paste-preview .preview-line .pv-account {
      font-weight: 600;
      color: var(--text);
      min-width: 160px
    }

    .paste-import-box .paste-preview .preview-line .pv-pass {
      font-family: monospace;
      color: var(--text2)
    }

    .paste-import-box .paste-preview .preview-line .pv-2fa {
      font-family: monospace;
      color: var(--accent)
    }

    /* Stock List Table */
    .stock-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .stock-list-table th,
    .stock-list-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }

    .stock-list-table th {
      background: var(--surface2);
      font-weight: 600;
      color: var(--text2);
      font-size: 11px;
      text-transform: uppercase;
    }

    .stock-list-table .col-actions {
      text-align: right;
    }

    .stock-list-table .btn-del {
      color: var(--red);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      font-size: 12px;
    }

    .stock-list-table .btn-del:hover {
      background: var(--red-dim);
      border-color: var(--red);
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1f2937;
      color: #fff;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      transform: translateY(100px);
      opacity: 0;
      transition: all .3s;
      box-shadow: var(--shadow-lg)
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ responsive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media(max-width:640px) {
      .shell {
        flex-direction: column
      }

      .sidebar {
        flex-direction: row;
        width: 100%;
        padding: 12px 16px;
        gap: 8px;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid var(--border)
      }

      .sidebar-logo {
        margin-bottom: 0;
        margin-right: 12px;
        font-size: 16px
      }

      .nav-item {
        padding: 8px 12px;
        border-left: none;
        border-bottom: 2px solid transparent;
        white-space: nowrap
      }

      .nav-item.active {
        border-left-color: transparent;
        border-bottom-color: var(--accent)
      }

      .sidebar-footer {
        display: none
      }

      .main {
        padding: 16px
      }

      .sku-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px
      }

      .sku-card {
        padding: 14px
      }

      .sku-card .sku-icon {
        font-size: 24px
      }

      .order-management .order-stats-row {
        grid-template-columns: repeat(2, 1fr)
      }
    }
  </style>
</head>

<body>

  <!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>TBQ Admin</h2>
      <p>Nh·∫≠p Admin Token ƒë·ªÉ ƒëƒÉng nh·∫≠p</p>
      <input type="password" id="tokenInput" placeholder="Admin token..." onkeydown="if(event.key==='Enter')doLogin()">
      <button onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
      <div class="login-err" id="loginErr"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ SHELL ‚îÄ‚îÄ -->
  <div class="shell" id="shell" style="display:none">

    <!-- sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">TBQ<span>Admin</span></div>
      <div class="nav-item active" onclick="nav('dashboard')"><span class="nav-icon">üìä</span> T·ªïng quan</div>
      <div class="nav-item" onclick="nav('orders')"><span class="nav-icon">üì¶</span> ƒê∆°n h√†ng</div>
      <div class="nav-item" onclick="nav('inventory')"><span class="nav-icon">üìã</span> Kho h√†ng</div>
      <div class="nav-item" onclick="nav('logs')"><span class="nav-icon">üìù</span> Nh·∫≠t k√Ω</div>
      <div class="nav-item" onclick="nav('discounts')"><span class="nav-icon">üè∑Ô∏è</span> M√£ gi·∫£m gi√°</div>
      <div class="sidebar-footer">ƒê·ªìng b·ªô: <span id="lastSync">--</span></div>
    </aside>

    <!-- main -->
    <main class="main">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <h1>T·ªïng quan</h1>
          <button class="refresh-btn" onclick="loadDashboard()">L√†m m·ªõi</button>
        </div>
        <div class="stats-row" id="statsRow">
          <div class="stat-card blue">
            <div class="label">T·ªïng ƒë∆°n</div>
            <div class="value" id="statTotal">--</div>
          </div>
          <div class="stat-card yellow">
            <div class="label">Ch·ªù thanh to√°n</div>
            <div class="value" id="statPending">--</div>
          </div>
          <div class="stat-card green">
            <div class="label">ƒê√£ giao</div>
            <div class="value" id="statFulfilled">--</div>
          </div>
          <div class="stat-card purple">
            <div class="label">Doanh thu</div>
            <div class="value" id="statRevenue">--</div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody id="dashboardOrders">
              <tr>
                <td colspan="5" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ORDERS -->
      <div class="page order-management" id="page-orders">
        <div class="page-header">
          <div>
            <h1>ƒê∆°n h√†ng</h1>
            <p style="color:var(--text2);font-size:13px;margin-top:4px">B·∫•m v√†o ƒë∆°n ƒë·ªÉ xem tk|mk|2fa</p>
          </div>
        </div>
        <div class="order-stats-row">
          <div class="stat-card blue">
            <div class="label">T·ªïng c·ªông</div>
            <div class="value" id="orderStatTotal">--</div>
          </div>
          <div class="stat-card yellow">
            <div class="label">Ch·ªù thanh to√°n</div>
            <div class="value" id="orderStatPending">--</div>
          </div>
          <div class="stat-card green">
            <div class="label">ƒê√£ giao</div>
            <div class="value" id="orderStatDelivered">--</div>
          </div>
          <div class="stat-card red">
            <div class="label">L·ªói / Hu·ª∑</div>
            <div class="value" id="orderStatError">--</div>
          </div>
        </div>
        <div class="order-toolbar">
          <div class="search-wrap" style="position:relative">
            <span
              style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:14px;">üîç</span>
            <input type="text" id="orderSearch" placeholder="T√¨m m√£ ƒë∆°n, email..." oninput="loadOrders()">
          </div>
          <select id="orderStatusFilter" onchange="setOrderTabFromFilter();loadOrders()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="pending_payment">Ch·ªù thanh to√°n</option>
            <option value="paid">ƒê√£ thanh to√°n</option>
            <option value="fulfilled">ƒê√£ giao</option>
            <option value="failed">L·ªói</option>
            <option value="cancelled">Hu·ª∑</option>
            <option value="refunded">Ho√†n ti·ªÅn</option>
            <option value="expired">H·∫øt h·∫°n</option>
          </select>
          <button class="refresh-btn" onclick="loadOrders()">L√†m m·ªõi</button>
        </div>
        <div class="order-tabs">
          <button type="button" class="order-tab active" data-status="" onclick="setOrderTab('')">T·∫•t c·∫£</button>
          <button type="button" class="order-tab" data-status="pending_payment"
            onclick="setOrderTab('pending_payment')">Ch·ªù TT</button>
          <button type="button" class="order-tab" data-status="paid" onclick="setOrderTab('paid')">ƒê√£ TT</button>
          <button type="button" class="order-tab" data-status="fulfilled" onclick="setOrderTab('fulfilled')">ƒê√£
            giao</button>
          <button type="button" class="order-tab" data-status="failed" onclick="setOrderTab('failed')">L·ªói /
            Hu·ª∑</button>
        </div>
        <div class="order-table-wrap table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch</th>
                <th>Email</th>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              <tr>
                <td colspan="9" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="page-inventory">
        <div class="page-header">
          <div>
            <h1>Kho h√†ng</h1>
            <p style="color:var(--text2);font-size:13px;margin-top:4px">B·∫•m v√†o s·∫£n ph·∫©m ƒë·ªÉ nh·∫≠p tk|mk|2fa</p>
          </div>
          <div class="header-right">
            <span id="inventoryStatus" class="inventory-status"></span>
            <button class="refresh-btn" id="inventoryRefreshBtn" onclick="loadInventory()">L√†m m·ªõi</button>
          </div>
        </div>

        <!-- SKU Card Grid -->
        <div class="sku-grid" id="skuGrid">
          <div class="loading" style="grid-column:1/-1">ƒêang t·∫£i...</div>
        </div>

        <!-- Advanced import (collapsed) -->
        <div class="advanced-import">
          <button class="advanced-toggle" id="advancedToggle" onclick="toggleAdvancedImport()">
            <span class="toggle-arrow">&#9654;</span>
            Nh·∫≠p n√¢ng cao (d√°n nhi·ªÅu d√≤ng, ph√¢n t√≠ch t·ª± ƒë·ªông)
          </button>
          <div class="advanced-content" id="advancedContent">
            <div class="quick-import-super">
              <h3>Nh·∫≠p kho n√¢ng cao</h3>
              <p style="color:var(--text2);font-size:13px;margin-bottom:12px;">D√°n nhi·ªÅu d√≤ng <strong>tk|mk|2fa</strong>
                (ho·∫∑c <code>tk:mk</code>, <code>tk mk</code>). H·ªá th·ªëng t·ª± t√°ch, chu·∫©n ho√° v√† ƒë·ªÅ xu·∫•t SKU.</p>
              <textarea id="superPasteRaw" class="paste-area"
                placeholder="user1@mail.com|pass1|2fa1&#10;user2@gmail.com|pass2&#10;user3:pass3:"></textarea>
              <div class="tool-row">
                <label>SKU ∆∞u ti√™n:</label>
                <select id="superProfileSku">
                  <option value="">-- Ch·ªçn SKU --</option>
                </select>
                <button type="button" class="refresh-btn" onclick="doParseStock()"
                  style="background:#000;color:#fff;border:none;">Ph√¢n t√≠ch</button>
              </div>
              <div id="superPreviewWrap" style="display:none;">
                <div class="preview-wrap">
                  <table class="preview-table table-wrap" id="superPreviewTable"></table>
                </div>
                <div class="sku-panel">
                  <span style="color:var(--text2);font-size:13px;">√Åp d·ª•ng SKU cho t·∫•t c·∫£ d√≤ng h·ª£p l·ªá:</span>
                  <select id="superApplySkuSelect"></select>
                  <button type="button" class="refresh-btn" onclick="applySkuToAllValid()"
                    style="background:var(--accent);color:#fff;border:none;">√Åp d·ª•ng</button>
                  <button type="button" class="refresh-btn" onclick="doSuperImport()"
                    style="background:#000;color:#fff;border:none;">Nh·∫≠p l√™n kho</button>
                </div>
                <div id="superImportResult" class="import-result" style="display:none;"></div>
              </div>
              <div id="superParseFeedback" style="font-size:13px;color:var(--text2);"></div>
            </div>
          </div>
        </div>

        <!-- Inventory summary table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>C√≥ s·∫µn</th>
                <th>ƒê√£ b√°n</th>
                <th>ƒê√£ gi·ªØ</th>
                <th>T·ªïng</th>
              </tr>
            </thead>
            <tbody id="inventoryBody">
              <tr>
                <td colspan="5" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Modal: Paste Import / View Stock (click SKU card) -->
      <div id="pasteImportModal" class="modal-overlay" onclick="if(event.target===this)closePasteImportModal()">
        <div class="modal-box paste-import-box" onclick="event.stopPropagation()" style="max-width: 700px;">
          <h4 id="pasteImportTitle" style="margin-bottom: 12px;">Qu·∫£n l√Ω kho</h4>

          <div class="paste-import-tabs">
            <div class="paste-tab active" onclick="switchPasteTab('list')" id="tab-list">Danh s√°ch</div>
            <div class="paste-tab" onclick="switchPasteTab('import')" id="tab-import">Nh·∫≠p h√†ng</div>
          </div>

          <!-- Tab Content: List -->
          <div id="content-list" class="tab-content active">
            <div class="order-toolbar" style="margin-bottom: 12px;">
              <button class="refresh-btn" onclick="loadSkuDetails()">L√†m m·ªõi</button>
              <span id="skuListCount" style="margin-left:auto; font-size:13px; color:var(--text2)"></span>
            </div>
            <div
              style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm);">
              <table class="stock-list-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>T√†i kho·∫£n / Key</th>
                    <th>Ghi ch√∫ / 2FA</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y t·∫°o</th>
                    <th class="col-actions">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="skuDetailsBody">
                  <tr>
                    <td colspan="6" class="loading">ƒêang t·∫£i...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-secondary" onclick="closePasteImportModal()">ƒê√≥ng</button>
            </div>
          </div>

          <!-- Tab Content: Import -->
          <div id="content-import" class="tab-content">
            <p class="paste-import-hint">M·ªói d√≤ng m·ªôt t√†i kho·∫£n. ƒê·ªãnh d·∫°ng: <code>email|m·∫≠t_kh·∫©u|2fa</code> (2fa c√≥ th·ªÉ
              b·ªè tr·ªëng).</p>
            <textarea id="pasteImportText" placeholder="user@mail.com|password123|abc2fa&#10;user2@mail.com|pass2|"
              rows="8" oninput="previewPasteLines()"></textarea>
            <div id="pastePreview" class="paste-preview"></div>
            <div id="pasteImportFeedback" style="font-size:13px;margin-top:8px;min-height:20px;color:var(--text2)">
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-primary" onclick="submitPasteImport()">Nh·∫≠p kho</button>
              <button type="button" class="btn-secondary" onclick="closePasteImportModal()">Hu·ª∑</button>
            </div>
          </div>

        </div>
      </div>

      <!-- AUDIT LOGS -->
      <div class="page" id="page-logs">
        <div class="page-header">
          <h1>Nh·∫≠t k√Ω</h1>
          <button class="refresh-btn" onclick="loadLogs()">L√†m m·ªõi</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>S·ª± ki·ªán</th>
                <th>Lo·∫°i</th>
                <th>ID</th>
                <th>Ngu·ªìn</th>
                <th>Chi ti·∫øt</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody id="logsBody">
              <tr>
                <td colspan="6" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DISCOUNTS PAGE -->
      <div class="page" id="page-discounts">
        <div class="page-header discount-header">
          <h1>M√£ gi·∫£m gi√° CTV</h1>
          <button class="refresh-btn" onclick="loadDiscounts()">L√†m m·ªõi</button>
        </div>

        <!-- Create form -->
        <div class="card" style="margin-bottom:24px; padding:20px;">
          <h3 style="margin:0 0 12px">T·∫°o/ c·∫≠p nh·∫≠t m√£ (CTV01‚ÄìCTV05)</h3>
          <p class="muted" style="margin:0 0 14px; font-size:12px;">M·ªói m√£ g·∫Øn v·ªõi m·ªôt CTV. M√£ ƒë√£ t·ªìn t·∫°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√¥ng tin.</p>
          <div class="discount-form">
            <div class="form-field">
              <label>M√£ code</label>
              <input type="text" id="newDiscountCode" class="form-input" placeholder="CTV01 / CTV02 / CTV03 / CTV04 / CTV05" maxlength="30">
            </div>
            <div class="form-field">
              <label>CTV</label>
              <input type="text" id="newDiscountOwner" class="form-input" placeholder="T√™n ng∆∞·ªùi nh·∫≠n m√£">
            </div>
            <div class="form-field">
              <label>Li√™n h·ªá</label>
              <input type="text" id="newDiscountContact" class="form-input" placeholder="SƒêT/Zalo">
            </div>
            <div class="form-field">
              <label>Gi·∫£m (VND)</label>
              <input type="number" id="newDiscountAmount" class="form-input" value="10000">
            </div>
            <div class="form-field">
              <label>M√¥ t·∫£</label>
              <input type="text" id="newDiscountDesc" class="form-input" placeholder="VD: M√£ CTV Minh">
            </div>
            <div class="form-field">
              <button onclick="createDiscount()" class="btn-primary-sm">+ T·∫°o / c·∫≠p nh·∫≠t</button>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>M√£ code</th>
                <th>CTV</th>
                <th>Li√™n h·ªá</th>
                <th>Gi·∫£m</th>
                <th>M√¥ t·∫£</th>
                <th>Tr·∫°ng th√°i</th>
                <th>ƒê√£ d√πng</th>
                <th>L·∫ßn cu·ªëi</th>
                <th>T·ªïng gi·∫£m</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="discountsBody">
              <tr>
                <td colspan="10" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CTV USAGE MODAL -->
      <div id="ctvUsageModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="ctvUsageTitle">L·ªãch s·ª≠ d√πng m√£</h2>
            <button class="close-btn" onclick="closeCtvUsageModal()">√ó</button>
          </div>
          <div class="table-wrap" style="margin:12px 20px 0;">
            <table>
              <thead>
                <tr>
                  <th>M√£ ƒë∆°n</th>
                  <th>Kh√°ch h√†ng</th>
                  <th>Li√™n h·ªá</th>
                  <th>Gi·∫£m</th>
                  <th>Th√†nh ti·ªÅn</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody id="ctvUsageBody">
                <tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeCtvUsageModal()">ƒê√≥ng</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="globalToast"></div>

  <script>
    // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function resolveBase() {
      const qs = new URLSearchParams(location.search);
      const fromQuery = (qs.get('base') || '').trim();
      if (fromQuery) return fromQuery.replace(/\/+$/, '');
      if (location.protocol === 'file:') return 'http://localhost:8888/.netlify/functions';
      return '/.netlify/functions';
    }

    const BASE = resolveBase();
    let ADMIN_TOKEN = '';
    const POLL_INTERVAL = 10000;
    let pollTimer = null;

    // SKUs to hide from the grid (discontinued)
    var SKU_HIDDEN = { chatgpt_plus_3m: true };

    // SKU metadata
    var SKU_META = {
      chatgpt_plus_1m: { icon: '\u{1F916}', name: 'ChatGPT Plus 1 th√°ng' },
      chatgpt_plus_3m: { icon: '\u{1F916}', name: 'ChatGPT Plus 3 th√°ng (ng·ª´ng b√°n)' },
      chatgpt_code_1m_vn: { icon: '\u{1F4BB}', name: 'Code ChatGPT 1 th√°ng (VN)' },
      grok_7d: { icon: '\u{1F9E0}', name: 'Grok 7 ng√†y' },
      netflix_1m: { icon: '\u{1F3AC}', name: 'Netflix 1 th√°ng' },
      spotify_premium_1m: { icon: '\u{1F3B5}', name: 'Spotify Premium 1 th√°ng' },
      youtube_premium_1m: { icon: '\u{25B6}\u{FE0F}', name: 'YouTube Premium 1 th√°ng' },
      canva_pro_1y: { icon: '\u{1F3A8}', name: 'Canva Pro 1 nƒÉm' },
      capcut_pro_1y: { icon: '\u{1F3AC}', name: 'CapCut Pro 1 nƒÉm' },
      capcut_7d: { icon: '\u{1F3AC}', name: 'CapCut 7 ng√†y' },
      capcut_14d: { icon: '\u{1F3AC}', name: 'CapCut 14 ng√†y' },
      capcut_1m: { icon: '\u{1F3AC}', name: 'CapCut Pro 1 th√°ng' },
      capcut_6m: { icon: '\u{1F3AC}', name: 'CapCut Pro 6 th√°ng' },
      adobe_1m: { icon: '\u{1F58C}\u{FE0F}', name: 'Adobe 1 th√°ng' },
      microsoft365_1y: { icon: '\u{1F4BC}', name: 'Microsoft 365 1 nƒÉm' },
      duolingo_1m: { icon: '\u{1F989}', name: 'Duolingo Plus 1 th√°ng' },
      quizlet_1m: { icon: '\u{1F4DA}', name: 'Quizlet Plus 1 th√°ng' }
    };

    // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function doLogin() {
      var t = document.getElementById('tokenInput').value.trim();
      if (!t) return;
      try {
        var r = await fetch(BASE + '/admin-orders', { headers: { Authorization: 'Bearer ' + t } });
        if (r.status === 401) {
          document.getElementById('loginErr').textContent = 'Token kh√¥ng h·ª£p l·ªá';
          return;
        }
        ADMIN_TOKEN = t;
        sessionStorage.setItem('tbq_admin_token', t);
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('shell').style.display = 'flex';
        startAutoRefresh();
        loadDashboard();
      } catch (e) {
        var hint = (location.protocol === 'file:')
          ? 'B·∫°n ƒëang m·ªü b·∫±ng file://. H√£y ch·∫°y "netlify dev" v√† m·ªü admin t·∫°i http://localhost:8888/admin.html.'
          : 'Ki·ªÉm tra m·∫°ng / endpoint Netlify Functions.';
        document.getElementById('loginErr').textContent = 'Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. (' + hint + ')';
      }
    }

    // Auto-restore session
    (function () {
      var saved = sessionStorage.getItem('tbq_admin_token');
      if (saved) ADMIN_TOKEN = saved;
    })();

    // ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function nav(page) {
      document.querySelectorAll('.nav-item').forEach(function (n) { n.classList.remove('active'); });
      event.currentTarget.classList.add('active');
      document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
      document.getElementById('page-' + page).classList.add('active');
      var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs, discounts: loadDiscounts };
      if (loaders[page]) loaders[page]();
    }

    // ‚îÄ‚îÄ AUTO REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startAutoRefresh() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(function () {
        var active = document.querySelector('.page.active');
        if (!active) return;
        var id = active.id.replace('page-', '');
        var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs, discounts: loadDiscounts };
        if (loaders[id]) loaders[id]();
      }, POLL_INTERVAL);
    }

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function authHeaders() {
      return { Authorization: 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' };
    }
    function fmtTime(iso) {
      if (!iso) return '--';
      try { return new Date(iso).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'medium' }); } catch (e) { return iso; }
    }
    function fmtVND(n) { return (Number(n) || 0).toLocaleString('vi-VN') + '‚Ç´'; }
    function badgeClass(s) {
      var map = {
        pending_payment: 'badge-pending', paid: 'badge-paid', fulfilled: 'badge-fulfilled',
        failed: 'badge-failed', cancelled: 'badge-cancelled', expired: 'badge-expired', refunded: 'badge-refunded'
      };
      return map[s] || 'badge-pending';
    }
    function badgeLabel(s) {
      var map = { pending_payment: 'Ch·ªù TT', paid: 'ƒê√£ TT', fulfilled: 'ƒê√£ giao', failed: 'L·ªói', cancelled: 'Hu·ª∑', expired: 'H·∫øt h·∫°n', refunded: 'Ho√†n ti·ªÅn' };
      return map[s] || s;
    }
    function escHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function escAttr(s) { return String(s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
    function updateClock() { document.getElementById('lastSync').textContent = new Date().toLocaleTimeString('vi-VN'); }

    function showToast(msg) {
      var t = document.getElementById('globalToast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(function () { t.classList.remove('show'); }, 2500);
    }

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () { showToast('ƒê√£ sao ch√©p!'); });
      }
    }

    function getSkuName(code) {
      var m = SKU_META[code];
      return m ? m.name : code;
    }
    function getSkuIcon(code) {
      var m = SKU_META[code];
      return m ? m.icon : '\u{1F4E6}';
    }

    // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        var r = await fetch(BASE + '/admin-orders?limit=10', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var s = data.stats || {};
        document.getElementById('statTotal').textContent = s.total || 0;
        document.getElementById('statPending').textContent = s.pending || 0;
        document.getElementById('statFulfilled').textContent = s.delivered || s.fulfilled || 0;
        document.getElementById('statRevenue').textContent = fmtVND(s.total_revenue || 0);

        var rows = data.orders || [];
        document.getElementById('dashboardOrders').innerHTML = rows.length
          ? rows.map(function (o) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(o.order_code) + '</td>' +
              '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
              '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
              '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
              '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="5" class="empty">Ch∆∞a c√≥ ƒë∆°n n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] dashboard', e); }
    }

    // ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _expandedOrder = null;
    var _orderCredCache = {};

    function setOrderTab(status) {
      document.getElementById('orderStatusFilter').value = status || '';
      document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
        t.classList.toggle('active', (t.dataset.status || '') === (status || ''));
      });
      loadOrders();
    }

    function setOrderTabFromFilter() {
      var v = document.getElementById('orderStatusFilter').value;
      document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
        t.classList.toggle('active', (t.dataset.status || '') === (v || ''));
      });
    }

    async function loadOrders() {
      try {
        var status = document.getElementById('orderStatusFilter').value;
        var search = document.getElementById('orderSearch').value.trim();
        var url = BASE + '/admin-orders?limit=200';
        if (status) url += '&status=' + status;

        var r = await fetch(url, { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();

        var stats = data.stats || {};
        document.getElementById('orderStatTotal').textContent = stats.total != null ? stats.total : '--';
        document.getElementById('orderStatPending').textContent = stats.pending != null ? stats.pending : '--';
        document.getElementById('orderStatDelivered').textContent = stats.delivered != null ? stats.delivered : '--';
        var errCount = (stats.error_count || 0) + (stats.expired || 0);
        document.getElementById('orderStatError').textContent = errCount;

        var rows = data.orders || [];
        var byCode = {};
        rows.forEach(function (o) {
          var code = o.order_code || o.id || '';
          if (!code) return;
          if (!byCode[code]) byCode[code] = { order: o, products: [] };
          if (o.product_name && byCode[code].products.indexOf(o.product_name) === -1) byCode[code].products.push(o.product_name);
        });
        var list = Object.keys(byCode).map(function (code) {
          var rec = byCode[code].order;
          if (!rec.order_code) rec.order_code = code;
          return rec;
        });

        if (search) {
          var q = search.toLowerCase();
          list = list.filter(function (o) {
            return (o.order_code || '').toLowerCase().includes(q) ||
              (o.customer_email || o.customerEmail || '').toLowerCase().includes(q) ||
              (o.customer_name || o.customerName || '').toLowerCase().includes(q);
          });
        }

        var deliveryBase = (location.protocol === 'file:' ? 'http://localhost:8888' : location.origin) + (location.protocol === 'file:' ? '' : location.pathname.replace(/admin\.html.*$/, ''));

        var html = '';
        list.forEach(function (o, i) {
          var products = (byCode[o.order_code] && byCode[o.order_code].products && byCode[o.order_code].products.length)
            ? byCode[o.order_code].products.join(', ') : (o.product_name || '--');
          var deliveryUrl = o.delivery_token ? (deliveryBase + '/.netlify/functions/delivery?token=' + encodeURIComponent(o.delivery_token) + '&order=' + encodeURIComponent(o.order_code)) : '';
          var actionHtml = deliveryUrl
            ? '<a href="' + deliveryUrl + '" target="_blank" class="btn-link">Giao h√†ng</a>'
            : '<span style="color:var(--text-muted)">--</span>';

          var isExpanded = _expandedOrder === o.order_code;
          html += '<tr style="cursor:pointer" onclick="toggleOrderDetail(\'' + escAttr(o.order_code) + '\', this)">' +
            '<td>' + (i + 1) + '</td>' +
            '<td class="col-code">' + escHtml(o.order_code) + '</td>' +
            '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
            '<td style="color:var(--text2)">' + escHtml(o.customer_email || o.customerEmail || '--') + '</td>' +
            '<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis" title="' + escAttr(products) + '">' + escHtml(products) + '</td>' +
            '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
            '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
            '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td>' +
            '<td class="col-actions" onclick="event.stopPropagation()">' + actionHtml + '</td></tr>';

          // Detail row (hidden by default)
          html += '<tr class="order-detail-row" id="detail-' + escAttr(o.order_code) + '" style="display:' + (isExpanded ? 'table-row' : 'none') + '">' +
            '<td colspan="9"><div class="order-detail-panel" id="detail-panel-' + escAttr(o.order_code) + '">' +
            (isExpanded ? '' : '<div class="cred-loading">ƒêang t·∫£i...</div>') +
            '</div></td></tr>';
        });

        document.getElementById('ordersBody').innerHTML = html || '<tr><td colspan="9" class="empty">Kh√¥ng c√≥ ƒë∆°n n√†o</td></tr>';

        // Re-load expanded order detail if any
        if (_expandedOrder && _orderCredCache[_expandedOrder]) {
          renderOrderDetail(_expandedOrder, _orderCredCache[_expandedOrder]);
        }

        updateClock();
      } catch (e) { console.error('[admin] orders', e); }
    }

    async function toggleOrderDetail(orderCode, rowEl) {
      var detailRow = document.getElementById('detail-' + orderCode);
      if (!detailRow) return;

      if (_expandedOrder === orderCode) {
        // Collapse
        detailRow.style.display = 'none';
        _expandedOrder = null;
        return;
      }

      // Collapse previous
      if (_expandedOrder) {
        var prev = document.getElementById('detail-' + _expandedOrder);
        if (prev) prev.style.display = 'none';
      }

      _expandedOrder = orderCode;
      detailRow.style.display = 'table-row';

      // Check cache
      if (_orderCredCache[orderCode]) {
        renderOrderDetail(orderCode, _orderCredCache[orderCode]);
        return;
      }

      // Fetch
      var panel = document.getElementById('detail-panel-' + orderCode);
      if (panel) panel.innerHTML = '<div class="cred-loading">ƒêang t·∫£i th√¥ng tin t√†i kho·∫£n...</div>';

      try {
        var r = await fetch(BASE + '/admin-orders?action=order_detail&order_code=' + encodeURIComponent(orderCode), { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        _orderCredCache[orderCode] = data;
        renderOrderDetail(orderCode, data);
      } catch (e) {
        if (panel) panel.innerHTML = '<div class="cred-loading" style="color:var(--red)">L·ªói t·∫£i d·ªØ li·ªáu: ' + escHtml(e.message) + '</div>';
      }
    }

    function renderOrderDetail(orderCode, data) {
      var panel = document.getElementById('detail-panel-' + orderCode);
      if (!panel) return;

      var creds = data.credentials || [];
      var lines = data.lines || [];

      if (creds.length === 0 && lines.length === 0) {
        panel.innerHTML = '<div class="cred-empty">Kh√¥ng c√≥ th√¥ng tin t√†i kho·∫£n (ƒë∆°n ƒë·∫∑t tr∆∞·ªõc ho·∫∑c ch∆∞a nh·∫≠p kho)</div>';
        return;
      }

      var html = '';

      // Show order lines info
      if (lines.length > 0) {
        html += '<div style="margin-bottom:12px;font-size:13px;color:var(--text2)">S·∫£n ph·∫©m: ' +
          lines.map(function (l) { return '<strong>' + escHtml(l.sku_name || l.product_name || l.sku_code || '--') + '</strong>'; }).join(', ') +
          '</div>';
      }

      if (creds.length === 0) {
        html += '<div class="cred-empty">Ch∆∞a c√≥ t√†i kho·∫£n ƒë∆∞·ª£c g√°n cho ƒë∆°n n√†y</div>';
      } else {
        html += '<div class="cred-cards">';
        creds.forEach(function (c, idx) {
          var note = c.note || '';
          var twofa = '';
          // Extract 2FA from note if present
          if (note.indexOf('2FA:') === 0) {
            var parts = note.split('|');
            twofa = parts[0].replace('2FA:', '').trim();
            note = parts.slice(1).join('|').trim();
          } else if (note && !note.includes(' ') && note.length < 40) {
            twofa = note;
            note = '';
          }

          html += '<div class="cred-card">' +
            '<div class="cred-sku">' + escHtml(c.sku_name || c.sku_code || 'T√†i kho·∫£n ' + (idx + 1)) +
            ' <span class="badge ' + (c.stock_status === 'sold' ? 'badge-fulfilled' : c.stock_status === 'reserved' ? 'badge-paid' : 'badge-pending') + '" style="font-size:10px;padding:2px 8px">' + escHtml(c.stock_status || '--') + '</span></div>' +
            '<div class="cred-field">' +
            '<span class="cred-label">TK</span>' +
            '<span class="cred-value">' + escHtml(c.account_info || '--') + '</span>' +
            '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.account_info || '') + '\')">üìã</button>' +
            '</div>' +
            '<div class="cred-field">' +
            '<span class="cred-label">MK</span>' +
            '<span class="cred-value blurred" id="mk-' + orderCode + '-' + idx + '" onclick="this.classList.remove(\'blurred\')">' + escHtml(c.secret_key || '--') + '</span>' +
            '<button class="cred-btn" onclick="event.stopPropagation();document.getElementById(\'mk-' + orderCode + '-' + idx + '\').classList.remove(\'blurred\')" title="Hi·ªán">üëÅ</button>' +
            '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.secret_key || '') + '\')">üìã</button>' +
            '</div>';

          if (twofa) {
            html += '<div class="cred-field">' +
              '<span class="cred-label">2FA</span>' +
              '<span class="cred-value" style="color:var(--accent)">' + escHtml(twofa) + '</span>' +
              '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(twofa) + '\')">üìã</button>' +
              '</div>';
          }

          if (note) {
            html += '<div class="cred-field">' +
              '<span class="cred-label" style="min-width:auto">Note</span>' +
              '<span class="cred-value" style="font-family:inherit;font-size:12px;color:var(--text2)">' + escHtml(note) + '</span>' +
              '</div>';
          }

          html += '</div>';
        });
        html += '</div>';

        // Copy all button
        html += '<button style="margin-top:10px;padding:6px 14px;border-radius:6px;font-size:12px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-family:inherit" onclick="event.stopPropagation();copyAllCreds(\'' + escAttr(orderCode) + '\')">üìã Sao ch√©p t·∫•t c·∫£</button>';
      }

      panel.innerHTML = html;
    }

    function copyAllCreds(orderCode) {
      var data = _orderCredCache[orderCode];
      if (!data || !data.credentials) return;
      var text = data.credentials.map(function (c, i) {
        var note = c.note || '';
        var twofa = '';
        if (note.indexOf('2FA:') === 0) {
          var parts = note.split('|');
          twofa = parts[0].replace('2FA:', '').trim();
        } else if (note && !note.includes(' ') && note.length < 40) {
          twofa = note;
        }
        return 'TK: ' + (c.account_info || '') + '\nMK: ' + (c.secret_key || '') + (twofa ? '\n2FA: ' + twofa : '');
      }).join('\n---\n');
      copyText(text);
    }

    // ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setInventoryStatus(msg, isError) {
      var el = document.getElementById('inventoryStatus');
      if (el) { el.textContent = msg; el.className = 'inventory-status' + (isError ? ' error' : ''); }
    }

    async function loadInventory() {
      var btn = document.getElementById('inventoryRefreshBtn');
      setInventoryStatus('ƒêang t·∫£i...');
      if (btn) btn.disabled = true;
      try {
        var r = await fetch(BASE + '/inventory?action=all');
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        var data = await r.json();
        var rows = data.inventory || [];
        window._lastInventoryRows = rows;

        // Render SKU card grid (only auto delivery = giao lien)
        renderSkuGrid(rows);

        // Populate advanced import SKU dropdown
        populateSkuDropdown(rows);

        // Render summary table (exclude hidden SKUs)
        var visibleRows = rows.filter(function (r) { return !SKU_HIDDEN[(r.sku || r.product_code || '').trim()]; });
        document.getElementById('inventoryBody').innerHTML = visibleRows.length
          ? visibleRows.map(function (i) {
            var avail = i.available || i.available_units || 0;
            var isPreorder = (i.delivery_type || 'auto') === 'owner_upgrade';
            return '<tr>' +
              '<td style="font-weight:600">' + escHtml(i.sku || i.code || i.product_code) + '</td>' +
              '<td style="color:var(--green);font-weight:600">' + (isPreorder ? 'N/A' : avail) + '</td>' +
              '<td style="color:var(--red)">' + (i.sold_units || i.sold || 0) + '</td>' +
              '<td style="color:var(--yellow)">' + (i.reserved_units || i.reserved || 0) + '</td>' +
              '<td>' + (i.total || i.total_units || 0) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="5" class="empty">Ch∆∞a c√≥ h√†ng trong kho</td></tr>';

        setInventoryStatus('');
        updateClock();
      } catch (e) {
        console.error('[admin] inventory', e);
        setInventoryStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c. Ch·∫°y netlify dev v√† m·ªü http://localhost:8888/admin.html', true);
      }
      if (btn) btn.disabled = false;
    }

    function renderSkuGrid(rows) {
      var grid = document.getElementById('skuGrid');
      if (!grid) return;

      // Filter to only auto delivery (giao lien) SKUs, exclude hidden
      var autoSkus = rows.filter(function (r) {
        var sku = (r.sku || r.product_code || '').trim();
        return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku];
      });

      if (autoSkus.length === 0) {
        grid.innerHTML = '<div class="empty" style="grid-column:1/-1">Ch∆∞a c√≥ SKU giao li·ªÅn n√†o</div>';
        return;
      }

      // Sort: out of stock first, then by name
      autoSkus.sort(function (a, b) {
        var aAvail = a.available || 0;
        var bAvail = b.available || 0;
        if (aAvail === 0 && bAvail > 0) return -1;
        if (aAvail > 0 && bAvail === 0) return 1;
        return (getSkuName(a.sku || a.product_code) || '').localeCompare(getSkuName(b.sku || b.product_code) || '');
      });

      grid.innerHTML = autoSkus.map(function (r) {
        var sku = r.sku || r.product_code || '';
        var avail = r.available || 0;
        var total = r.total || 0;
        var stockClass = avail === 0 ? 'out-of-stock' : avail <= 3 ? 'low-stock' : 'in-stock';

        return '<div class="sku-card ' + stockClass + '" onclick="openPasteImportForSku(\'' + escAttr(sku) + '\')">' +
          '<div class="sku-icon">' + getSkuIcon(sku) + '</div>' +
          '<div class="sku-name">' + escHtml(getSkuName(sku)) + '</div>' +
          '<div class="sku-code">' + escHtml(sku) + '</div>' +
          '<div class="sku-stock">' +
          '<span class="sku-stock-count">' + avail + '</span>' +
          '<span class="sku-stock-label">c√≥ s·∫µn / ' + total + ' t·ªïng</span>' +
          '</div>' +
          '<div class="sku-import-hint">+ Nh·∫≠p kho</div>' +
          '</div>';
      }).join('');
    }

    function populateSkuDropdown(rows) {
      var sel = document.getElementById('superProfileSku');
      if (!sel) return;
      var autoSkus = rows.filter(function (r) { var sku = (r.sku || r.product_code || '').trim(); return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku]; });
      sel.innerHTML = '<option value="">-- Ch·ªçn SKU --</option>' +
        autoSkus.map(function (r) {
          var sku = r.sku || r.product_code || '';
          return '<option value="' + escAttr(sku) + '">' + escHtml(getSkuName(sku)) + '</option>';
        }).join('');
    }

    // ‚îÄ‚îÄ PASTE IMPORT / VIEW STOCK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window._pasteImportSku = '';

    function openPasteImportForSku(skuCode) {
      window._pasteImportSku = skuCode;
      document.getElementById('pasteImportTitle').textContent = 'Qu·∫£n l√Ω kho: ' + getSkuName(skuCode);

      // Reset tabs
      switchPasteTab('list');

      document.getElementById('pasteImportModal').classList.add('show');
    }

    function closePasteImportModal() {
      document.getElementById('pasteImportModal').classList.remove('show');
      window._pasteImportSku = '';
    }

    function switchPasteTab(tab) {
      document.querySelectorAll('.paste-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('content-' + tab).classList.add('active');

      if (tab === 'list') {
        loadSkuDetails();
      } else if (tab === 'import') {
        document.getElementById('pasteImportText').value = '';
        document.getElementById('pasteImportFeedback').textContent = '';
        document.getElementById('pastePreview').innerHTML = '';
        setTimeout(() => document.getElementById('pasteImportText').focus(), 100);
      }
    }

    async function loadSkuDetails() {
      if (!window._pasteImportSku) return;
      const tbody = document.getElementById('skuDetailsBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">ƒêang t·∫£i...</td></tr>';
      document.getElementById('skuListCount').textContent = '';

      try {
        const r = await fetch(BASE + '/admin-inventory?action=sku_details&sku=' + window._pasteImportSku, { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        const data = await r.json();
        const items = data.items || [];

        document.getElementById('skuListCount').textContent = items.length + ' m·ª•c';

        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">Ch∆∞a c√≥ h√†ng trong kho</td></tr>';
          return;
        }

        tbody.innerHTML = items.map((item, i) => {
          const isSold = item.status === 'sold';
          const statusClass = item.status === 'available' ? 'badge-fulfilled' : (isSold ? 'badge-cancelled' : 'badge-pending');
          const statusLabel = item.status === 'available' ? 'S·∫µn s√†ng' : (isSold ? 'ƒê√£ b√°n' : 'ƒêang gi·ªØ');

          // Note logic
          let note = item.note || '';
          let twofa = '';
          if (note.indexOf('2FA:') === 0) {
            const parts = note.split('|');
            twofa = parts[0].replace('2FA:', '').trim();
            note = parts.slice(1).join('|').trim();
          } else if (note && !note.includes(' ') && note.length < 40) {
            twofa = note;
            note = '';
          }
          const displayNote = (twofa ? '<span style="color:var(--accent);font-family:monospace">2FA: ' + escHtml(twofa) + '</span>' : '') +
            (note ? (twofa ? '<br>' : '') + '<span style="color:var(--text2)">' + escHtml(note) + '</span>' : '');

          // Sold info
          const soldInfo = isSold && item.order_code ? '<div style="font-size:11px;color:var(--text2)">ƒê∆°n: ' + escHtml(item.order_code) + '</div>' : '';

          // Actions: Delete only available items
          const actionHtml = item.status === 'available'
            ? '<button class="btn-del" onclick="deleteStockItem(\'' + item.id + '\')">Xo√°</button>'
            : '<span style="color:var(--text-muted);font-size:11px">--</span>';

          return `
                <tr>
                    <td>${i + 1}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${escAttr(item.account_info)}">
                        <div style="font-weight:600">${escHtml(item.account_info)}</div>
                        <div style="font-family:monospace;color:var(--text2);font-size:11px">
                             <span class="blurred" onclick="this.classList.remove('blurred')">${escHtml(item.secret_key || '--')}</span>
                             <button style="border:none;background:none;cursor:pointer;opacity:0.6" onclick="copyText('${escAttr(item.secret_key)}')">üìã</button>
                        </div>
                    </td>
                    <td>${displayNote || '--'}</td>
                    <td>
                        <span class="badge ${statusClass}" style="padding:2px 8px;font-size:10px">${statusLabel}</span>
                        ${soldInfo}
                    </td>
                    <td style="color:var(--text2);font-size:11px">${fmtTime(item.created_at)}</td>
                    <td class="col-actions">${actionHtml}</td>
                </tr>
            `;
        }).join('');

      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" class="loading" style="color:var(--red)">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
      }
    }

    async function deleteStockItem(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° m·ª•c n√†y kh·ªèi kho?')) return;
      try {
        const r = await fetch(BASE + '/admin-inventory?action=delete_item', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ id: id })
        });
        const data = await r.json();
        if (data.success) {
          showToast('ƒê√£ xo√° th√†nh c√¥ng');
          loadSkuDetails(); // Reload list
          loadInventory();   // Reload summaries
        } else {
          alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ xo√°'));
        }
      } catch (e) {
        alert('L·ªói m·∫°ng: ' + e.message);
      }
    }

    function parsePasteLines(text) {
      return text.split(/\n/).map(function (line) {
        var trimmed = line.trim();
        if (!trimmed) return null;
        // Support: pipe, colon, tab, multiple spaces
        var parts = trimmed.split(/[|:\t]+/);
        if (parts.length < 2) {
          // Try splitting by 2+ spaces
          parts = trimmed.split(/\s{2,}/);
        }
        return {
          account_info: (parts[0] || '').trim(),
          secret_key: (parts[1] || '').trim(),
          note: (parts[2] || '').trim()
        };
      }).filter(function (row) { return row && row.account_info !== ''; });
    }

    function previewPasteLines() {
      var text = (document.getElementById('pasteImportText').value || '').trim();
      var previewEl = document.getElementById('pastePreview');
      if (!text) { previewEl.innerHTML = ''; return; }

      var rows = parsePasteLines(text);
      if (rows.length === 0) { previewEl.innerHTML = ''; return; }

      var html = '<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">' + rows.length + ' t√†i kho·∫£n</div>';
      rows.slice(0, 10).forEach(function (r) {
        html += '<div class="preview-line">' +
          '<span class="pv-account">' + escHtml(r.account_info) + '</span>' +
          '<span class="pv-pass">' + (r.secret_key ? '******' : '--') + '</span>' +
          (r.note ? '<span class="pv-2fa">' + escHtml(r.note) + '</span>' : '') +
          '</div>';
      });
      if (rows.length > 10) {
        html += '<div style="color:var(--text-muted);font-size:11px;padding:4px 0">... v√† ' + (rows.length - 10) + ' d√≤ng n·ªØa</div>';
      }
      previewEl.innerHTML = html;
    }

    async function submitPasteImport() {
      var sku = window._pasteImportSku;
      if (!sku) return;
      var raw = (document.getElementById('pasteImportText').value || '').trim();
      var fb = document.getElementById('pasteImportFeedback');
      if (!raw) { fb.textContent = 'D√°n √≠t nh·∫•t m·ªôt d√≤ng tk|mk|2fa.'; fb.style.color = 'var(--yellow)'; return; }

      var rows = parsePasteLines(raw);
      if (rows.length === 0) { fb.textContent = 'M·ªói d√≤ng c·∫ßn c√≥ √≠t nh·∫•t ph·∫ßn t√†i kho·∫£n.'; fb.style.color = 'var(--yellow)'; return; }

      fb.textContent = 'ƒêang nh·∫≠p ' + rows.length + ' d√≤ng...';
      fb.style.color = 'var(--text2)';

      var items = rows.map(function (r) {
        var note = r.note ? ('2FA: ' + r.note) : '';
        return { sku_code: sku, account_info: r.account_info, secret_key: r.secret_key, note: note };
      });

      try {
        var r = await fetch(BASE + '/import-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { fb.textContent = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i.'; fb.style.color = 'var(--red)'; return; }
        if (!r.ok) { fb.textContent = 'L·ªói: ' + (data.error || data.message || r.status); fb.style.color = 'var(--red)'; return; }

        fb.style.color = 'var(--green)';
        fb.textContent = 'ƒê√£ th√™m ' + (data.inserted || 0) + ', tr√πng ' + (data.skipped_duplicate || 0) + '.';
        showToast('ƒê√£ nh·∫≠p ' + (data.inserted || 0) + ' t√†i kho·∫£n v√†o ' + getSkuName(sku));
        loadInventory();
        document.getElementById('pasteImportText').value = '';
        document.getElementById('pastePreview').innerHTML = '';
        setTimeout(closePasteImportModal, 1200);
      } catch (e) {
        fb.textContent = 'L·ªói m·∫°ng: ' + e.message;
        fb.style.color = 'var(--red)';
      }
    }

    // ‚îÄ‚îÄ ADVANCED IMPORT (toggle) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleAdvancedImport() {
      var btn = document.getElementById('advancedToggle');
      var content = document.getElementById('advancedContent');
      btn.classList.toggle('open');
      content.classList.toggle('show');
    }

    // ‚îÄ‚îÄ NHAP KHO SIEU NHANH (parse -> preview -> import) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var LAST_USED_SKU_KEY = 'tbq_last_used_sku';
    var _superParsedRows = [];

    async function doParseStock() {
      var raw = (document.getElementById('superPasteRaw') && document.getElementById('superPasteRaw').value) ? document.getElementById('superPasteRaw').value.trim() : '';
      var fb = document.getElementById('superParseFeedback');
      if (!raw) { if (fb) fb.textContent = 'D√°n d·ªØ li·ªáu (tk|mk|2fa) v√†o √¥ tr√™n r·ªìi b·∫•m Ph√¢n t√≠ch.'; return; }
      if (fb) fb.textContent = 'ƒêang ph√¢n t√≠ch...';
      var profileSku = (document.getElementById('superProfileSku') && document.getElementById('superProfileSku').value) || '';
      var lastUsedSku = localStorage.getItem(LAST_USED_SKU_KEY) || '';
      try {
        var r = await fetch(BASE + '/parse-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ raw: raw, last_used_sku: lastUsedSku || undefined, profile_sku: profileSku || undefined })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { if (fb) fb.textContent = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i.'; return; }
        if (!r.ok) { if (fb) fb.textContent = 'L·ªói: ' + (data.error || r.status); return; }
        _superParsedRows = data.rows || [];
        if (fb) fb.textContent = 'ƒê√£ ph√¢n t√≠ch: ' + (data.summary && data.summary.valid) + ' h·ª£p l·ªá, ' + (data.summary && data.summary.error) + ' l·ªói.';
        renderSuperPreviewTable();
        document.getElementById('superPreviewWrap').style.display = 'block';
        fillSuperApplySkuSelect();
      } catch (e) {
        if (fb) fb.textContent = 'L·ªói: ' + e.message;
      }
    }

    function fillSuperApplySkuSelect() {
      var sel = document.getElementById('superApplySkuSelect');
      if (!sel) return;
      var codes = new Set();
      _superParsedRows.forEach(function (row) {
        (row.suggested_skus || []).forEach(function (s) { codes.add(s.sku_code); });
      });
      var opts = Array.from(codes).sort();
      sel.innerHTML = '<option value="">-- Ch·ªçn SKU --</option>' + opts.map(function (c) {
        return '<option value="' + escAttr(c) + '">' + escHtml(getSkuName(c)) + '</option>';
      }).join('');
    }

    function renderSuperPreviewTable() {
      var tbody = document.getElementById('superPreviewTable');
      if (!tbody) return;
      var rows = _superParsedRows;
      if (!rows.length) { tbody.innerHTML = '<tbody><tr><td class="empty">Kh√¥ng c√≥ d√≤ng n√†o</td></tr></tbody>'; return; }
      var thead = '<thead><tr><th></th><th>#</th><th>T√†i kho·∫£n</th><th>M·∫≠t kh·∫©u</th><th>2FA</th><th>SKU</th><th>Tr·∫°ng th√°i</th></tr></thead>';
      var bodyRows = rows.map(function (row, i) {
        var suggested = row.suggested_skus || [];
        var top = suggested[0];
        var selected = row.selected_sku || (top && top.sku_code) || '';
        var opts = suggested.map(function (s) {
          return '<option value="' + escAttr(s.sku_code) + '"' + (s.sku_code === selected ? ' selected' : '') + '>' + getSkuName(s.sku_code) + ' (' + (s.confidence || 0) + '%)</option>';
        }).join('');
        if (selected && suggested.every(function (s) { return s.sku_code !== selected; })) {
          opts = '<option value="' + escAttr(selected) + '" selected>' + getSkuName(selected) + '</option>' + opts;
        }
        var statusCls = row.status === 'valid' ? 'row-status-valid' : 'row-status-error';
        var statusText = row.status === 'valid' ? 'OK' : (row.error || 'L·ªói');
        var cb = row.status === 'valid' ? '<input type="checkbox" class="super-row-cb" data-index="' + i + '" checked>' : '';
        return '<tr data-index="' + i + '">' +
          '<td>' + cb + '</td>' +
          '<td>' + (row.rowIndex || i + 1) + '</td>' +
          '<td class="col-account" title="' + escAttr(row.account) + '">' + escHtml(row.account) + '</td>' +
          '<td class="col-secret masked">********</td>' +
          '<td>' + (row.twofa || '--') + '</td>' +
          '<td><select class="super-sku-select" data-index="' + i + '">' + opts + '</select></td>' +
          '<td class="' + statusCls + '">' + statusText + '</td></tr>';
      }).join('');
      tbody.innerHTML = thead + '<tbody>' + bodyRows + '</tbody>';
      tbody.querySelectorAll('.super-sku-select').forEach(function (sel) {
        sel.addEventListener('change', function () {
          var idx = parseInt(sel.dataset.index, 10);
          if (_superParsedRows[idx]) _superParsedRows[idx].selected_sku = sel.value;
        });
      });
    }

    function applySkuToAllValid() {
      var sel = document.getElementById('superApplySkuSelect');
      var sku = sel && sel.value ? sel.value.trim() : '';
      if (!sku) return;
      _superParsedRows.forEach(function (row) {
        if (row.status === 'valid') row.selected_sku = sku;
      });
      renderSuperPreviewTable();
    }

    async function doSuperImport() {
      var validRows = _superParsedRows.filter(function (r) { return r.status === 'valid'; });
      var items = validRows.map(function (row) {
        var sku = row.selected_sku || (row.suggested_skus && row.suggested_skus[0] && row.suggested_skus[0].sku_code) || '';
        var note = row.twofa ? ('2FA: ' + row.twofa + (row.notes ? ' | ' + row.notes : '')) : (row.notes || '');
        return { sku_code: sku, account_info: row.account, secret_key: row.password || '', note: note };
      }).filter(function (item) { return item.sku_code; });
      if (items.length === 0) {
        var resEl = document.getElementById('superImportResult');
        if (resEl) { resEl.style.display = 'block'; resEl.innerHTML = 'Ch·ªçn SKU cho √≠t nh·∫•t m·ªôt d√≤ng h·ª£p l·ªá.'; }
        return;
      }
      var resEl = document.getElementById('superImportResult');
      if (resEl) { resEl.style.display = 'block'; resEl.textContent = 'ƒêang nh·∫≠p ' + items.length + ' d√≤ng...'; }
      try {
        var r = await fetch(BASE + '/import-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { if (resEl) resEl.innerHTML = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i.'; return; }
        if (!r.ok) { if (resEl) resEl.innerHTML = 'L·ªói: ' + (data.error || data.message || r.status); return; }
        if (items[0] && items[0].sku_code) localStorage.setItem(LAST_USED_SKU_KEY, items[0].sku_code);
        if (resEl) resEl.innerHTML = 'ƒê√£ th√™m <strong>' + (data.inserted || 0) + '</strong>, tr√πng <strong>' + (data.skipped_duplicate || 0) + '</strong>' + (data.errors && data.errors.length ? ', l·ªói: ' + data.errors.length : '') + '.';
        showToast('ƒê√£ nh·∫≠p ' + (data.inserted || 0) + ' t√†i kho·∫£n');
        loadInventory();
      } catch (e) {
        if (resEl) resEl.innerHTML = 'L·ªói m·∫°ng: ' + e.message;
      }
    }

    // ‚îÄ‚îÄ AUDIT LOGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLogs() {
      try {
        var r = await fetch(BASE + '/webhook-logs?limit=50', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var rows = data.logs || [];
        document.getElementById('logsBody').innerHTML = rows.length
          ? rows.map(function (l) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(l.event_type || l.event || '--') + '</td>' +
              '<td>' + escHtml(l.entity_type || '--') + '</td>' +
              '<td>' + escHtml(l.entity_id || l.order_id || '--') + '</td>' +
              '<td style="color:var(--text2)">' + escHtml(l.source || l.actor || '--') + '</td>' +
              '<td style="color:var(--text2);font-size:12px;max-width:260px;overflow:hidden;text-overflow:ellipsis">' + escHtml(l.payload || l.message || '--') + '</td>' +
              '<td style="color:var(--text2)">' + fmtTime(l.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="6" class="empty">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] logs', e); }
    }

    // ‚îÄ‚îÄ DISCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDiscounts() {
      try {
        var r = await fetch(BASE + '/admin-discounts?action=list', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var codes = data.codes || [];
        document.getElementById('discountsBody').innerHTML = codes.length
          ? codes.map(function (c) {
            var statusBadge = c.is_active
              ? '<span class="pill active">Ho·∫°t ƒë·ªông</span>'
              : '<span class="pill inactive">T·∫Øt</span>';
            var toggleLabel = c.is_active ? 'T·∫Øt' : 'B·∫≠t';
            var toggleColor = c.is_active ? '#f59e0b' : '#10b981';
            return '<tr>' +
              '<td><span class="code-chip">' + escHtml(c.code) + '</span></td>' +
              '<td style="font-weight:600">' + escHtml(c.owner_name || '--') + '</td>' +
              '<td class="muted">' + escHtml(c.owner_contact || '--') + '</td>' +
              '<td style="color:#ef4444;font-weight:600">-' + fmtVND(c.discount_amount) + '</td>' +
              '<td class="muted">' + escHtml(c.description || '--') + '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td style="font-weight:600">' + (c.usage_count || 0) + ' l·∫ßn</td>' +
              '<td class="muted">' + (c.last_used_at ? fmtTime(c.last_used_at) : '--') + '</td>' +
              '<td style="color:#ef4444">' + fmtVND(c.total_discount_given || 0) + '</td>' +
              '<td>' +
              '<button onclick="openCtvUsageModal(\\'' + escAttr(c.code) + '\\')" class="btn-ghost primary" style="margin-right:4px">L·ªãch s·ª≠</button>' +
              '<button onclick="toggleDiscount(\\'' + c.id + '\\')" class="btn-ghost warn" style="margin-right:4px">' + toggleLabel + '</button>' +
              '<button onclick="deleteDiscount(\\'' + c.id + '\\',\\'' + escHtml(c.code) + '\\')" class="btn-ghost danger">Xo√°</button>' +
              '</td></tr>';
          }).join('')
          : '<tr><td colspan="10" class="empty">Ch∆∞a c√≥ m√£ gi·∫£m gi√° n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] discounts', e); }
    }

    async function createDiscount() {
      var code = document.getElementById('newDiscountCode').value.trim();
      var amount = parseInt(document.getElementById('newDiscountAmount').value) || 10000;
      var desc = document.getElementById('newDiscountDesc').value.trim();
      var ownerName = document.getElementById('newDiscountOwner').value.trim();
      var ownerContact = document.getElementById('newDiscountContact').value.trim();
      if (!code) return showAdminToast('Nh·∫≠p m√£ code!', 'error');

      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'create', code: code, discountAmount: amount, description: desc, ownerName: ownerName, ownerContact: ownerContact })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast('ƒê√£ t·∫°o m√£: ' + code.toUpperCase(), 'success');
          document.getElementById('newDiscountCode').value = '';
          document.getElementById('newDiscountDesc').value = '';
          document.getElementById('newDiscountOwner').value = '';
          document.getElementById('newDiscountContact').value = '';
          loadDiscounts();
        } else {
          showAdminToast(data.error || 'L·ªói t·∫°o m√£', 'error');
        }
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function openCtvUsageModal(code) {
      var modal = document.getElementById('ctvUsageModal');
      var body = document.getElementById('ctvUsageBody');
      var title = document.getElementById('ctvUsageTitle');
      if (!modal || !body) return;
      title.textContent = 'L·ªãch s·ª≠ d√πng m√£: ' + code;
      body.innerHTML = '<tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr>';
      modal.style.display = 'flex';
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'usage', code: code, limit: 200 })
        });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var rows = data.orders || [];
        body.innerHTML = rows.length
          ? rows.map(function (o) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(o.order_code) + '</td>' +
              '<td>' + escHtml(o.customer_name || '--') + '</td>' +
              '<td style="color:var(--text2)">' + escHtml((o.customer_phone || '') + (o.customer_email ? ' / ' + o.customer_email : '')) + '</td>' +
              '<td style="color:#ef4444">-' + fmtVND(o.discount_amount || 0) + '</td>' +
              '<td>' + fmtVND(o.amount_total || 0) + '</td>' +
              '<td>' + escHtml(o.status || '--') + '</td>' +
              '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="7" class="empty">Ch∆∞a c√≥ ƒë∆°n s·ª≠ d·ª•ng m√£ n√†y</td></tr>';
      } catch (e) {
        body.innerHTML = '<tr><td colspan="7" class="empty">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu</td></tr>';
      }
    }

    function closeCtvUsageModal() {
      var modal = document.getElementById('ctvUsageModal');
      if (modal) modal.style.display = 'none';
    }

    async function toggleDiscount(id) {
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'toggle', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ c·∫≠p nh·∫≠t', 'success'); loadDiscounts(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    async function deleteDiscount(id, code) {
      if (!confirm('Xo√° m√£ "' + code + '"?')) return;
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ xo√° m√£: ' + code, 'success'); loadDiscounts(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    function showAdminToast(msg, type) {
      var t = document.getElementById('globalToast');
      if (!t) return;
      t.textContent = msg;
      t.className = 'toast show ' + (type || '');
      setTimeout(function () { t.className = 'toast'; }, 3000);
    }

    // ‚îÄ‚îÄ UNAUTH handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleUnauth() {
      sessionStorage.removeItem('tbq_admin_token');
      ADMIN_TOKEN = '';
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('shell').style.display = 'none';
      document.getElementById('loginErr').textContent = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i';
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.onload = function () {
      if (ADMIN_TOKEN) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('shell').style.display = 'flex';
        startAutoRefresh();
        loadDashboard();
      }
    };
  </script>
</body>

</html>
