<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TBQ Admin ‚Äì Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin ƒë·ªìng b·ªô phong c√°ch web b√°n h√†ng TBQ Homie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    :root {
      --bg: #f4f6fb;
      --bg-page: #f4f6fb;
      --surface: #ffffff;
      --surface2: #f8f9fc;
      --border: #e2e5ee;
      --border-light: #eef0f5;
      --text: #111827;
      --text2: #6b7280;
      --text-muted: #9ca3af;
      --accent: #4f6ef7;
      --accent-dim: rgba(79, 110, 247, 0.08);
      --accent-strong: #3b5de7;
      --green: #22c55e;
      --green-dim: #f0fdf4;
      --yellow: #f59e0b;
      --yellow-dim: #fffbeb;
      --red: #ef4444;
      --red-dim: #fef2f2;
      --purple: #8b5cf6;
      --purple-dim: #f5f3ff;
      --orange: #f97316;
      --orange-dim: #fff7ed;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.08);
      --font: 'Be Vietnam Pro', 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .shell {
      display: flex;
      min-height: 100vh
    }

    .sidebar {
      width: 230px;
      background: #1a1f36;
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      height: 100vh
    }

    .sidebar-logo {
      padding: 0 24px;
      margin-bottom: 32px;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.5px
    }

    .sidebar-logo span {
      color: rgba(255, 255, 255, .5);
      font-weight: 400;
      font-size: 18px;
      margin-left: 2px
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 24px;
      cursor: pointer;
      color: rgba(255, 255, 255, .55);
      border-left: 3px solid transparent;
      transition: all .15s;
      font-size: 14px;
      font-weight: 500
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .85)
    }

    .nav-item.active {
      border-left-color: var(--accent);
      background: rgba(79, 110, 247, 0.15);
      color: #fff;
      font-weight: 600
    }

    .nav-icon {
      width: 22px;
      text-align: center;
      font-size: 16px
    }

    .sidebar-footer {
      margin-top: auto;
      padding: 16px 24px;
      border-top: 1px solid rgba(255, 255, 255, .08);
      font-size: 12px;
      color: rgba(255, 255, 255, .35)
    }

    .main {
      flex: 1;
      overflow-y: auto;
      padding: 28px 32px;
      background: var(--bg-page);
      min-width: 0
    }

    .page {
      display: none
    }

    .page.active {
      display: block
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ header row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 8px
    }

    .page-header h1 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -.5px;
      color: var(--text)
    }

    .page-header .header-right {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .refresh-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 8px 18px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all .2s;
      box-shadow: var(--shadow-sm);
      font-family: inherit
    }

    .refresh-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim);
      box-shadow: var(--shadow-md)
    }

    .refresh-btn:disabled {
      opacity: .7;
      cursor: not-allowed
    }

    .inventory-status {
      font-size: 13px;
      color: var(--text2);
      margin-right: 12px
    }

    .inventory-status.error {
      color: var(--red)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ stat cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin-bottom: 28px
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px 20px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow .2s, transform .2s;
      position: relative;
      overflow: hidden
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border);
      border-radius: var(--radius) var(--radius) 0 0
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px)
    }

    .stat-card .label {
      font-size: 11px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 10px;
      font-weight: 600
    }

    .stat-card .value {
      font-size: 30px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -1px
    }

    .stat-card.green::before {
      background: var(--green)
    }

    .stat-card.green .value {
      color: var(--green)
    }

    .stat-card.yellow::before {
      background: var(--yellow)
    }

    .stat-card.yellow .value {
      color: var(--yellow)
    }

    .stat-card.red::before {
      background: var(--red)
    }

    .stat-card.red .value {
      color: var(--red)
    }

    .stat-card.purple::before {
      background: var(--purple)
    }

    .stat-card.purple .value {
      color: var(--purple)
    }

    .stat-card.blue::before {
      background: var(--accent)
    }

    .stat-card.blue .value {
      color: var(--accent)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow-x: auto;
      box-shadow: var(--shadow-sm);
      -webkit-overflow-scrolling: touch
    }

    .table-compact th,
    .table-compact td {
      padding: 8px 10px;
      font-size: 12px;
    }

    .table-compact .col-sku {
      max-width: 140px;
      word-break: break-all;
    }

    .table-compact .col-actions {
      white-space: nowrap;
      text-align: right;
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: var(--text2);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      white-space: nowrap;
      background: var(--surface2)
    }

    td {
      padding: 11px 16px;
      border-bottom: 1px solid var(--border-light);
      white-space: nowrap;
      color: var(--text);
      font-size: 13px
    }

    tr:last-child td {
      border-bottom: none
    }

    tr:hover td {
      background: rgba(79, 110, 247, 0.03)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap
    }

    .badge-pending {
      background: var(--yellow-dim);
      color: #b45309
    }

    .badge-paid {
      background: var(--accent-dim);
      color: var(--accent)
    }

    .badge-fulfilled {
      background: var(--green-dim);
      color: #047857
    }

    .badge-failed,
    .badge-cancelled,
    .badge-expired {
      background: var(--red-dim);
      color: var(--red)
    }

    .badge-refunded {
      background: var(--purple-dim);
      color: var(--purple)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ filter bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center
    }

    .filter-bar select,
    .filter-bar input {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit
    }

    .filter-bar select:focus,
    .filter-bar input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Order management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .order-management .order-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px
    }

    .order-management .order-stats-row .stat-card {
      margin-bottom: 0
    }

    .order-management .order-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px
    }

    .order-management .order-toolbar .search-wrap {
      flex: 1;
      min-width: 200px
    }

    .order-management .order-toolbar .search-wrap input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit
    }

    .order-management .order-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border-light);
      overflow-x: auto
    }

    .order-management .order-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text2);
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      font-family: inherit;
      white-space: nowrap;
      transition: all .15s
    }

    .order-management .order-tab:hover {
      color: var(--text);
      background: var(--surface2)
    }

    .order-management .order-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--accent-dim)
    }

    .order-management .order-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch
    }

    .order-management .order-table-wrap table {
      font-size: 13px;
      min-width: 900px
    }

    .order-management .order-table-wrap th,
    .order-management .order-table-wrap td {
      padding: 11px 14px
    }

    .order-management .order-table-wrap .col-code {
      font-weight: 600;
      color: var(--accent)
    }

    .order-management .order-table-wrap .col-actions {
      white-space: nowrap
    }

    .order-management .order-table-wrap .btn-link {
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 12px;
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(79, 110, 247, 0.2);
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-family: inherit;
      font-weight: 500;
      transition: all .15s
    }

    .order-management .order-table-wrap .btn-link:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Order credential detail panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .order-detail-row td {
      padding: 0 !important;
      background: var(--surface2) !important
    }

    .order-detail-panel {
      padding: 16px 20px;
      border-top: 1px solid var(--border)
    }

    .cred-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px
    }

    .cred-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      min-width: 280px;
      flex: 1;
      max-width: 420px
    }

    .cred-card .cred-sku {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--text2);
      margin-bottom: 8px;
      font-weight: 600
    }

    .cred-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px
    }

    .cred-field .cred-label {
      color: var(--text2);
      min-width: 32px;
      font-weight: 600;
      font-size: 12px
    }

    .cred-field .cred-value {
      flex: 1;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
      word-break: break-all;
      color: var(--text)
    }

    .cred-field .cred-value.blurred {
      filter: blur(5px);
      user-select: none;
      cursor: pointer
    }

    .cred-field .cred-btn {
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface2);
      cursor: pointer;
      font-size: 11px;
      color: var(--text2);
      transition: .15s;
      flex-shrink: 0
    }

    .cred-field .cred-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim)
    }

    .cred-loading {
      color: var(--text2);
      font-size: 13px;
      padding: 8px 0
    }

    .cred-empty {
      color: var(--text-muted);
      font-size: 13px;
      font-style: italic;
      padding: 8px 0
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ login overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #1a1f36 0%, #2d3561 50%, #1a1f36 100%);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .login-box {
      background: #fff;
      border: none;
      border-radius: 20px;
      padding: 48px 40px 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3)
    }

    .login-box h2 {
      margin-bottom: 6px;
      font-size: 26px;
      font-weight: 700;
      color: #1a1f36;
      letter-spacing: -0.5px
    }

    .login-box p {
      color: var(--text2);
      margin-bottom: 28px;
      font-size: 14px
    }

    .login-box input {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 15px;
      margin-bottom: 16px;
      font-family: inherit;
      transition: border-color .2s
    }

    .login-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-dim)
    }

    .login-box button {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(79, 110, 247, 0.35)
    }

    .login-box button:hover {
      background: var(--accent-strong);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(79, 110, 247, 0.4)
    }

    .login-box button:active {
      transform: translateY(0)
    }

    .login-err {
      color: var(--red);
      font-size: 13px;
      margin-top: 14px;
      min-height: 18px;
      font-weight: 500
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ empty / loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .empty {
      color: var(--text2);
      text-align: center;
      padding: 48px 0;
      font-size: 15px
    }

    .loading {
      color: var(--text2);
      padding: 24px 0;
      text-align: center;
      font-size: 14px
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SKU Card Grid (nh·∫≠p kho nhanh) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sku-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px
    }

    .sku-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all .2s;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden
    }

    .sku-card:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px)
    }

    .sku-card:active {
      transform: translateY(0)
    }

    .sku-card.in-stock {
      border-color: var(--green)
    }

    .sku-card.low-stock {
      border-color: var(--orange)
    }

    .sku-card.out-of-stock {
      border-color: var(--red);
      opacity: .85
    }

    .sku-card .sku-icon {
      font-size: 32px;
      margin-bottom: 10px;
      line-height: 1
    }

    .sku-card .sku-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3
    }

    .sku-card .sku-code {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
      margin-bottom: 12px
    }

    .sku-card .sku-stock {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .sku-card .sku-stock-count {
      font-size: 24px;
      font-weight: 700
    }

    .sku-card.in-stock .sku-stock-count {
      color: var(--green)
    }

    .sku-card.low-stock .sku-stock-count {
      color: var(--orange)
    }

    .sku-card.out-of-stock .sku-stock-count {
      color: var(--red)
    }

    .sku-card .sku-stock-label {
      font-size: 12px;
      color: var(--text2)
    }

    .sku-card .sku-import-hint {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--accent);
      color: #fff;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      font-weight: 600;
      transform: translateY(100%);
      transition: transform .2s
    }

    .sku-card:hover .sku-import-hint {
      transform: translateY(0)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Quick Import ‚Äî Minimal Design ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .qi-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .qi-top {
      padding: 16px;
    }

    .qi-textarea {
      width: 100%;
      min-height: 90px;
      max-height: 200px;
      padding: 12px 14px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
      line-height: 1.6;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: var(--surface2);
      color: var(--text);
      resize: vertical;
      transition: border-color .2s, background .2s;
    }

    .qi-textarea:focus {
      outline: none;
      border-color: var(--accent);
      border-style: solid;
      background: var(--surface);
    }

    .qi-textarea::placeholder {
      color: var(--text2);
      opacity: 0.5;
      font-family: inherit;
    }

    .qi-type-bar {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-top: 10px;
    }

    .qi-type-chips {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .qi-chip {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
      font-family: inherit;
    }

    .qi-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .qi-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: 600;
    }

    .qi-sku-select {
      flex: 1;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
    }

    .qi-sku-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .qi-sku-sm {
      flex: 0 1 auto;
      min-width: 140px;
      padding: 6px 10px;
      font-size: 12px;
    }

    .qi-btn {
      padding: 10px 24px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: background .15s, transform .1s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .qi-btn:hover { background: var(--accent-dark, #1d4ed8); }
    .qi-btn:active { transform: scale(0.97); }

    .qi-btn-sm {
      padding: 6px 12px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .qi-btn-sm:hover { border-color: var(--accent); color: var(--accent); }

    .qi-btn-confirm {
      width: 100%;
      justify-content: center;
      padding: 12px 24px;
      font-size: 15px;
      background: #000;
      border-radius: var(--radius);
    }

    .qi-btn-confirm:hover { background: #222; }

    .qi-hints {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .qi-hints span {
      padding: 2px 8px;
      background: var(--surface2);
      border-radius: 4px;
      font-size: 11px;
      color: var(--text2);
      font-family: 'SF Mono', monospace;
    }

    .qi-feedback {
      font-size: 13px;
      color: var(--text2);
    }

    .qi-feedback:not(:empty) {
      padding: 10px 16px;
      background: var(--surface2);
      border-top: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ Preview area ‚îÄ‚îÄ */
    .qi-preview {
      border-top: 1px solid var(--border);
    }

    .qi-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface2);
    }

    .qi-preview-stats {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      gap: 12px;
    }

    .qi-preview-stats .qs-valid { color: var(--green); }
    .qi-preview-stats .qs-error { color: var(--red); }
    .qi-preview-stats .qs-date { color: var(--orange); }

    .qi-preview-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* ‚îÄ‚îÄ Card-based preview ‚îÄ‚îÄ */
    .qi-cards {
      max-height: 340px;
      overflow-y: auto;
      padding: 8px 16px;
    }

    .qi-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      margin-bottom: 6px;
      background: var(--surface);
      font-size: 13px;
      transition: border-color .15s;
    }

    .qi-card:hover { border-color: var(--accent); }

    .qi-card.qi-error {
      border-color: rgba(239,68,68,.3);
      background: rgba(239,68,68,.04);
      opacity: .6;
    }

    .qi-card-cb {
      flex-shrink: 0;
      accent-color: var(--accent);
    }

    .qi-card-num {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--surface2);
      color: var(--text2);
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qi-card-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      align-items: center;
    }

    .qi-card-account {
      font-weight: 600;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 220px;
    }

    .qi-card-meta {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .qi-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 7px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .qi-badge-pw { background: rgba(107,114,128,.1); color: var(--text2); }
    .qi-badge-2fa { background: rgba(37,99,235,.1); color: var(--accent); }
    .qi-badge-date { background: rgba(245,158,11,.1); color: var(--orange); }
    .qi-badge-err { background: rgba(239,68,68,.1); color: var(--red); }

    .qi-card-sku {
      flex-shrink: 0;
    }

    .qi-card-sku select {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      background: var(--surface);
      color: var(--text);
      max-width: 160px;
    }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    .qi-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
    }

    .qi-result {
      font-size: 13px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
      background: var(--surface2);
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Inventory table stock badges ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .stock-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
    }

    .stock-badge.green {
      background: rgba(16, 185, 129, .12);
      color: var(--green);
    }

    .stock-badge.orange {
      background: rgba(245, 158, 11, .12);
      color: var(--orange);
    }

    .stock-badge.red {
      background: rgba(239, 68, 68, .12);
      color: var(--red);
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Nh·∫≠p kho n√¢ng cao (collapsible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .advanced-import {
      margin-bottom: 24px
    }

    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      color: var(--text2);
      transition: .15s;
      width: 100%
    }

    .advanced-toggle:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .advanced-toggle .toggle-arrow {
      transition: transform .2s;
      font-size: 10px
    }

    .advanced-toggle.open .toggle-arrow {
      transform: rotate(90deg)
    }

    .advanced-content {
      display: none;
      margin-top: 8px
    }

    .advanced-content.show {
      display: block
    }

    .quick-import-super {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md)
    }

    .quick-import-super h3 {
      margin-bottom: 8px;
      font-size: 16px;
      color: var(--text)
    }

    .quick-import-super .paste-area {
      width: 100%;
      min-height: 140px;
      padding: 12px;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface2);
      color: var(--text);
      resize: vertical;
      margin-bottom: 12px
    }

    .quick-import-super .tool-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px
    }

    .quick-import-super .tool-row select {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: inherit
    }

    .quick-import-super .preview-wrap {
      overflow-x: auto;
      margin-bottom: 12px;
      max-height: 320px;
      overflow-y: auto
    }

    .quick-import-super .preview-table {
      font-size: 12px
    }

    .quick-import-super .preview-table th,
    .quick-import-super .preview-table td {
      padding: 8px 10px;
      white-space: nowrap
    }

    .quick-import-super .preview-table .col-account {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .quick-import-super .preview-table .col-secret {
      font-family: monospace;
      color: var(--text2)
    }

    .quick-import-super .preview-table .col-secret.masked {
      filter: blur(4px);
      user-select: none
    }

    .quick-import-super .preview-table .cell-copy {
      cursor: pointer;
      opacity: .7
    }

    .quick-import-super .row-status-valid {
      color: var(--green)
    }

    .quick-import-super .row-status-error {
      color: var(--red)
    }

    .quick-import-super .confidence-bar {
      display: inline-block;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      min-width: 40px;
      vertical-align: middle
    }

    .quick-import-super .confidence-bar span {
      display: block;
      height: 100%;
      border-radius: 3px;
      background: var(--green)
    }

    .quick-import-super .sku-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--surface2);
      border-radius: var(--radius-sm)
    }

    .quick-import-super .import-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      font-size: 13px
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      backdrop-filter: blur(2px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .modal-overlay.show {
      display: flex
    }

    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg)
    }

    .modal-box h4 {
      margin-bottom: 16px;
      font-size: 16px;
      color: var(--text)
    }

    .modal-box label {
      display: block;
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 4px
    }

    .modal-box input,
    .modal-box textarea {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 13px;
      margin-bottom: 12px;
      font-family: inherit
    }

    .modal-box input:focus,
    .modal-box textarea:focus {
      outline: none;
      border-color: var(--accent)
    }

    .modal-box textarea {
      min-height: 60px;
      resize: vertical
    }

    .modal-box .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px
    }

    .modal-box .modal-actions button {
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      border: none;
      font-family: inherit
    }

    .modal-box .modal-actions .btn-primary {
      background: #000;
      color: #fff
    }

    .modal-box .modal-actions .btn-primary:hover {
      opacity: .9
    }

    .modal-box .modal-actions .btn-secondary {
      background: var(--surface2);
      color: var(--text2);
      border: 1px solid var(--border)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Discounts UX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .discount-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap
    }

    .discount-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: end
    }

    .form-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      display: block;
      margin-bottom: 6px
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: var(--surface)
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12)
    }

    .btn-primary-sm {
      padding: 10px 18px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap
    }

    .btn-ghost {
      padding: 6px 12px;
      border: 1px solid var(--border);
      color: var(--text2);
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px
    }

    .btn-ghost.primary {
      border-color: #2563eb;
      color: #2563eb
    }

    .btn-ghost.warn {
      border-color: #f59e0b;
      color: #f59e0b
    }

    .btn-ghost.danger {
      border-color: #ef4444;
      color: #ef4444
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700
    }

    .pill.active {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #10b981
    }

    .pill.inactive {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #ef4444
    }

    .code-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight: 700;
      letter-spacing: 0.02em
    }

    .muted {
      color: var(--text2)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Modal (CTV usage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .35);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 24px
    }

    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 960px;
      max-height: 88vh;
      overflow: auto;
      box-shadow: var(--shadow-lg)
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid var(--border)
    }

    .modal-header h2 {
      font-size: 18px;
      font-weight: 700
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface2);
      cursor: pointer;
      font-size: 18px
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid var(--border)
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Paste import modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .paste-import-box .paste-import-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .paste-import-box .paste-tab {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text2);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }

    .paste-import-box .paste-tab:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .paste-import-box .paste-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--accent-dim);
    }

    .paste-import-box .tab-content {
      display: none;
    }

    .paste-import-box .tab-content.active {
      display: block;
    }

    .paste-import-box .paste-import-hint {
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 10px
    }

    .paste-import-box .paste-import-hint code {
      background: var(--surface2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid var(--border)
    }

    .paste-import-box #pasteImportText {
      min-height: 140px;
      font-family: monospace;
      font-size: 13px
    }

    .paste-import-box .paste-preview {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text2)
    }

    .paste-import-box .paste-preview .preview-line {
      display: flex;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid var(--border-light)
    }

    .paste-import-box .paste-preview .preview-line .pv-account {
      font-weight: 600;
      color: var(--text);
      min-width: 160px
    }

    .paste-import-box .paste-preview .preview-line .pv-pass {
      font-family: monospace;
      color: var(--text2)
    }

    .paste-import-box .paste-preview .preview-line .pv-2fa {
      font-family: monospace;
      color: var(--accent)
    }

    /* Stock List Table */
    .stock-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .stock-list-table th,
    .stock-list-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }

    .stock-list-table th {
      background: var(--surface2);
      font-weight: 600;
      color: var(--text2);
      font-size: 11px;
      text-transform: uppercase;
    }

    .stock-list-table .col-actions {
      text-align: right;
    }

    .stock-list-table .btn-del {
      color: var(--red);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      font-size: 12px;
    }

    .stock-list-table .btn-del:hover {
      background: var(--red-dim);
      border-color: var(--red);
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1f2937;
      color: #fff;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      transform: translateY(100px);
      opacity: 0;
      transition: all .3s;
      box-shadow: var(--shadow-lg)
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ responsive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media(max-width:768px) {
      .shell {
        flex-direction: column
      }

      .sidebar {
        flex-direction: row;
        width: 100%;
        padding: 0;
        gap: 0;
        overflow-x: auto;
        height: auto;
        position: relative;
        -webkit-overflow-scrolling: touch
      }

      .sidebar-logo {
        margin-bottom: 0;
        padding: 12px 16px;
        font-size: 16px;
        flex-shrink: 0
      }

      .nav-item {
        padding: 12px 14px;
        border-left: none;
        border-bottom: 3px solid transparent;
        white-space: nowrap;
        font-size: 13px;
        gap: 6px
      }

      .nav-item.active {
        border-left-color: transparent;
        border-bottom-color: var(--accent);
        background: rgba(79, 110, 247, 0.12)
      }

      .sidebar-footer {
        display: none
      }

      .main {
        padding: 16px
      }

      .page-header h1 {
        font-size: 20px
      }

      .stats-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px
      }

      .stat-card .value {
        font-size: 24px
      }

      .sku-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px
      }

      .sku-card {
        padding: 14px
      }

      .sku-card .sku-icon {
        font-size: 24px
      }

      .order-management .order-stats-row {
        grid-template-columns: repeat(2, 1fr)
      }

      .order-management .order-toolbar .search-wrap {
        min-width: 100%
      }

      .login-box {
        padding: 32px 24px 28px
      }

      .login-box h2 {
        font-size: 22px
      }
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Promotion sub-tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .promo-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-light);
      background: var(--surface);
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
    }

    .promo-tab {
      padding: 14px 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--text2);
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      font-family: inherit;
      white-space: nowrap;
      transition: all .2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .promo-tab:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .promo-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: var(--accent-dim);
    }

    .promo-tab .tab-count {
      background: var(--surface2);
      color: var(--text2);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 24px;
      text-align: center;
    }

    .promo-tab.active .tab-count {
      background: var(--accent);
      color: #fff;
    }

    .promo-content {
      display: none;
    }

    .promo-content.active {
      display: block;
      animation: fadeSlideIn .25s ease;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Coupon page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .coupon-gen-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      align-items: end
    }

    .coupon-gen-form .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .coupon-gen-form .form-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .coupon-result {
      margin-top: 16px;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid #10b981;
      background: #ecfdf5;
      font-size: 13px;
      display: none
    }

    .coupon-result.show {
      display: block
    }

    .coupon-result .coupon-code-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(16, 185, 129, .2)
    }

    .coupon-result .coupon-code-row:last-child {
      border-bottom: none
    }

    .coupon-link-btn {
      padding: 3px 8px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      background: var(--accent-dim);
      color: var(--accent);
      font-size: 11px;
      cursor: pointer;
      font-weight: 600
    }

    .coupon-link-btn:hover {
      background: var(--accent);
      color: #fff
    }

    .pill.expired {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b
    }

    .pill.used {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #ef4444
    }

    .sku-selector {
      margin-top: 12px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg2)
    }

    .sku-selector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px
    }

    .sku-selector-header label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .sku-toggle-all {
      font-size: 11px;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline
    }

    .sku-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 6px;
      max-height: 300px;
      overflow-y: auto
    }

    .sku-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s
    }

    .sku-checkbox:hover {
      background: var(--bg3, rgba(0, 0, 0, .04))
    }

    .sku-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent)
    }

    .sku-checkbox .sku-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .sku-checkbox .sku-code {
      font-size: 10px;
      color: var(--text3, #999);
      font-family: monospace
    }

    .sku-cat-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text2);
      padding: 8px 0 4px;
      grid-column: 1 / -1;
      border-bottom: 1px solid var(--border)
    }
  </style>
</head>

<body>

  <!-- ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>TBQ Admin</h2>
      <p>Nh·∫≠p Admin Token ƒë·ªÉ ƒëƒÉng nh·∫≠p</p>
      <input type="password" id="tokenInput" placeholder="Admin token..." onkeydown="if(event.key==='Enter')doLogin()">
      <button onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
      <div class="login-err" id="loginErr"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ SHELL ‚îÄ‚îÄ -->
  <div class="shell" id="shell" style="display:none">

    <!-- sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">TBQ<span>Admin</span></div>
      <div class="nav-item active" onclick="nav('dashboard')"><span class="nav-icon">üìä</span> T·ªïng quan</div>
      <div class="nav-item" onclick="nav('orders')"><span class="nav-icon">üì¶</span> ƒê∆°n h√†ng</div>
      <div class="nav-item" onclick="nav('inventory')"><span class="nav-icon">üìã</span> Kho h√†ng</div>
      <div class="nav-item" onclick="nav('products')"><span class="nav-icon">üõí</span> S·∫£n ph·∫©m</div>
      <div class="nav-item" onclick="nav('customers')"><span class="nav-icon">üë•</span> Kh√°ch h√†ng</div>
      <div class="nav-item" onclick="nav('promotions')"><span class="nav-icon">üéüÔ∏è</span> Khuy·∫øn m√£i</div>
      <div class="sidebar-footer">
        ƒê·ªìng b·ªô: <span id="lastSync">--</span>
        <span style="margin-left:8px;cursor:pointer;opacity:.6" onclick="nav('logs')" title="Nh·∫≠t k√Ω">üìù</span>
      </div>
    </aside>

    <!-- main -->
    <main class="main">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <h1>T·ªïng quan</h1>
          <button class="refresh-btn" onclick="loadDashboard()">L√†m m·ªõi</button>
        </div>
        <div class="stats-row" id="statsRow">
          <div class="stat-card blue">
            <div class="label">T·ªïng ƒë∆°n</div>
            <div class="value" id="statTotal">--</div>
          </div>
          <div class="stat-card yellow">
            <div class="label">Ch·ªù thanh to√°n</div>
            <div class="value" id="statPending">--</div>
          </div>
          <div class="stat-card green">
            <div class="label">ƒê√£ giao</div>
            <div class="value" id="statFulfilled">--</div>
          </div>
          <div class="stat-card purple">
            <div class="label">Doanh thu</div>
            <div class="value" id="statRevenue">--</div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody id="dashboardOrders">
              <tr>
                <td colspan="5" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ORDERS -->
      <div class="page order-management" id="page-orders">
        <div class="page-header">
          <div>
            <h1>ƒê∆°n h√†ng</h1>
            <p style="color:var(--text2);font-size:13px;margin-top:4px">B·∫•m v√†o ƒë∆°n ƒë·ªÉ xem tk|mk|2fa</p>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-primary-sm" onclick="openCreateOrderModal()">+ T·∫°o ƒë∆°n</button>
            <button class="refresh-btn" onclick="loadOrders()">L√†m m·ªõi</button>
          </div>
        </div>
        <div class="order-stats-row">
          <div class="stat-card blue">
            <div class="label">T·ªïng c·ªông</div>
            <div class="value" id="orderStatTotal">--</div>
          </div>
          <div class="stat-card yellow">
            <div class="label">Ch·ªù thanh to√°n</div>
            <div class="value" id="orderStatPending">--</div>
          </div>
          <div class="stat-card green">
            <div class="label">ƒê√£ giao</div>
            <div class="value" id="orderStatDelivered">--</div>
          </div>
          <div class="stat-card red">
            <div class="label">L·ªói / Hu·ª∑</div>
            <div class="value" id="orderStatError">--</div>
          </div>
        </div>
        <div class="order-toolbar">
          <div class="search-wrap" style="position:relative">
            <span
              style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:14px;">üîç</span>
            <input type="text" id="orderSearch" placeholder="T√¨m m√£ ƒë∆°n, email..." oninput="loadOrders()">
          </div>
          <select id="orderStatusFilter" onchange="setOrderTabFromFilter();loadOrders()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="pending_payment">Ch·ªù thanh to√°n</option>
            <option value="paid">ƒê√£ thanh to√°n</option>
            <option value="fulfilled">ƒê√£ giao</option>
            <option value="failed">L·ªói</option>
            <option value="cancelled">Hu·ª∑</option>
            <option value="refunded">Ho√†n ti·ªÅn</option>
            <option value="expired">H·∫øt h·∫°n</option>
          </select>
          <button class="refresh-btn" onclick="loadOrders()">L√†m m·ªõi</button>
        </div>
        <div class="order-tabs">
          <button type="button" class="order-tab active" data-status="" onclick="setOrderTab('')">T·∫•t c·∫£</button>
          <button type="button" class="order-tab" data-status="pending_payment"
            onclick="setOrderTab('pending_payment')">Ch·ªù TT</button>
          <button type="button" class="order-tab" data-status="paid" onclick="setOrderTab('paid')">ƒê√£ TT</button>
          <button type="button" class="order-tab" data-status="fulfilled" onclick="setOrderTab('fulfilled')">ƒê√£
            giao</button>
          <button type="button" class="order-tab" data-status="failed" onclick="setOrderTab('failed')">L·ªói /
            Hu·ª∑</button>
        </div>
        <div class="order-table-wrap table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>M√£ ƒë∆°n</th>
                <th>Kh√°ch</th>
                <th>Email</th>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              <tr>
                <td colspan="9" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- INVENTORY -->
      <div class="page" id="page-inventory">
        <div class="page-header">
          <div>
            <h1>Kho h√†ng</h1>
            <p style="color:var(--text2);font-size:13px;margin-top:4px">B·∫•m v√†o s·∫£n ph·∫©m ƒë·ªÉ nh·∫≠p tk|mk|2fa</p>
          </div>
          <div class="header-right">
            <span id="inventoryStatus" class="inventory-status"></span>
            <button class="refresh-btn" id="inventoryRefreshBtn" onclick="loadInventory()">L√†m m·ªõi</button>
          </div>
        </div>

        <!-- Quick Import Section -->
        <div class="qi-panel">
          <div class="qi-top">
            <textarea id="superPasteRaw" class="qi-textarea"
              placeholder="D√°n t√†i kho·∫£n v√†o ƒë√¢y ‚Äî m·ªói d√≤ng 1 t√†i kho·∫£n&#10;&#10;email@gmail.com|matkhau123 (Date 29.04)&#10;user2@mail.com|pass456|2fa_code"></textarea>
            <div class="qi-type-bar">
              <div class="qi-type-chips" id="qiTypeChips">
                <button type="button" class="qi-chip active" data-sku="" onclick="selectSkuChip(this)">üîç T·ª± ƒëo√°n</button>
              </div>
              <button type="button" class="qi-btn" onclick="doQuickImport()">
                üì• Nh·∫≠p kho
              </button>
            </div>
            <div class="qi-hints">
              <span>tk|mk</span>
              <span>tk|mk|2fa</span>
              <span>(Date 29.04)</span>
            </div>
            <!-- Hidden select for backward compat -->
            <select id="superProfileSku" style="display:none"></select>
          </div>

          <!-- Preview (hidden until analyzed) -->
          <div id="superPreviewWrap" class="qi-preview" style="display:none;">
            <div class="qi-preview-header">
              <div class="qi-preview-stats" id="qiPreviewStats"></div>
              <div class="qi-preview-actions">
                <select id="superApplySkuSelect" class="qi-sku-select qi-sku-sm"></select>
                <button type="button" class="qi-btn-sm" onclick="applySkuToAllValid()">ƒê·ªïi SKU t·∫•t c·∫£</button>
              </div>
            </div>
            <div class="qi-cards" id="superPreviewCards"></div>
            <div class="qi-footer">
              <div id="superImportResult" class="qi-result" style="display:none;"></div>
              <button type="button" class="qi-btn qi-btn-confirm" onclick="doSuperImport()">
                ‚úÖ X√°c nh·∫≠n nh·∫≠p <span id="qiConfirmCount"></span> t√†i kho·∫£n
              </button>
            </div>
          </div>
          <div id="superParseFeedback" class="qi-feedback"></div>
        </div>

        <!-- Inventory List Table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:40px"></th>
                <th>SKU</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>C√≥ s·∫µn</th>
                <th>ƒê√£ b√°n</th>
                <th>T·ªïng</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="skuListBody">
              <tr>
                <td colspan="7" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Inventory summary table (hidden - replaced by SKU card grid) -->
        <div class="table-wrap" id="inventorySummaryTable" style="display:none">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>C√≥ s·∫µn</th>
                <th>ƒê√£ b√°n</th>
                <th>ƒê√£ gi·ªØ</th>
                <th>T·ªïng</th>
              </tr>
            </thead>
            <tbody id="inventoryBody">
              <tr>
                <td colspan="5" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Modal: Paste Import / View Stock (click SKU card) -->
      <div id="pasteImportModal" class="modal-overlay" onclick="if(event.target===this)closePasteImportModal()">
        <div class="modal-box paste-import-box" onclick="event.stopPropagation()" style="max-width: 700px;">
          <h4 id="pasteImportTitle" style="margin-bottom: 12px;">Qu·∫£n l√Ω kho</h4>

          <div class="paste-import-tabs">
            <div class="paste-tab active" onclick="switchPasteTab('list')" id="tab-list">Danh s√°ch</div>
            <div class="paste-tab" onclick="switchPasteTab('import')" id="tab-import">Nh·∫≠p h√†ng</div>
          </div>

          <!-- Tab Content: List -->
          <div id="content-list" class="tab-content active">
            <div class="order-toolbar" style="margin-bottom: 12px;">
              <button class="refresh-btn" onclick="loadSkuDetails()">L√†m m·ªõi</button>
              <span id="skuListCount" style="margin-left:auto; font-size:13px; color:var(--text2)"></span>
            </div>
            <div
              style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm);">
              <table class="stock-list-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>T√†i kho·∫£n / Key</th>
                    <th>Ghi ch√∫ / 2FA</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ng√†y t·∫°o</th>
                    <th class="col-actions">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="skuDetailsBody">
                  <tr>
                    <td colspan="6" class="loading">ƒêang t·∫£i...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-secondary" onclick="closePasteImportModal()">ƒê√≥ng</button>
            </div>
          </div>

          <!-- Tab Content: Import -->
          <div id="content-import" class="tab-content">
            <p class="paste-import-hint">M·ªói d√≤ng m·ªôt t√†i kho·∫£n. ƒê·ªãnh d·∫°ng: <code>email|m·∫≠t_kh·∫©u|2fa</code> (2fa c√≥ th·ªÉ
              b·ªè tr·ªëng).</p>
            <textarea id="pasteImportText" placeholder="user@mail.com|password123|abc2fa&#10;user2@mail.com|pass2|"
              rows="8" oninput="previewPasteLines()"></textarea>
            <div id="pastePreview" class="paste-preview"></div>
            <div id="pasteImportFeedback" style="font-size:13px;margin-top:8px;min-height:20px;color:var(--text2)">
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-primary" onclick="submitPasteImport()">Nh·∫≠p kho</button>
              <button type="button" class="btn-secondary" onclick="closePasteImportModal()">Hu·ª∑</button>
            </div>
          </div>

        </div>
      </div>

      <!-- AUDIT LOGS -->
      <div class="page" id="page-logs">
        <div class="page-header">
          <h1>Nh·∫≠t k√Ω</h1>
          <div style="display:flex;gap:8px">
            <button class="btn-ghost danger" onclick="clearAllLogs()" style="font-size:12px">üóëÔ∏è Xo√° t·∫•t c·∫£</button>
            <button class="refresh-btn" onclick="loadLogs()">L√†m m·ªõi</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>S·ª± ki·ªán</th>
                <th>Lo·∫°i</th>
                <th>ID</th>
                <th>Ngu·ªìn</th>
                <th>Chi ti·∫øt</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody id="logsBody">
              <tr>
                <td colspan="6" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCTS / SKU PAGE -->
      <div class="page" id="page-products">
        <div class="page-header">
          <h1>Qu·∫£n l√Ω s·∫£n ph·∫©m (SKU)</h1>
          <button class="refresh-btn" onclick="loadProducts()">L√†m m·ªõi</button>
        </div>
        <div class="card" style="margin-bottom:24px;padding:20px">
          <h3 style="margin:0 0 12px">T·∫°o SKU m·ªõi</h3>
          <div class="discount-form">
            <div class="form-field"><label>M√£ SKU</label><input type="text" id="newSkuCode" class="form-input"
                placeholder="vd: NETFLIX_1M"></div>
            <div class="form-field"><label>T√™n</label><input type="text" id="newSkuName" class="form-input"
                placeholder="Netflix 1 Th√°ng"></div>
            <div class="form-field"><label>Danh m·ª•c</label><input type="text" id="newSkuCategory" class="form-input"
                placeholder="Gi·∫£i tr√≠"></div>
            <div class="form-field"><label>Gi√° (VND)</label><input type="number" id="newSkuPrice" class="form-input"
                value="50000"></div>
            <div class="form-field">
              <label>Lo·∫°i giao</label>
              <select id="newSkuDelivery" class="form-input">
                <option value="auto">T·ª± ƒë·ªông (auto)</option>
                <option value="owner_upgrade">Giao sau (5-10p)</option>
              </select>
            </div>
            <div class="form-field"><label>Th·ªùi h·∫°n (ng√†y)</label><input type="number" id="newSkuDuration"
                class="form-input" value="30"></div>
            <div class="form-field"><button onclick="createSku()" class="btn-primary-sm">+ T·∫°o SKU</button></div>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table-compact">
            <thead>
              <tr>
                <th>M√£ SKU</th>
                <th>T√™n</th>
                <th>Danh m·ª•c</th>
                <th style="text-align:right">Gi√°</th>
                <th>Lo·∫°i</th>
                <th style="text-align:center">C√≥ s·∫µn</th>
                <th style="text-align:center">ƒê√£ b√°n</th>
                <th>Tr·∫°ng th√°i</th>
                <th style="text-align:right">Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="productsBody">
              <tr>
                <td colspan="9" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CUSTOMERS PAGE -->
      <div class="page" id="page-customers">
        <div class="page-header">
          <h1>Kh√°ch h√†ng</h1>
          <div style="display:flex;gap:8px">
            <button class="btn-primary-sm" onclick="openCreateCustomerModal()">+ T·∫°o KH</button>
            <button class="refresh-btn" onclick="loadCustomers()">L√†m m·ªõi</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>T√™n</th>
                <th>Email</th>
                <th>SƒêT</th>
                <th>ƒê∆°n h√†ng</th>
                <th>T·ªïng chi</th>
                <th>L·∫ßn cu·ªëi</th>
                <th>Ngu·ªìn</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="customersBody">
              <tr>
                <td colspan="8" class="loading">ƒêang t·∫£i...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- MODAL: Create Order -->
      <div id="createOrderModal" class="modal-overlay" style="display:none"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box" style="max-width:500px" onclick="event.stopPropagation()">
          <h4 style="margin-bottom:12px">T·∫°o ƒë∆°n th·ªß c√¥ng</h4>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="text" id="manualOrderName" class="form-input" placeholder="T√™n kh√°ch h√†ng *">
            <input type="email" id="manualOrderEmail" class="form-input" placeholder="Email *">
            <input type="text" id="manualOrderPhone" class="form-input" placeholder="S·ªë ƒëi·ªán tho·∫°i">
            <select id="manualOrderSku" class="form-input" onchange="updateManualOrderPrice()">
              <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
            </select>
            <div style="display:flex;gap:8px">
              <input type="number" id="manualOrderQty" class="form-input" value="1" min="1" style="width:80px"
                placeholder="SL">
              <input type="number" id="manualOrderPrice" class="form-input" placeholder="Gi√° (VND)">
            </div>
            <textarea id="manualOrderNote" class="form-input" rows="2" placeholder="Ghi ch√∫"></textarea>
          </div>
          <div class="modal-actions" style="margin-top:14px">
            <button class="btn-primary" onclick="submitManualOrder()">T·∫°o ƒë∆°n</button>
            <button class="btn-secondary"
              onclick="document.getElementById('createOrderModal').style.display='none'">Hu·ª∑</button>
          </div>
        </div>
      </div>

      <!-- MODAL: Edit Order -->
      <div id="editOrderModal" class="modal-overlay" style="display:none"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box" style="max-width:500px" onclick="event.stopPropagation()">
          <h4 style="margin-bottom:12px">S·ª≠a ƒë∆°n: <span id="editOrderCode"></span></h4>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="text" id="editOrderName" class="form-input" placeholder="T√™n kh√°ch">
            <input type="email" id="editOrderEmail" class="form-input" placeholder="Email">
            <input type="text" id="editOrderPhone" class="form-input" placeholder="SƒêT">
            <select id="editOrderStatus" class="form-input">
              <option value="pending_payment">Ch·ªù thanh to√°n</option>
              <option value="paid">ƒê√£ thanh to√°n</option>
              <option value="fulfilled">ƒê√£ giao</option>
              <option value="cancelled">Hu·ª∑</option>
              <option value="refunded">Ho√†n ti·ªÅn</option>
              <option value="expired">H·∫øt h·∫°n</option>
              <option value="failed">L·ªói</option>
            </select>
            <input type="number" id="editOrderAmount" class="form-input" placeholder="T·ªïng ti·ªÅn (VND)">
            <textarea id="editOrderNote" class="form-input" rows="2" placeholder="Ghi ch√∫"></textarea>
          </div>
          <div class="modal-actions" style="margin-top:14px">
            <button class="btn-primary" onclick="submitEditOrder()">L∆∞u</button>
            <button class="btn-secondary"
              onclick="document.getElementById('editOrderModal').style.display='none'">Hu·ª∑</button>
          </div>
        </div>
      </div>

      <!-- MODAL: Edit SKU -->
      <div id="editSkuModal" class="modal-overlay" style="display:none"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box" style="max-width:460px" onclick="event.stopPropagation()">
          <h4 style="margin-bottom:12px">S·ª≠a SKU: <span id="editSkuCode"></span></h4>
          <input type="hidden" id="editSkuId">
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="text" id="editSkuName" class="form-input" placeholder="T√™n">
            <input type="text" id="editSkuCategory" class="form-input" placeholder="Danh m·ª•c">
            <input type="number" id="editSkuPrice" class="form-input" placeholder="Gi√°">
            <select id="editSkuDelivery" class="form-input">
              <option value="auto">T·ª± ƒë·ªông</option>
              <option value="owner_upgrade">Giao sau</option>
            </select>
            <input type="number" id="editSkuDuration" class="form-input" placeholder="Th·ªùi h·∫°n (ng√†y)">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px">
              <input type="checkbox" id="editSkuActive" checked> Ho·∫°t ƒë·ªông
            </label>
          </div>
          <div class="modal-actions" style="margin-top:14px">
            <button class="btn-primary" onclick="submitEditSku()">L∆∞u</button>
            <button class="btn-secondary"
              onclick="document.getElementById('editSkuModal').style.display='none'">Hu·ª∑</button>
          </div>
        </div>
      </div>

      <!-- MODAL: Edit Stock Item -->
      <div id="editStockItemModal" class="modal-overlay" style="display:none"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box" style="max-width:460px" onclick="event.stopPropagation()">
          <h4 style="margin-bottom:12px">S·ª≠a t√†i kho·∫£n kho</h4>
          <input type="hidden" id="editStockItemId">
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="text" id="editStockAccount" class="form-input" placeholder="T√†i kho·∫£n">
            <input type="text" id="editStockSecret" class="form-input" placeholder="M·∫≠t kh·∫©u / Key">
            <input type="text" id="editStockNote" class="form-input" placeholder="Ghi ch√∫ / 2FA">
          </div>
          <div class="modal-actions" style="margin-top:14px">
            <button class="btn-primary" onclick="submitEditStockItem()">L∆∞u</button>
            <button class="btn-secondary"
              onclick="document.getElementById('editStockItemModal').style.display='none'">Hu·ª∑</button>
          </div>
        </div>
      </div>

      <!-- MODAL: Create/Edit Customer -->
      <div id="customerModal" class="modal-overlay" style="display:none"
        onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-box" style="max-width:460px" onclick="event.stopPropagation()">
          <h4 id="customerModalTitle" style="margin-bottom:12px">T·∫°o kh√°ch h√†ng</h4>
          <input type="hidden" id="customerModalId">
          <div style="display:flex;flex-direction:column;gap:10px">
            <input type="text" id="customerModalName" class="form-input" placeholder="T√™n *">
            <input type="email" id="customerModalEmail" class="form-input" placeholder="Email">
            <input type="text" id="customerModalPhone" class="form-input" placeholder="SƒêT">
            <textarea id="customerModalNote" class="form-input" rows="2" placeholder="Ghi ch√∫"></textarea>
          </div>
          <div class="modal-actions" style="margin-top:14px">
            <button class="btn-primary" id="customerModalSubmitBtn" onclick="submitCustomerModal()">T·∫°o</button>
            <button class="btn-secondary"
              onclick="document.getElementById('customerModal').style.display='none'">Hu·ª∑</button>
          </div>
        </div>
      </div>

      <!-- PROMOTIONS PAGE (merged Discounts + Coupons) -->
      <div class="page" id="page-promotions">
        <div class="page-header">
          <h1>üéüÔ∏è Khuy·∫øn m√£i</h1>
          <button class="refresh-btn" onclick="loadPromotions()">L√†m m·ªõi</button>
        </div>

        <!-- Sub-tabs -->
        <div class="promo-tabs">
          <button type="button" class="promo-tab active" onclick="switchPromoTab('ctv')">
            üè∑Ô∏è M√£ CTV <span class="tab-count" id="ctvCount">--</span>
          </button>
          <button type="button" class="promo-tab" onclick="switchPromoTab('coupon')">
            üéüÔ∏è Coupon <span class="tab-count" id="couponCount">--</span>
          </button>
        </div>

        <!-- TAB: CTV Discounts -->
        <div class="promo-content active" id="promo-ctv">
          <div class="card" style="margin-bottom:24px; padding:20px;">
            <h3 style="margin:0 0 12px">T·∫°o/ c·∫≠p nh·∫≠t m√£ (CTV01‚ÄìCTV05)</h3>
            <p class="muted" style="margin:0 0 14px; font-size:12px;">M·ªói m√£ g·∫Øn v·ªõi m·ªôt CTV. M√£ ƒë√£ t·ªìn t·∫°i s·∫Ω ƒë∆∞·ª£c c·∫≠p
              nh·∫≠t th√¥ng tin.</p>
            <div class="discount-form">
              <div class="form-field">
                <label>M√£ code</label>
                <input type="text" id="newDiscountCode" class="form-input"
                  placeholder="CTV01 / CTV02 / CTV03 / CTV04 / CTV05" maxlength="30">
              </div>
              <div class="form-field">
                <label>CTV</label>
                <input type="text" id="newDiscountOwner" class="form-input" placeholder="T√™n ng∆∞·ªùi nh·∫≠n m√£">
              </div>
              <div class="form-field">
                <label>Li√™n h·ªá</label>
                <input type="text" id="newDiscountContact" class="form-input" placeholder="SƒêT/Zalo">
              </div>
              <div class="form-field">
                <label>Gi·∫£m (VND)</label>
                <input type="number" id="newDiscountAmount" class="form-input" value="10000">
              </div>
              <div class="form-field">
                <label>M√¥ t·∫£</label>
                <input type="text" id="newDiscountDesc" class="form-input" placeholder="VD: M√£ CTV Minh">
              </div>
              <div class="form-field">
                <button onclick="createDiscount()" class="btn-primary-sm">+ T·∫°o / c·∫≠p nh·∫≠t</button>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>M√£ code</th>
                  <th>CTV</th>
                  <th>Li√™n h·ªá</th>
                  <th>Gi·∫£m</th>
                  <th>M√¥ t·∫£</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>ƒê√£ d√πng</th>
                  <th>L·∫ßn cu·ªëi</th>
                  <th>T·ªïng gi·∫£m</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="discountsBody">
                <tr>
                  <td colspan="10" class="loading">ƒêang t·∫£i...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB: Coupons -->
        <div class="promo-content" id="promo-coupon">
          <div class="card" style="margin-bottom:24px; padding:20px;">
            <h3 style="margin:0 0 6px">T·∫°o coupon gi·∫£m gi√°</h3>
            <p class="muted" style="margin:0 0 14px; font-size:12px;">H·ªá th·ªëng t·ª± ƒë·ªông t·∫°o m√£ coupon ng·∫´u nhi√™n. M·ªói
              coupon ch·ªâ d√πng ƒë∆∞·ª£c 1 l·∫ßn.</p>
            <div class="coupon-gen-form">
              <div class="form-field">
                <label>Gi·∫£m (%)</label>
                <select id="couponPercent" class="form-input">
                  <option value="5">5%</option>
                  <option value="10">10%</option>
                  <option value="15">15%</option>
                  <option value="20" selected>20%</option>
                  <option value="25">25%</option>
                  <option value="30">30%</option>
                  <option value="35">35%</option>
                  <option value="40">40%</option>
                  <option value="45">45%</option>
                  <option value="50">50%</option>
                  <option value="55">55%</option>
                  <option value="60">60%</option>
                  <option value="65">65%</option>
                  <option value="70">70%</option>
                  <option value="75">75%</option>
                  <option value="80">80%</option>
                  <option value="85">85%</option>
                  <option value="90">90%</option>
                  <option value="95">95%</option>
                  <option value="100">100% (Mi·ªÖn ph√≠)</option>
                </select>
              </div>
              <div class="form-field">
                <label>S·ªë l∆∞·ª£ng</label>
                <input type="number" id="couponQty" class="form-input" value="1" min="1" max="50">
              </div>
              <div class="form-field">
                <label>H·∫°n s·ª≠ d·ª•ng</label>
                <input type="datetime-local" id="couponExpiry" class="form-input">
              </div>
              <div class="form-field">
                <label>M√¥ t·∫£</label>
                <input type="text" id="couponDesc" class="form-input" placeholder="VD: Khuy·∫øn m√£i th√°ng 2">
              </div>
              <div class="form-field">
                <button onclick="generateCoupons()" class="btn-primary-sm">üéüÔ∏è T·∫°o coupon</button>
              </div>
            </div>
            <div class="sku-selector">
              <div class="sku-selector-header">
                <label>√Åp d·ª•ng cho s·∫£n ph·∫©m</label>
                <span class="sku-toggle-all" onclick="toggleAllSkus()">Ch·ªçn t·∫•t c·∫£ / B·ªè ch·ªçn</span>
              </div>
              <div class="sku-grid" id="skuCheckboxes">
                <div class="muted" style="font-size:12px">ƒêang t·∫£i SKU...</div>
              </div>
              <p class="muted" style="font-size:11px; margin:8px 0 0">Kh√¥ng ch·ªçn SKU n√†o = √°p d·ª•ng cho t·∫•t c·∫£ s·∫£n ph·∫©m
              </p>
            </div>
            <div class="coupon-result" id="couponResult"></div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>M√£ coupon</th>
                  <th>Gi·∫£m</th>
                  <th>√Åp d·ª•ng cho</th>
                  <th>H·∫°n s·ª≠ d·ª•ng</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>M√¥ t·∫£</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="couponsBody">
                <tr>
                  <td colspan="8" class="loading">ƒêang t·∫£i...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CTV USAGE MODAL -->
      <div id="ctvUsageModal" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="ctvUsageTitle">L·ªãch s·ª≠ d√πng m√£</h2>
            <button class="close-btn" onclick="closeCtvUsageModal()">√ó</button>
          </div>
          <div class="table-wrap" style="margin:12px 20px 0;">
            <table>
              <thead>
                <tr>
                  <th>M√£ ƒë∆°n</th>
                  <th>Kh√°ch h√†ng</th>
                  <th>Li√™n h·ªá</th>
                  <th>Gi·∫£m</th>
                  <th>Th√†nh ti·ªÅn</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody id="ctvUsageBody">
                <tr>
                  <td colspan="7" class="loading">ƒêang t·∫£i...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeCtvUsageModal()">ƒê√≥ng</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="globalToast"></div>

  <style>
    /* SKU Selector for Coupons */
    .sku-selector {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .sku-selector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .sku-selector-header label {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .sku-toggle-all {
      font-size: 12px;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }

    .sku-checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .sku-checkbox-item input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }

    .sku-checkbox-item label {
      cursor: pointer;
      color: var(--text);
    }

    /* Coupon Result */
    .coupon-result {
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      display: none;
      /* Hidden by default */
    }

    .coupon-result.error {
      background-color: var(--red-light);
      color: var(--red);
      border: 1px solid var(--red);
    }

    .coupon-result.success {
      background-color: var(--green-light);
      color: var(--green);
      border: 1px solid var(--green);
    }

    .coupon-link-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
    }
  </style>

  <script>
    // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function resolveBase() {
      const qs = new URLSearchParams(location.search);
      const fromQuery = (qs.get('base') || '').trim();
      if (fromQuery) return fromQuery.replace(/\/+$/, '');
      if (location.protocol === 'file:') return 'http://localhost:8888/.netlify/functions';
      return '/.netlify/functions';
    }

    const BASE = resolveBase();
    let ADMIN_TOKEN = '';
    const POLL_INTERVAL = 10000;
    let pollTimer = null;

    // SKUs to hide from the grid (discontinued)
    var SKU_HIDDEN = { chatgpt_plus_3m: true, chatgpt_code_1m_vn: true };

    // SKU metadata
    var SKU_META = {
      chatgpt_plus_1m: { icon: '\u{1F916}', name: 'ChatGPT Plus 1 th√°ng' },
      chatgpt_plus_3m: { icon: '\u{1F916}', name: 'ChatGPT Plus 3 th√°ng (ng·ª´ng b√°n)' },
      chatgpt_code_1m_vn: { icon: '\u{1F4BB}', name: 'Code ChatGPT 1 th√°ng (VN)' },
      grok_7d: { icon: '\u{1F9E0}', name: 'Grok 7 ng√†y' },
      netflix_1m: { icon: '\u{1F3AC}', name: 'Netflix 1 th√°ng' },
      spotify_premium_1m: { icon: '\u{1F3B5}', name: 'Spotify Premium 1 th√°ng' },
      youtube_premium_1m: { icon: '\u{25B6}\u{FE0F}', name: 'YouTube Premium 1 th√°ng' },
      canva_pro_1y: { icon: '\u{1F3A8}', name: 'Canva Pro 1 nƒÉm' },
      capcut_pro_1y: { icon: '\u{1F3AC}', name: 'CapCut Pro 1 nƒÉm' },
      capcut_7d: { icon: '\u{1F3AC}', name: 'CapCut 7 ng√†y' },
      capcut_14d: { icon: '\u{1F3AC}', name: 'CapCut 14 ng√†y' },
      capcut_1m: { icon: '\u{1F3AC}', name: 'CapCut Pro 1 th√°ng' },
      capcut_6m: { icon: '\u{1F3AC}', name: 'CapCut Pro 6 th√°ng' },
      adobe_1m: { icon: '\u{1F58C}\u{FE0F}', name: 'Adobe 1 th√°ng' },
      microsoft365_1y: { icon: '\u{1F4BC}', name: 'Microsoft 365 1 nƒÉm' },
      duolingo_1m: { icon: '\u{1F989}', name: 'Duolingo Plus 1 th√°ng' },
      quizlet_1m: { icon: '\u{1F4DA}', name: 'Quizlet Plus 1 th√°ng' }
    };

    // ‚îÄ‚îÄ COUPONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _allSkus = [];

    // Auto-set default expiry to 7 days from now
    (function setDefaultExpiry() {
      var el = document.getElementById('couponExpiry');
      if (!el) return;
      var d = new Date();
      d.setDate(d.getDate() + 7);
      el.value = d.toISOString().slice(0, 16);
    })();

    // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function doLogin() {
      var t = document.getElementById('tokenInput').value.trim();
      var errEl = document.getElementById('loginErr');
      if (!t) { errEl.textContent = 'Vui l√≤ng nh·∫≠p token.'; return; }
      errEl.textContent = 'ƒêang x√°c th·ª±c...';
      try {
        var r = await fetch(BASE + '/admin-orders', { headers: { Authorization: 'Bearer ' + t } });
        if (r.status === 401) {
          errEl.textContent = 'Token kh√¥ng h·ª£p l·ªá';
          return;
        }
        if (!r.ok) {
          errEl.textContent = 'Server l·ªói (HTTP ' + r.status + '). Th·ª≠ l·∫°i sau.';
          return;
        }
        // ƒê·∫£m b·∫£o response parse ƒë∆∞·ª£c
        var data = await r.json();
        ADMIN_TOKEN = t;
        sessionStorage.setItem('tbq_admin_token', t);
        errEl.textContent = '';
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('shell').style.display = 'flex';
        startAutoRefresh();
        loadDashboard();
      } catch (e) {
        console.error('Login error:', e);
        var hint = (location.protocol === 'file:')
          ? 'B·∫°n ƒëang m·ªü b·∫±ng file://. H√£y ch·∫°y "netlify dev" v√† m·ªü admin t·∫°i http://localhost:8888/admin.html.'
          : 'Ki·ªÉm tra m·∫°ng / endpoint Netlify Functions.';
        errEl.textContent = 'Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß. (' + hint + ')';
      }
    }

    // Auto-restore session (ch·ªâ g√°n token, validate ·ªü window.onload)
    (function () {
      var saved = sessionStorage.getItem('tbq_admin_token');
      if (saved) ADMIN_TOKEN = saved;
    })();

    // ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function nav(page) {
      document.querySelectorAll('.nav-item').forEach(function (n) { n.classList.remove('active'); });
      // For sidebar nav items, highlight active; for footer links (e.g. logs), no highlight
      if (event && event.currentTarget && event.currentTarget.classList.contains('nav-item')) {
        event.currentTarget.classList.add('active');
      }
      document.querySelectorAll('.page').forEach(function (p) { p.classList.remove('active'); });
      document.getElementById('page-' + page).classList.add('active');
      var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, products: loadProducts, customers: loadCustomers, logs: loadLogs, promotions: loadPromotions };
      if (loaders[page]) loaders[page]();
    }

    // ‚îÄ‚îÄ PROMOTIONS HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadPromotions() {
      loadDiscounts();
      loadCoupons();
    }

    function switchPromoTab(tab) {
      document.querySelectorAll('.promo-tab').forEach(function (t) { t.classList.remove('active'); });
      document.querySelectorAll('.promo-content').forEach(function (c) { c.classList.remove('active'); });
      if (tab === 'ctv') {
        document.querySelector('.promo-tab:nth-child(1)').classList.add('active');
        document.getElementById('promo-ctv').classList.add('active');
        loadDiscounts();
      } else {
        document.querySelector('.promo-tab:nth-child(2)').classList.add('active');
        document.getElementById('promo-coupon').classList.add('active');
        loadCoupons();
      }
    }

    // ‚îÄ‚îÄ AUTO REFRESH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startAutoRefresh() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(function () {
        var active = document.querySelector('.page.active');
        if (!active) return;
        var id = active.id.replace('page-', '');
        var loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs, promotions: loadPromotions };
        if (loaders[id]) loaders[id]();
      }, POLL_INTERVAL);
    }

    // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function authHeaders() {
      return { Authorization: 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' };
    }
    function fmtTime(iso) {
      if (!iso) return '--';
      try { return new Date(iso).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'medium' }); } catch (e) { return iso; }
    }
    function fmtVND(n) { return (Number(n) || 0).toLocaleString('vi-VN') + '‚Ç´'; }
    function badgeClass(s) {
      var map = {
        pending_payment: 'badge-pending', paid: 'badge-paid', fulfilled: 'badge-fulfilled',
        failed: 'badge-failed', cancelled: 'badge-cancelled', expired: 'badge-expired', refunded: 'badge-refunded'
      };
      return map[s] || 'badge-pending';
    }
    function badgeLabel(s) {
      var map = { pending_payment: 'Ch·ªù TT', paid: 'ƒê√£ TT', fulfilled: 'ƒê√£ giao', failed: 'L·ªói', cancelled: 'Hu·ª∑', expired: 'H·∫øt h·∫°n', refunded: 'Ho√†n ti·ªÅn' };
      return map[s] || s;
    }
    function escHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function escAttr(s) { return String(s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
    function updateClock() { document.getElementById('lastSync').textContent = new Date().toLocaleTimeString('vi-VN'); }

    function showToast(msg) {
      var t = document.getElementById('globalToast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(function () { t.classList.remove('show'); }, 2500);
    }

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () { showToast('ƒê√£ sao ch√©p!'); });
      }
    }

    function getSkuName(code) {
      var m = SKU_META[code];
      return m ? m.name : code;
    }
    function getSkuIcon(code) {
      var m = SKU_META[code];
      return m ? m.icon : '\u{1F4E6}';
    }

    // ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDashboard() {
      try {
        var r = await fetch(BASE + '/admin-orders?limit=10', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var s = data.stats || {};
        document.getElementById('statTotal').textContent = s.total || 0;
        document.getElementById('statPending').textContent = s.pending || 0;
        document.getElementById('statFulfilled').textContent = s.delivered || s.fulfilled || 0;
        document.getElementById('statRevenue').textContent = fmtVND(s.total_revenue || 0);

        var rows = data.orders || [];
        document.getElementById('dashboardOrders').innerHTML = rows.length
          ? rows.map(function (o) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(o.order_code) + '</td>' +
              '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
              '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
              '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
              '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="5" class="empty">Ch∆∞a c√≥ ƒë∆°n n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] dashboard', e); }
    }

    // ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var _expandedOrder = null;
    var _orderCredCache = {};

    function setOrderTab(status) {
      document.getElementById('orderStatusFilter').value = status || '';
      document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
        t.classList.toggle('active', (t.dataset.status || '') === (status || ''));
      });
      loadOrders();
    }

    function setOrderTabFromFilter() {
      var v = document.getElementById('orderStatusFilter').value;
      document.querySelectorAll('.order-management .order-tab').forEach(function (t) {
        t.classList.toggle('active', (t.dataset.status || '') === (v || ''));
      });
    }

    async function loadOrders() {
      try {
        var status = document.getElementById('orderStatusFilter').value;
        var search = document.getElementById('orderSearch').value.trim();
        var url = BASE + '/admin-orders?limit=200';
        if (status) url += '&status=' + status;

        var r = await fetch(url, { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();

        var stats = data.stats || {};
        document.getElementById('orderStatTotal').textContent = stats.total != null ? stats.total : '--';
        document.getElementById('orderStatPending').textContent = stats.pending != null ? stats.pending : '--';
        document.getElementById('orderStatDelivered').textContent = stats.delivered != null ? stats.delivered : '--';
        var errCount = (stats.error_count || 0) + (stats.expired || 0);
        document.getElementById('orderStatError').textContent = errCount;

        var rows = data.orders || [];
        var byCode = {};
        rows.forEach(function (o) {
          var code = o.order_code || o.id || '';
          if (!code) return;
          if (!byCode[code]) byCode[code] = { order: o, products: [] };
          if (o.product_name && byCode[code].products.indexOf(o.product_name) === -1) byCode[code].products.push(o.product_name);
        });
        var list = Object.keys(byCode).map(function (code) {
          var rec = byCode[code].order;
          if (!rec.order_code) rec.order_code = code;
          return rec;
        });

        if (search) {
          var q = search.toLowerCase();
          list = list.filter(function (o) {
            return (o.order_code || '').toLowerCase().includes(q) ||
              (o.customer_email || o.customerEmail || '').toLowerCase().includes(q) ||
              (o.customer_name || o.customerName || '').toLowerCase().includes(q);
          });
        }

        var deliveryBase = (location.protocol === 'file:' ? 'http://localhost:8888' : location.origin) + (location.protocol === 'file:' ? '' : location.pathname.replace(/admin\.html.*$/, ''));

        var html = '';
        list.forEach(function (o, i) {
          var products = (byCode[o.order_code] && byCode[o.order_code].products && byCode[o.order_code].products.length)
            ? byCode[o.order_code].products.join(', ') : (o.product_name || '--');
          var deliveryUrl = o.delivery_token ? (deliveryBase + '/.netlify/functions/delivery?token=' + encodeURIComponent(o.delivery_token) + '&order=' + encodeURIComponent(o.order_code)) : '';
          var actionHtml = '';
          // Quick fulfill button ‚Äî only for paid orders
          if (o.status === 'paid') actionHtml += '<button onclick="event.stopPropagation();quickFulfill(\'' + escAttr(o.order_code) + '\')" class="btn-ghost" style="margin-right:2px;font-size:11px;padding:2px 6px;color:#10b981" title="Chuy·ªÉn sang ƒê√£ giao">‚úÖ</button>';
          // Copy delivery link
          if (deliveryUrl) actionHtml += '<button onclick="event.stopPropagation();copyDeliveryLink(\'' + escAttr(deliveryUrl) + '\')" class="btn-ghost" style="margin-right:2px;font-size:11px;padding:2px 6px" title="Copy link giao h√†ng">üîó</button>';
          // Copy order info
          actionHtml += '<button onclick="event.stopPropagation();copyOrderInfo(\'' + escAttr(o.order_code) + '\',\'' + escAttr(o.customer_name || o.customerName || '') + '\',\'' + escAttr(o.customer_phone || '') + '\',\'' + escAttr(products) + '\')" class="btn-ghost" style="margin-right:2px;font-size:11px;padding:2px 6px" title="Copy th√¥ng tin ƒë∆°n">üìã</button>';
          actionHtml += '<button onclick="event.stopPropagation();openEditOrderModal(\'' + escAttr(o.order_code) + '\')" class="btn-ghost primary" style="margin-right:2px;font-size:11px;padding:2px 6px">S·ª≠a</button>';
          actionHtml += '<button onclick="event.stopPropagation();deleteOrder(\'' + escAttr(o.order_code) + '\')" class="btn-ghost danger" style="font-size:11px;padding:2px 6px">Xo√°</button>';

          var isExpanded = _expandedOrder === o.order_code;
          html += '<tr style="cursor:pointer" onclick="toggleOrderDetail(\'' + escAttr(o.order_code) + '\', this)">' +
            '<td>' + (i + 1) + '</td>' +
            '<td class="col-code">' + escHtml(o.order_code) + '</td>' +
            '<td>' + escHtml(o.customer_name || o.customerName || '--') + '</td>' +
            '<td style="color:var(--text2)">' + escHtml(o.customer_email || o.customerEmail || '--') + '</td>' +
            '<td style="max-width:160px;overflow:hidden;text-overflow:ellipsis" title="' + escAttr(products) + '">' + escHtml(products) + '</td>' +
            '<td>' + fmtVND(o.amount_total || o.price) + '</td>' +
            '<td><span class="badge ' + badgeClass(o.status) + '">' + badgeLabel(o.status) + '</span></td>' +
            '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td>' +
            '<td class="col-actions" onclick="event.stopPropagation()">' + actionHtml + '</td></tr>';;

          // Detail row (hidden by default)
          html += '<tr class="order-detail-row" id="detail-' + escAttr(o.order_code) + '" style="display:' + (isExpanded ? 'table-row' : 'none') + '">' +
            '<td colspan="9"><div class="order-detail-panel" id="detail-panel-' + escAttr(o.order_code) + '">' +
            (isExpanded ? '' : '<div class="cred-loading">ƒêang t·∫£i...</div>') +
            '</div></td></tr>';
        });

        document.getElementById('ordersBody').innerHTML = html || '<tr><td colspan="9" class="empty">Kh√¥ng c√≥ ƒë∆°n n√†o</td></tr>';

        // Re-load expanded order detail if any
        if (_expandedOrder && _orderCredCache[_expandedOrder]) {
          renderOrderDetail(_expandedOrder, _orderCredCache[_expandedOrder]);
        }

        updateClock();
      } catch (e) { console.error('[admin] orders', e); }
    }

    async function toggleOrderDetail(orderCode, rowEl) {
      var detailRow = document.getElementById('detail-' + orderCode);
      if (!detailRow) return;

      if (_expandedOrder === orderCode) {
        // Collapse
        detailRow.style.display = 'none';
        _expandedOrder = null;
        return;
      }

      // Collapse previous
      if (_expandedOrder) {
        var prev = document.getElementById('detail-' + _expandedOrder);
        if (prev) prev.style.display = 'none';
      }

      _expandedOrder = orderCode;
      detailRow.style.display = 'table-row';

      // Check cache
      if (_orderCredCache[orderCode]) {
        renderOrderDetail(orderCode, _orderCredCache[orderCode]);
        return;
      }

      // Fetch
      var panel = document.getElementById('detail-panel-' + orderCode);
      if (panel) panel.innerHTML = '<div class="cred-loading">ƒêang t·∫£i th√¥ng tin t√†i kho·∫£n...</div>';

      try {
        var r = await fetch(BASE + '/admin-orders?action=order_detail&order_code=' + encodeURIComponent(orderCode), { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        _orderCredCache[orderCode] = data;
        renderOrderDetail(orderCode, data);
      } catch (e) {
        if (panel) panel.innerHTML = '<div class="cred-loading" style="color:var(--red)">L·ªói t·∫£i d·ªØ li·ªáu: ' + escHtml(e.message) + '</div>';
      }
    }

    function renderOrderDetail(orderCode, data) {
      var panel = document.getElementById('detail-panel-' + orderCode);
      if (!panel) return;

      var creds = data.credentials || [];
      var lines = data.lines || [];

      if (creds.length === 0 && lines.length === 0) {
        panel.innerHTML = '<div class="cred-empty">Kh√¥ng c√≥ th√¥ng tin t√†i kho·∫£n (ƒë∆°n ƒë·∫∑t tr∆∞·ªõc ho·∫∑c ch∆∞a nh·∫≠p kho)</div>';
        return;
      }

      var html = '';

      // Show order lines info
      if (lines.length > 0) {
        html += '<div style="margin-bottom:12px;font-size:13px;color:var(--text2)">S·∫£n ph·∫©m: ' +
          lines.map(function (l) { return '<strong>' + escHtml(l.sku_name || l.product_name || l.sku_code || '--') + '</strong>'; }).join(', ') +
          '</div>';
      }

      if (creds.length === 0) {
        html += '<div class="cred-empty">Ch∆∞a c√≥ t√†i kho·∫£n ƒë∆∞·ª£c g√°n cho ƒë∆°n n√†y</div>';
      } else {
        html += '<div class="cred-cards">';
        creds.forEach(function (c, idx) {
          var note = c.note || '';
          var twofa = '';
          // Extract 2FA from note if present
          if (note.indexOf('2FA:') === 0) {
            var parts = note.split('|');
            twofa = parts[0].replace('2FA:', '').trim();
            note = parts.slice(1).join('|').trim();
          } else if (note && !note.includes(' ') && note.length < 40) {
            twofa = note;
            note = '';
          }

          html += '<div class="cred-card">' +
            '<div class="cred-sku">' + escHtml(c.sku_name || c.sku_code || 'T√†i kho·∫£n ' + (idx + 1)) +
            ' <span class="badge ' + (c.stock_status === 'sold' ? 'badge-fulfilled' : c.stock_status === 'reserved' ? 'badge-paid' : 'badge-pending') + '" style="font-size:10px;padding:2px 8px">' + escHtml(c.stock_status || '--') + '</span></div>' +
            '<div class="cred-field">' +
            '<span class="cred-label">TK</span>' +
            '<span class="cred-value">' + escHtml(c.account_info || '--') + '</span>' +
            '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.account_info || '') + '\')">üìã</button>' +
            '</div>' +
            '<div class="cred-field">' +
            '<span class="cred-label">MK</span>' +
            '<span class="cred-value blurred" id="mk-' + orderCode + '-' + idx + '" onclick="this.classList.remove(\'blurred\')">' + escHtml(c.secret_key || '--') + '</span>' +
            '<button class="cred-btn" onclick="event.stopPropagation();document.getElementById(\'mk-' + orderCode + '-' + idx + '\').classList.remove(\'blurred\')" title="Hi·ªán">üëÅ</button>' +
            '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(c.secret_key || '') + '\')">üìã</button>' +
            '</div>';

          if (twofa) {
            html += '<div class="cred-field">' +
              '<span class="cred-label">2FA</span>' +
              '<span class="cred-value" style="color:var(--accent)">' + escHtml(twofa) + '</span>' +
              '<button class="cred-btn" onclick="event.stopPropagation();copyText(\'' + escAttr(twofa) + '\')">üìã</button>' +
              '</div>';
          }

          if (note) {
            html += '<div class="cred-field">' +
              '<span class="cred-label" style="min-width:auto">Note</span>' +
              '<span class="cred-value" style="font-family:inherit;font-size:12px;color:var(--text2)">' + escHtml(note) + '</span>' +
              '</div>';
          }

          html += '</div>';
        });
        html += '</div>';

        // Copy all button
        html += '<button style="margin-top:10px;padding:6px 14px;border-radius:6px;font-size:12px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-family:inherit" onclick="event.stopPropagation();copyAllCreds(\'' + escAttr(orderCode) + '\')">üìã Sao ch√©p t·∫•t c·∫£</button>';
      }

      panel.innerHTML = html;
    }

    function copyAllCreds(orderCode) {
      var data = _orderCredCache[orderCode];
      if (!data || !data.credentials) return;
      var text = data.credentials.map(function (c, i) {
        var note = c.note || '';
        var twofa = '';
        if (note.indexOf('2FA:') === 0) {
          var parts = note.split('|');
          twofa = parts[0].replace('2FA:', '').trim();
        } else if (note && !note.includes(' ') && note.length < 40) {
          twofa = note;
        }
        return 'TK: ' + (c.account_info || '') + '\nMK: ' + (c.secret_key || '') + (twofa ? '\n2FA: ' + twofa : '');
      }).join('\n---\n');
      copyText(text);
    }

    // ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setInventoryStatus(msg, isError) {
      var el = document.getElementById('inventoryStatus');
      if (el) { el.textContent = msg; el.className = 'inventory-status' + (isError ? ' error' : ''); }
    }

    async function loadInventory() {
      var btn = document.getElementById('inventoryRefreshBtn');
      setInventoryStatus('ƒêang t·∫£i...');
      if (btn) btn.disabled = true;
      try {
        var r = await fetch(BASE + '/inventory?action=all');
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        var data = await r.json();
        var rows = data.inventory || [];
        window._lastInventoryRows = rows;

        // Render SKU card grid (only auto delivery = giao lien)
        renderSkuGrid(rows);

        // Populate advanced import SKU dropdown
        populateSkuDropdown(rows);

        // Render summary table (exclude hidden SKUs)
        var visibleRows = rows.filter(function (r) { return !SKU_HIDDEN[(r.sku || r.product_code || '').trim()]; });
        document.getElementById('inventoryBody').innerHTML = visibleRows.length
          ? visibleRows.map(function (i) {
            var avail = i.available || i.available_units || 0;
            var isPreorder = (i.delivery_type || 'auto') === 'owner_upgrade';
            return '<tr>' +
              '<td style="font-weight:600">' + escHtml(i.sku || i.code || i.product_code) + '</td>' +
              '<td style="color:var(--green);font-weight:600">' + (isPreorder ? 'N/A' : avail) + '</td>' +
              '<td style="color:var(--red)">' + (i.sold_units || i.sold || 0) + '</td>' +
              '<td style="color:var(--yellow)">' + (i.reserved_units || i.reserved || 0) + '</td>' +
              '<td>' + (i.total || i.total_units || 0) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="5" class="empty">Ch∆∞a c√≥ h√†ng trong kho</td></tr>';

        setInventoryStatus('');
        updateClock();
      } catch (e) {
        console.error('[admin] inventory', e);
        setInventoryStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c. Ch·∫°y netlify dev v√† m·ªü http://localhost:8888/admin.html', true);
      }
      if (btn) btn.disabled = false;
    }

    function renderSkuGrid(rows) {
      var tbody = document.getElementById('skuListBody');
      if (!tbody) return;

      // Filter to only auto delivery (giao lien) SKUs, exclude hidden
      var autoSkus = rows.filter(function (r) {
        var sku = (r.sku || r.product_code || '').trim();
        return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku];
      });

      if (autoSkus.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Ch∆∞a c√≥ SKU giao li·ªÅn n√†o</td></tr>';
        return;
      }

      // Sort: out of stock first, then by name
      autoSkus.sort(function (a, b) {
        var aAvail = a.available || 0;
        var bAvail = b.available || 0;
        if (aAvail === 0 && bAvail > 0) return -1;
        if (aAvail > 0 && bAvail === 0) return 1;
        return (getSkuName(a.sku || a.product_code) || '').localeCompare(getSkuName(b.sku || b.product_code) || '');
      });

      tbody.innerHTML = autoSkus.map(function (r) {
        var sku = r.sku || r.product_code || '';
        var avail = r.available || 0;
        var sold = r.sold_units || r.sold || 0;
        var total = r.total || r.total_units || 0;
        var badgeClass = avail === 0 ? 'red' : avail <= 3 ? 'orange' : 'green';

        return '<tr style="cursor:pointer" onclick="openPasteImportForSku(\'' + escAttr(sku) + '\')">' +
          '<td style="font-size:24px;text-align:center">' + getSkuIcon(sku) + '</td>' +
          '<td><code style="font-size:12px;color:var(--text2)">' + escHtml(sku) + '</code></td>' +
          '<td style="font-weight:600">' + escHtml(getSkuName(sku)) + '</td>' +
          '<td><span class="stock-badge ' + badgeClass + '">' + avail + '</span></td>' +
          '<td style="color:var(--text2)">' + sold + '</td>' +
          '<td style="font-weight:600">' + total + '</td>' +
          '<td><button class="btn-primary-sm" onclick="event.stopPropagation();openPasteImportForSku(\'' + escAttr(sku) + '\')">+ Nh·∫≠p kho</button></td>' +
          '</tr>';
      }).join('');
    }

    function populateSkuDropdown(rows) {
      // Hidden select (backward compat)
      var sel = document.getElementById('superProfileSku');
      var autoSkus = rows.filter(function (r) { var sku = (r.sku || r.product_code || '').trim(); return (r.delivery_type || 'auto') === 'auto' && !SKU_HIDDEN[sku]; });
      if (sel) {
        sel.innerHTML = '<option value="">-- Ch·ªçn SKU --</option>' +
          autoSkus.map(function (r) {
            var sku = r.sku || r.product_code || '';
            return '<option value="' + escAttr(sku) + '">' + escHtml(getSkuName(sku)) + '</option>';
          }).join('');
      }
      // Render chips
      var chipContainer = document.getElementById('qiTypeChips');
      if (!chipContainer) return;
      var chipsHtml = '<button type="button" class="qi-chip active" data-sku="" onclick="selectSkuChip(this)">üîç T·ª± ƒëo√°n</button>';
      autoSkus.forEach(function (r) {
        var sku = r.sku || r.product_code || '';
        var meta = SKU_META[sku];
        var icon = meta ? meta.icon : 'üì¶';
        var shortName = meta ? meta.name.replace(/ 1 (th√°ng|nƒÉm)/, '').replace(/ 7 ng√†y/, ' 7d').replace(/ 14 ng√†y/, ' 14d') : sku;
        var avail = r.available || 0;
        chipsHtml += '<button type="button" class="qi-chip" data-sku="' + escAttr(sku) + '" onclick="selectSkuChip(this)">' +
          icon + ' ' + escHtml(shortName) +
          (avail > 0 ? '' : ' <span style="color:var(--red);font-size:11px">‚ö†0</span>') +
          '</button>';
      });
      chipContainer.innerHTML = chipsHtml;
    }

    function selectSkuChip(el) {
      // Toggle active state
      var container = el.parentElement;
      container.querySelectorAll('.qi-chip').forEach(function (c) { c.classList.remove('active'); });
      el.classList.add('active');
      // Sync to hidden select
      var sku = el.dataset.sku || '';
      var sel = document.getElementById('superProfileSku');
      if (sel) sel.value = sku;
    }

    // ‚îÄ‚îÄ PASTE IMPORT / VIEW STOCK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window._pasteImportSku = '';

    function openPasteImportForSku(skuCode) {
      window._pasteImportSku = skuCode;
      document.getElementById('pasteImportTitle').textContent = 'Qu·∫£n l√Ω kho: ' + getSkuName(skuCode);

      // Reset tabs
      switchPasteTab('list');

      document.getElementById('pasteImportModal').classList.add('show');
    }

    function closePasteImportModal() {
      document.getElementById('pasteImportModal').classList.remove('show');
      window._pasteImportSku = '';
    }

    function switchPasteTab(tab) {
      document.querySelectorAll('.paste-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('content-' + tab).classList.add('active');

      if (tab === 'list') {
        loadSkuDetails();
      } else if (tab === 'import') {
        document.getElementById('pasteImportText').value = '';
        document.getElementById('pasteImportFeedback').textContent = '';
        document.getElementById('pastePreview').innerHTML = '';
        setTimeout(() => document.getElementById('pasteImportText').focus(), 100);
      }
    }

    async function loadSkuDetails() {
      if (!window._pasteImportSku) return;
      const tbody = document.getElementById('skuDetailsBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">ƒêang t·∫£i...</td></tr>';
      document.getElementById('skuListCount').textContent = '';

      try {
        const r = await fetch(BASE + '/admin-inventory?action=sku_details&sku=' + window._pasteImportSku, { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        const data = await r.json();
        const items = data.items || [];

        document.getElementById('skuListCount').textContent = items.length + ' m·ª•c';

        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">Ch∆∞a c√≥ h√†ng trong kho</td></tr>';
          return;
        }

        tbody.innerHTML = items.map((item, i) => {
          const isSold = item.status === 'sold';
          const statusClass = item.status === 'available' ? 'badge-fulfilled' : (isSold ? 'badge-cancelled' : 'badge-pending');
          const statusLabel = item.status === 'available' ? 'S·∫µn s√†ng' : (isSold ? 'ƒê√£ b√°n' : 'ƒêang gi·ªØ');

          // Note logic
          let note = item.note || '';
          let twofa = '';
          if (note.indexOf('2FA:') === 0) {
            const parts = note.split('|');
            twofa = parts[0].replace('2FA:', '').trim();
            note = parts.slice(1).join('|').trim();
          } else if (note && !note.includes(' ') && note.length < 40) {
            twofa = note;
            note = '';
          }
          const displayNote = (twofa ? '<span style="color:var(--accent);font-family:monospace">2FA: ' + escHtml(twofa) + '</span>' : '') +
            (note ? (twofa ? '<br>' : '') + '<span style="color:var(--text2)">' + escHtml(note) + '</span>' : '');

          // Sold info
          const soldInfo = isSold && item.order_code ? '<div style="font-size:11px;color:var(--text2)">ƒê∆°n: ' + escHtml(item.order_code) + '</div>' : '';

          // Actions: Edit + Delete for available items
          const actionHtml = item.status === 'available'
            ? '<button class="btn-ghost primary" style="font-size:11px;margin-right:4px" onclick="openEditStockItemModal(\'' + item.id + '\',\'' + escAttr(item.account_info || '') + '\',\'' + escAttr(item.secret_key || '') + '\',\'' + escAttr(item.note || '') + '\')">S·ª≠a</button>' +
            '<button class="btn-del" onclick="deleteStockItem(\'' + item.id + '\')">Xo√°</button>'
            : '<span style="color:var(--text-muted);font-size:11px">--</span>';

          return `
                <tr>
                    <td>${i + 1}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis" title="${escAttr(item.account_info)}">
                        <div style="font-weight:600">${escHtml(item.account_info)}</div>
                        <div style="font-family:monospace;color:var(--text2);font-size:11px">
                             <span class="blurred" onclick="this.classList.remove('blurred')">${escHtml(item.secret_key || '--')}</span>
                             <button style="border:none;background:none;cursor:pointer;opacity:0.6" onclick="copyText('${escAttr(item.secret_key)}')">üìã</button>
                        </div>
                    </td>
                    <td>${displayNote || '--'}</td>
                    <td>
                        <span class="badge ${statusClass}" style="padding:2px 8px;font-size:10px">${statusLabel}</span>
                        ${soldInfo}
                    </td>
                    <td style="color:var(--text2);font-size:11px">${fmtTime(item.created_at)}</td>
                    <td class="col-actions">${actionHtml}</td>
                </tr>
            `;
        }).join('');

      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" class="loading" style="color:var(--red)">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
      }
    }

    async function deleteStockItem(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° m·ª•c n√†y kh·ªèi kho?')) return;
      try {
        const r = await fetch(BASE + '/admin-inventory?action=delete_item', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ id: id })
        });
        const data = await r.json();
        if (data.success) {
          showToast('ƒê√£ xo√° th√†nh c√¥ng');
          loadSkuDetails(); // Reload list
          loadInventory();   // Reload summaries
        } else {
          alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ xo√°'));
        }
      } catch (e) {
        alert('L·ªói m·∫°ng: ' + e.message);
      }
    }

    function parsePasteLines(text) {
      return text.split(/\n/).map(function (line) {
        var trimmed = line.trim();
        if (!trimmed) return null;
        // Support: pipe, colon, tab, multiple spaces
        var parts = trimmed.split(/[|:\t]+/);
        if (parts.length < 2) {
          // Try splitting by 2+ spaces
          parts = trimmed.split(/\s{2,}/);
        }
        return {
          account_info: (parts[0] || '').trim(),
          secret_key: (parts[1] || '').trim(),
          note: (parts[2] || '').trim()
        };
      }).filter(function (row) { return row && row.account_info !== ''; });
    }

    function previewPasteLines() {
      var text = (document.getElementById('pasteImportText').value || '').trim();
      var previewEl = document.getElementById('pastePreview');
      if (!text) { previewEl.innerHTML = ''; return; }

      var rows = parsePasteLines(text);
      if (rows.length === 0) { previewEl.innerHTML = ''; return; }

      var html = '<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">' + rows.length + ' t√†i kho·∫£n</div>';
      rows.slice(0, 10).forEach(function (r) {
        html += '<div class="preview-line">' +
          '<span class="pv-account">' + escHtml(r.account_info) + '</span>' +
          '<span class="pv-pass">' + (r.secret_key ? '******' : '--') + '</span>' +
          (r.note ? '<span class="pv-2fa">' + escHtml(r.note) + '</span>' : '') +
          '</div>';
      });
      if (rows.length > 10) {
        html += '<div style="color:var(--text-muted);font-size:11px;padding:4px 0">... v√† ' + (rows.length - 10) + ' d√≤ng n·ªØa</div>';
      }
      previewEl.innerHTML = html;
    }

    async function submitPasteImport() {
      var sku = window._pasteImportSku;
      if (!sku) return;
      var raw = (document.getElementById('pasteImportText').value || '').trim();
      var fb = document.getElementById('pasteImportFeedback');
      if (!raw) { fb.textContent = 'D√°n √≠t nh·∫•t m·ªôt d√≤ng tk|mk|2fa.'; fb.style.color = 'var(--yellow)'; return; }

      var rows = parsePasteLines(raw);
      if (rows.length === 0) { fb.textContent = 'M·ªói d√≤ng c·∫ßn c√≥ √≠t nh·∫•t ph·∫ßn t√†i kho·∫£n.'; fb.style.color = 'var(--yellow)'; return; }

      fb.textContent = 'ƒêang nh·∫≠p ' + rows.length + ' d√≤ng...';
      fb.style.color = 'var(--text2)';

      var items = rows.map(function (r) {
        var note = r.note ? ('2FA: ' + r.note) : '';
        return { sku_code: sku, account_info: r.account_info, secret_key: r.secret_key, note: note };
      });

      try {
        var r = await fetch(BASE + '/import-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { fb.textContent = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i.'; fb.style.color = 'var(--red)'; return; }
        if (!r.ok) { fb.textContent = 'L·ªói: ' + (data.error || data.message || r.status); fb.style.color = 'var(--red)'; return; }

        fb.style.color = 'var(--green)';
        fb.textContent = 'ƒê√£ th√™m ' + (data.inserted || 0) + ', tr√πng ' + (data.skipped_duplicate || 0) + '.';
        showToast('ƒê√£ nh·∫≠p ' + (data.inserted || 0) + ' t√†i kho·∫£n v√†o ' + getSkuName(sku));
        loadInventory();
        document.getElementById('pasteImportText').value = '';
        document.getElementById('pastePreview').innerHTML = '';
        setTimeout(closePasteImportModal, 1200);
      } catch (e) {
        fb.textContent = 'L·ªói m·∫°ng: ' + e.message;
        fb.style.color = 'var(--red)';
      }
    }

    // ‚îÄ‚îÄ ADVANCED IMPORT (toggle) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleAdvancedImport() {
      var btn = document.getElementById('advancedToggle');
      var content = document.getElementById('advancedContent');
      btn.classList.toggle('open');
      content.classList.toggle('show');
    }

    // ‚îÄ‚îÄ NHAP KHO SIEU NHANH (parse -> preview -> import) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var LAST_USED_SKU_KEY = 'tbq_last_used_sku';
    var _superParsedRows = [];

    /* ‚îÄ‚îÄ Quick Import: 1-click parse + preview ‚îÄ‚îÄ */
    async function doQuickImport() {
      var raw = (document.getElementById('superPasteRaw') && document.getElementById('superPasteRaw').value) ? document.getElementById('superPasteRaw').value.trim() : '';
      var fb = document.getElementById('superParseFeedback');
      if (!raw) { if (fb) fb.textContent = 'D√°n d·ªØ li·ªáu v√†o √¥ tr√™n r·ªìi b·∫•m Nh·∫≠p kho.'; return; }
      if (fb) fb.textContent = '‚è≥ ƒêang ph√¢n t√≠ch...';
      var profileSku = (document.getElementById('superProfileSku') && document.getElementById('superProfileSku').value) || '';
      var lastUsedSku = localStorage.getItem(LAST_USED_SKU_KEY) || '';
      try {
        var r = await fetch(BASE + '/parse-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ raw: raw, last_used_sku: lastUsedSku || undefined, profile_sku: profileSku || undefined })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { if (fb) fb.textContent = 'Token h·∫øt h·∫°n ‚Äî ƒëƒÉng nh·∫≠p l·∫°i.'; return; }
        if (!r.ok) { if (fb) fb.textContent = 'L·ªói: ' + (data.error || r.status); return; }
        _superParsedRows = data.rows || [];
        if (fb) fb.textContent = '';
        renderPreviewCards();
        document.getElementById('superPreviewWrap').style.display = '';
        fillSuperApplySkuSelect();
      } catch (e) {
        if (fb) fb.textContent = 'L·ªói: ' + e.message;
      }
    }

    // Also keep doParseStock as alias
    var doParseStock = doQuickImport;

    function fillSuperApplySkuSelect() {
      var sel = document.getElementById('superApplySkuSelect');
      if (!sel) return;
      var rows = (window._lastInventoryRows || []).filter(function (r) {
        return (r.delivery_type || 'auto') === 'auto';
      });
      sel.innerHTML = '<option value="">-- SKU --</option>' + rows.map(function (r) {
        var sku = r.sku_code || '';
        return '<option value="' + escAttr(sku) + '">' + escHtml(getSkuName(sku)) + '</option>';
      }).join('');
    }

    function renderPreviewCards() {
      var container = document.getElementById('superPreviewCards');
      var statsEl = document.getElementById('qiPreviewStats');
      var countEl = document.getElementById('qiConfirmCount');
      if (!container) return;
      var rows = _superParsedRows;
      if (!rows.length) { container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text2)">Kh√¥ng c√≥ d√≤ng n√†o</div>'; return; }

      var validCount = rows.filter(function (r) { return r.status === 'valid'; }).length;
      var errorCount = rows.length - validCount;
      var dateCount = rows.filter(function (r) { return r.date; }).length;

      // Stats header
      var statsHtml = '<span class="qs-valid">‚úì ' + validCount + ' h·ª£p l·ªá</span>';
      if (errorCount > 0) statsHtml += '<span class="qs-error">‚úó ' + errorCount + ' l·ªói</span>';
      if (dateCount > 0) statsHtml += '<span class="qs-date">üìÖ ' + dateCount + ' c√≥ h·∫°n</span>';
      if (statsEl) statsEl.innerHTML = statsHtml;
      if (countEl) countEl.textContent = validCount;

      // Cards
      var html = rows.map(function (row, i) {
        var suggested = row.suggested_skus || [];
        var top = suggested[0];
        var selected = row.selected_sku || (top && top.sku_code) || '';
        var isValid = row.status === 'valid';

        // SKU dropdown
        var opts = suggested.map(function (s) {
          return '<option value="' + escAttr(s.sku_code) + '"' + (s.sku_code === selected ? ' selected' : '') + '>' + getSkuName(s.sku_code) + '</option>';
        }).join('');
        if (selected && suggested.every(function (s) { return s.sku_code !== selected; })) {
          opts = '<option value="' + escAttr(selected) + '" selected>' + getSkuName(selected) + '</option>' + opts;
        }

        // Meta badges
        var meta = '';
        if (row.password) meta += '<span class="qi-badge qi-badge-pw">üîë MK</span>';
        if (row.twofa) meta += '<span class="qi-badge qi-badge-2fa">üîê 2FA</span>';
        if (row.date) meta += '<span class="qi-badge qi-badge-date">üìÖ ' + escHtml(row.date) + '</span>';
        if (!isValid) meta += '<span class="qi-badge qi-badge-err">' + escHtml(row.error || 'L·ªói') + '</span>';

        var cb = isValid ? '<input type="checkbox" class="qi-card-cb super-row-cb" data-index="' + i + '" checked>' : '';
        var skuHtml = isValid ? '<div class="qi-card-sku"><select class="super-sku-select" data-index="' + i + '">' + opts + '</select></div>' : '';

        return '<div class="qi-card' + (isValid ? '' : ' qi-error') + '" data-index="' + i + '">' +
          cb +
          '<span class="qi-card-num">' + (row.rowIndex || i + 1) + '</span>' +
          '<div class="qi-card-info">' +
            '<span class="qi-card-account" title="' + escAttr(row.account) + '">' + escHtml(row.account) + '</span>' +
            '<span class="qi-card-meta">' + meta + '</span>' +
          '</div>' +
          skuHtml +
        '</div>';
      }).join('');

      container.innerHTML = html;

      // Bind SKU change
      container.querySelectorAll('.super-sku-select').forEach(function (sel) {
        sel.addEventListener('change', function () {
          var idx = parseInt(sel.dataset.index, 10);
          if (_superParsedRows[idx]) _superParsedRows[idx].selected_sku = sel.value;
        });
      });
    }

    // Backward compat
    var renderSuperPreviewTable = renderPreviewCards;

    function applySkuToAllValid() {
      var sel = document.getElementById('superApplySkuSelect');
      var sku = sel && sel.value ? sel.value.trim() : '';
      if (!sku) return;
      _superParsedRows.forEach(function (row) {
        if (row.status === 'valid') row.selected_sku = sku;
      });
      renderPreviewCards();
    }

    async function doSuperImport() {
      var validRows = _superParsedRows.filter(function (r) { return r.status === 'valid'; });
      var items = validRows.map(function (row) {
        var sku = row.selected_sku || (row.suggested_skus && row.suggested_skus[0] && row.suggested_skus[0].sku_code) || '';
        var noteParts = [];
        if (row.twofa) noteParts.push('2FA: ' + row.twofa);
        if (row.date) noteParts.push('HSD: ' + row.date);
        if (row.notes) noteParts.push(row.notes);
        var note = noteParts.join(' | ');
        return { sku_code: sku, account_info: row.account, secret_key: row.password || '', note: note };
      }).filter(function (item) { return item.sku_code; });
      if (items.length === 0) {
        var resEl = document.getElementById('superImportResult');
        if (resEl) { resEl.style.display = 'block'; resEl.innerHTML = 'Ch·ªçn SKU cho √≠t nh·∫•t m·ªôt d√≤ng h·ª£p l·ªá.'; }
        return;
      }
      var resEl = document.getElementById('superImportResult');
      if (resEl) { resEl.style.display = 'block'; resEl.textContent = 'ƒêang nh·∫≠p ' + items.length + ' d√≤ng...'; }
      try {
        var r = await fetch(BASE + '/import-stock', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + ADMIN_TOKEN, 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items })
        });
        var data = await r.json().catch(function () { return {}; });
        if (r.status === 401) { if (resEl) resEl.innerHTML = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i.'; return; }
        if (!r.ok) { if (resEl) resEl.innerHTML = 'L·ªói: ' + (data.error || data.message || r.status); return; }
        if (items[0] && items[0].sku_code) localStorage.setItem(LAST_USED_SKU_KEY, items[0].sku_code);
        if (resEl) resEl.innerHTML = 'ƒê√£ th√™m <strong>' + (data.inserted || 0) + '</strong>, tr√πng <strong>' + (data.skipped_duplicate || 0) + '</strong>' + (data.errors && data.errors.length ? ', l·ªói: ' + data.errors.length : '') + '.';
        showToast('ƒê√£ nh·∫≠p ' + (data.inserted || 0) + ' t√†i kho·∫£n');
        loadInventory();
      } catch (e) {
        if (resEl) resEl.innerHTML = 'L·ªói m·∫°ng: ' + e.message;
      }
    }

    // ‚îÄ‚îÄ AUDIT LOGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLogs() {
      try {
        var r = await fetch(BASE + '/webhook-logs?limit=50', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var rows = data.logs || [];
        document.getElementById('logsBody').innerHTML = rows.length
          ? rows.map(function (l) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(l.event_type || l.event || '--') + '</td>' +
              '<td>' + escHtml(l.entity_type || '--') + '</td>' +
              '<td>' + escHtml(l.entity_id || l.order_id || '--') + '</td>' +
              '<td style="color:var(--text2)">' + escHtml(l.source || l.actor || '--') + '</td>' +
              '<td style="color:var(--text2);font-size:12px;max-width:260px;overflow:hidden;text-overflow:ellipsis">' + escHtml(l.payload || l.message || '--') + '</td>' +
              '<td style="color:var(--text2)">' + fmtTime(l.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="6" class="empty">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] logs', e); }
    }

    // ‚îÄ‚îÄ DISCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDiscounts() {
      try {
        var r = await fetch(BASE + '/admin-discounts?action=list', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var codes = data.codes || [];
        document.getElementById('discountsBody').innerHTML = codes.length
          ? codes.map(function (c) {
            var statusBadge = c.is_active
              ? '<span class="pill active">Ho·∫°t ƒë·ªông</span>'
              : '<span class="pill inactive">T·∫Øt</span>';
            var toggleLabel = c.is_active ? 'T·∫Øt' : 'B·∫≠t';
            var toggleColor = c.is_active ? '#f59e0b' : '#10b981';
            return '<tr>' +
              '<td><span class="code-chip">' + escHtml(c.code) + '</span></td>' +
              '<td style="font-weight:600">' + escHtml(c.owner_name || '--') + '</td>' +
              '<td class="muted">' + escHtml(c.owner_contact || '--') + '</td>' +
              '<td style="color:#ef4444;font-weight:600">-' + fmtVND(c.discount_amount) + '</td>' +
              '<td class="muted">' + escHtml(c.description || '--') + '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td style="font-weight:600">' + (c.usage_count || 0) + ' l·∫ßn</td>' +
              '<td class="muted">' + (c.last_used_at ? fmtTime(c.last_used_at) : '--') + '</td>' +
              '<td style="color:#ef4444">' + fmtVND(c.total_discount_given || 0) + '</td>' +
              '<td>' +
              "<button onclick=\"openCtvUsageModal('" + escAttr(c.code) + "')\" class=\"btn-ghost primary\" style=\"margin-right:4px\">L·ªãch s·ª≠</button>" +
              "<button onclick=\"toggleDiscount('" + c.id + "')\" class=\"btn-ghost warn\" style=\"margin-right:4px\">" + toggleLabel + "</button>" +
              "<button onclick=\"deleteDiscount('" + c.id + "','" + escHtml(c.code) + "')\" class=\"btn-ghost danger\">Xo√°</button>" +
              '</td></tr>';
          }).join('')
          : '<tr><td colspan="10" class="empty">Ch∆∞a c√≥ m√£ gi·∫£m gi√° n√†o</td></tr>';
        updateClock();
        // Update promo tab count badge
        var ctvEl = document.getElementById('ctvCount');
        if (ctvEl) ctvEl.textContent = codes.length;
      } catch (e) { console.error('[admin] discounts', e); }
    }

    async function createDiscount() {
      var code = document.getElementById('newDiscountCode').value.trim();
      var amount = parseInt(document.getElementById('newDiscountAmount').value) || 10000;
      var desc = document.getElementById('newDiscountDesc').value.trim();
      var ownerName = document.getElementById('newDiscountOwner').value.trim();
      var ownerContact = document.getElementById('newDiscountContact').value.trim();
      if (!code) return showAdminToast('Nh·∫≠p m√£ code!', 'error');

      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'create', code: code, discountAmount: amount, description: desc, ownerName: ownerName, ownerContact: ownerContact })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast('ƒê√£ t·∫°o m√£: ' + code.toUpperCase(), 'success');
          document.getElementById('newDiscountCode').value = '';
          document.getElementById('newDiscountDesc').value = '';
          document.getElementById('newDiscountOwner').value = '';
          document.getElementById('newDiscountContact').value = '';
          loadDiscounts();
        } else {
          showAdminToast(data.error || 'L·ªói t·∫°o m√£', 'error');
        }
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function openCtvUsageModal(code) {
      var modal = document.getElementById('ctvUsageModal');
      var body = document.getElementById('ctvUsageBody');
      var title = document.getElementById('ctvUsageTitle');
      if (!modal || !body) return;
      title.textContent = 'L·ªãch s·ª≠ d√πng m√£: ' + code;
      body.innerHTML = '<tr><td colspan="7" class="loading">ƒêang t·∫£i...</td></tr>';
      modal.style.display = 'flex';
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'usage', code: code, limit: 200 })
        });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var rows = data.orders || [];
        body.innerHTML = rows.length
          ? rows.map(function (o) {
            return '<tr>' +
              '<td style="font-weight:600;color:var(--accent)">' + escHtml(o.order_code) + '</td>' +
              '<td>' + escHtml(o.customer_name || '--') + '</td>' +
              '<td style="color:var(--text2)">' + escHtml((o.customer_phone || '') + (o.customer_email ? ' / ' + o.customer_email : '')) + '</td>' +
              '<td style="color:#ef4444">-' + fmtVND(o.discount_amount || 0) + '</td>' +
              '<td>' + fmtVND(o.amount_total || 0) + '</td>' +
              '<td>' + escHtml(o.status || '--') + '</td>' +
              '<td style="color:var(--text2)">' + fmtTime(o.created_at) + '</td></tr>';
          }).join('')
          : '<tr><td colspan="7" class="empty">Ch∆∞a c√≥ ƒë∆°n s·ª≠ d·ª•ng m√£ n√†y</td></tr>';
      } catch (e) {
        body.innerHTML = '<tr><td colspan="7" class="empty">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu</td></tr>';
      }
    }

    function closeCtvUsageModal() {
      var modal = document.getElementById('ctvUsageModal');
      if (modal) modal.style.display = 'none';
    }

    async function toggleDiscount(id) {
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'toggle', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ c·∫≠p nh·∫≠t', 'success'); loadDiscounts(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    async function deleteDiscount(id, code) {
      if (!confirm('Xo√° m√£ "' + code + '"?')) return;
      try {
        var r = await fetch(BASE + '/admin-discounts', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ xo√° m√£: ' + code, 'success'); loadDiscounts(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    // ‚îÄ‚îÄ COUPON FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function getCouponWebLink(code) {
      var base = location.origin || 'https://tbqhomie.com';
      if (base.includes('localhost')) base = 'http://localhost:8888';
      return base + '/#checkout?coupon=' + encodeURIComponent(code);
    }

    async function loadSkuCheckboxes() {
      try {
        var r = await fetch(BASE + '/admin-coupons?action=skus', { headers: authHeaders() });
        if (r.status === 401) return;
        var data = await r.json();
        var skus = data.skus || [];
        _allSkus = skus;

        if (skus.length === 0) {
          document.getElementById('skuCheckboxes').innerHTML = '<div class="muted" style="font-size:12px">Kh√¥ng c√≥ SKU n√†o</div>';
          return;
        }

        // Group by category
        var groups = {};
        skus.forEach(function (s) {
          var cat = s.category || 'Kh√°c';
          if (!groups[cat]) groups[cat] = [];
          groups[cat].push(s);
        });

        var html = '';
        Object.keys(groups).sort().forEach(function (cat) {
          html += '<div class="sku-cat-label">' + escHtml(cat) + '</div>';
          groups[cat].forEach(function (s) {
            html += '<label class="sku-checkbox">' +
              '<input type="checkbox" value="' + escAttr(s.sku_code) + '">' +
              '<span class="sku-name">' + escHtml(s.name) + '</span>' +
              '<span class="sku-code">' + escHtml(s.sku_code) + '</span>' +
              '</label>';
          });
        });

        document.getElementById('skuCheckboxes').innerHTML = html;
      } catch (e) { console.error('[admin] load skus', e); }
    }

    function toggleAllSkus() {
      var cbs = document.querySelectorAll('#skuCheckboxes input[type="checkbox"]');
      var allChecked = Array.from(cbs).every(function (cb) { return cb.checked; });
      cbs.forEach(function (cb) { cb.checked = !allChecked; });
    }

    async function loadCoupons() {
      if (_allSkus.length === 0) await loadSkuCheckboxes();
      try {
        var r = await fetch(BASE + '/admin-coupons?action=list', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var coupons = data.coupons || [];
        var now = new Date();

        document.getElementById('couponsBody').innerHTML = coupons.length
          ? coupons.map(function (c) {
            var expired = new Date(c.expires_at) < now;
            var used = c.used_count >= c.max_uses;
            var statusBadge = '';
            if (!c.is_active) {
              statusBadge = '<span class="pill inactive">T·∫Øt</span>';
            } else if (used) {
              statusBadge = '<span class="pill used">ƒê√£ d√πng</span>';
            } else if (expired) {
              statusBadge = '<span class="pill expired">H·∫øt h·∫°n</span>';
            } else {
              statusBadge = '<span class="pill active">C√≤n hi·ªáu l·ª±c</span>';
            }

            var pctLabel = c.discount_percent === 100
              ? '<strong style="color:#10b981">MI·ªÑN PH√ç</strong>'
              : '<strong style="color:#ef4444">-' + c.discount_percent + '%</strong>';

            var link = getCouponWebLink(c.code);

            var skuLabel = '';
            if (c.sku_codes) {
              var codes = c.sku_codes.split(',');
              skuLabel = codes.length <= 3 ? codes.join(', ') : codes.slice(0, 3).join(', ') + ' +' + (codes.length - 3);
            } else {
              skuLabel = '<em>T·∫•t c·∫£</em>';
            }

            return '<tr>' +
              '<td><span class="code-chip">' + escHtml(c.code) + '</span></td>' +
              '<td>' + pctLabel + '</td>' +
              '<td class="muted" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + escAttr(c.sku_codes || 'T·∫•t c·∫£') + '">' + skuLabel + '</td>' +
              '<td class="muted">' + fmtTime(c.expires_at) + '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td class="muted">' + escHtml(c.description || '--') + '</td>' +
              '<td class="muted">' + fmtTime(c.created_at) + '</td>' +
              '<td>' +
              '<button onclick="copyCouponLink(\'' + escAttr(c.code) + '\')" class="coupon-link-btn" style="margin-right:4px" title="' + escAttr(link) + '">üìã Link</button>' +
              '<button onclick="toggleCoupon(\'' + c.id + '\')" class="btn-ghost warn" style="margin-right:4px">' + (c.is_active ? 'T·∫Øt' : 'B·∫≠t') + '</button>' +
              '<button onclick="deleteCoupon(\'' + c.id + '\',\'' + escAttr(c.code) + '\')" class="btn-ghost danger">Xo√°</button>' +
              '</td></tr>';
          }).join('')
          : '<tr><td colspan="8" class="empty">Ch∆∞a c√≥ coupon n√†o</td></tr>';
        updateClock();
        // Update promo tab count badge
        var countEl = document.getElementById('couponCount');
        if (countEl) countEl.textContent = coupons.length;
      } catch (e) { console.error('[admin] coupons', e); }
    }

    async function generateCoupons() {
      var pct = parseInt(document.getElementById('couponPercent').value);
      var qty = parseInt(document.getElementById('couponQty').value) || 1;
      var expiry = document.getElementById('couponExpiry').value;
      var desc = document.getElementById('couponDesc').value.trim();

      if (!expiry) return showAdminToast('Ch·ªçn h·∫°n s·ª≠ d·ª•ng!', 'error');
      if (qty < 1 || qty > 50) return showAdminToast('S·ªë l∆∞·ª£ng 1-50!', 'error');

      // Get selected SKUs
      var selectedSkus = [];
      document.querySelectorAll('#skuCheckboxes input[type="checkbox"]:checked').forEach(function (cb) {
        selectedSkus.push(cb.value);
      });

      try {
        var r = await fetch(BASE + '/admin-coupons', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'generate',
            discountPercent: pct,
            quantity: qty,
            expiresAt: new Date(expiry).toISOString(),
            description: desc,
            skuCodes: selectedSkus.length > 0 ? selectedSkus : null
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');

          var resultEl = document.getElementById('couponResult');
          resultEl.className = 'coupon-result show';
          resultEl.innerHTML = '<strong>‚úÖ ' + escHtml(data.message) + '</strong>' +
            data.coupons.map(function (c) {
              return '<div class="coupon-code-row">' +
                '<span class="code-chip">' + escHtml(c.code) + '</span>' +
                '<span class="muted">Gi·∫£m ' + c.discountPercent + '%</span>' +
                (c.skuCodes ? '<span class="muted" style="font-size:11px">SKU: ' + escHtml(c.skuCodes) + '</span>' : '') +
                '<button class="coupon-link-btn" onclick="copyCouponLink(\'' + escAttr(c.code) + '\')">üìã Copy link</button>' +
                '</div>';
            }).join('');

          loadCoupons();
        } else {
          showAdminToast(data.error || 'L·ªói t·∫°o coupon', 'error');
        }
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    function copyCouponLink(code) {
      var link = getCouponWebLink(code);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link).then(function () {
          showAdminToast('ƒê√£ copy link: ' + code, 'success');
        });
      } else {
        var ta = document.createElement('textarea');
        ta.value = link;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showAdminToast('ƒê√£ copy link: ' + code, 'success');
      }
    }

    async function toggleCoupon(id) {
      try {
        var r = await fetch(BASE + '/admin-coupons', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'toggle', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ c·∫≠p nh·∫≠t', 'success'); loadCoupons(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    async function deleteCoupon(id, code) {
      if (!confirm('Xo√° coupon "' + code + '"?')) return;
      try {
        var r = await fetch(BASE + '/admin-coupons', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('ƒê√£ xo√° coupon: ' + code, 'success'); loadCoupons(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói', 'error'); }
    }

    // ‚îÄ‚îÄ ORDER CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function openCreateOrderModal() {
      var modal = document.getElementById('createOrderModal');
      modal.style.display = 'flex';
      // Populate SKU dropdown
      var sel = document.getElementById('manualOrderSku');
      sel.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>';
      try {
        var r = await fetch(BASE + '/admin-orders?action=list_skus', { headers: authHeaders() });
        var data = await r.json();
        (data.skus || []).forEach(function (s) {
          sel.innerHTML += '<option value="' + escAttr(s.sku_code) + '" data-price="' + s.price + '">' + escHtml(s.name) + ' (' + escHtml(s.sku_code) + ') - ' + fmtVND(s.price) + '</option>';
        });
      } catch (e) { console.error(e); }
    }

    function updateManualOrderPrice() {
      var sel = document.getElementById('manualOrderSku');
      var opt = sel.options[sel.selectedIndex];
      if (opt && opt.dataset.price) {
        var qty = parseInt(document.getElementById('manualOrderQty').value) || 1;
        document.getElementById('manualOrderPrice').value = parseInt(opt.dataset.price) * qty;
      }
    }

    async function submitManualOrder() {
      var name = document.getElementById('manualOrderName').value.trim();
      var email = document.getElementById('manualOrderEmail').value.trim();
      if (!name || !email) return showAdminToast('Nh·∫≠p t√™n v√† email!', 'error');
      try {
        var r = await fetch(BASE + '/admin-orders', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'create_manual',
            customerName: name,
            customerEmail: email,
            customerPhone: document.getElementById('manualOrderPhone').value.trim(),
            customerNote: document.getElementById('manualOrderNote').value.trim(),
            skuCode: document.getElementById('manualOrderSku').value,
            quantity: parseInt(document.getElementById('manualOrderQty').value) || 1,
            price: parseInt(document.getElementById('manualOrderPrice').value) || 0
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('createOrderModal').style.display = 'none';
          loadOrders();
        } else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function openEditOrderModal(orderCode) {
      try {
        var r = await fetch(BASE + '/admin-orders?action=order_detail&order_code=' + encodeURIComponent(orderCode), { headers: authHeaders() });
        var data = await r.json();
        if (!data.order) return showAdminToast('Kh√¥ng t√¨m th·∫•y ƒë∆°n', 'error');
        var o = data.order;
        document.getElementById('editOrderCode').textContent = orderCode;
        document.getElementById('editOrderCode').dataset.code = orderCode;
        document.getElementById('editOrderName').value = o.customer_name || '';
        document.getElementById('editOrderEmail').value = o.customer_email || '';
        document.getElementById('editOrderPhone').value = o.customer_phone || '';
        document.getElementById('editOrderStatus').value = o.status || '';
        document.getElementById('editOrderAmount').value = o.amount_total || '';
        document.getElementById('editOrderNote').value = o.customer_note || '';
        document.getElementById('editOrderModal').style.display = 'flex';
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function submitEditOrder() {
      var code = document.getElementById('editOrderCode').dataset.code;
      if (!code) return;
      try {
        var r = await fetch(BASE + '/admin-orders', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'update_full',
            orderCode: code,
            customerName: document.getElementById('editOrderName').value.trim(),
            customerEmail: document.getElementById('editOrderEmail').value.trim(),
            customerPhone: document.getElementById('editOrderPhone').value.trim(),
            customerNote: document.getElementById('editOrderNote').value.trim(),
            status: document.getElementById('editOrderStatus').value,
            amountTotal: parseInt(document.getElementById('editOrderAmount').value) || 0
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('editOrderModal').style.display = 'none';
          loadOrders();
        } else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function deleteOrder(orderCode) {
      if (!confirm('Xo√° ƒë∆°n "' + orderCode + '"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
      try {
        var r = await fetch(BASE + '/admin-orders', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete', orderCode: orderCode })
        });
        var data = await r.json();
        if (data.success) { showAdminToast(data.message, 'success'); loadOrders(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function quickFulfill(orderCode) {
      if (!confirm('Chuy·ªÉn ƒë∆°n "' + orderCode + '" sang ƒê√£ giao?')) return;
      try {
        var r = await fetch(BASE + '/admin-orders', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'update_full', orderCode: orderCode, status: 'fulfilled' })
        });
        var data = await r.json();
        if (data.success) { showAdminToast('‚úÖ ƒê√£ giao: ' + orderCode, 'success'); loadOrders(); }
        else showAdminToast(data.error || 'L·ªói c·∫≠p nh·∫≠t', 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    function copyDeliveryLink(url) {
      navigator.clipboard.writeText(url).then(function () {
        showAdminToast('üîó ƒê√£ copy link giao h√†ng', 'success');
      }).catch(function () { showAdminToast('Kh√¥ng th·ªÉ copy', 'error'); });
    }

    function copyOrderInfo(orderCode, name, phone, products) {
      var text = 'ƒê∆°n: ' + orderCode + '\nT√™n: ' + name + '\nSƒêT: ' + phone + '\nSP: ' + products;
      navigator.clipboard.writeText(text).then(function () {
        showAdminToast('üìã ƒê√£ copy th√¥ng tin ƒë∆°n', 'success');
      }).catch(function () { showAdminToast('Kh√¥ng th·ªÉ copy', 'error'); });
    }

    // ‚îÄ‚îÄ STOCK ITEM EDIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openEditStockItemModal(id, account, secret, note) {
      document.getElementById('editStockItemId').value = id;
      document.getElementById('editStockAccount').value = account || '';
      document.getElementById('editStockSecret').value = secret || '';
      document.getElementById('editStockNote').value = note || '';
      document.getElementById('editStockItemModal').style.display = 'flex';
    }

    async function submitEditStockItem() {
      var id = document.getElementById('editStockItemId').value;
      if (!id) return;
      try {
        var r = await fetch(BASE + '/admin-inventory', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'update_item',
            id: id,
            account_info: document.getElementById('editStockAccount').value.trim(),
            secret_key: document.getElementById('editStockSecret').value.trim(),
            note: document.getElementById('editStockNote').value.trim()
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('editStockItemModal').style.display = 'none';
          loadSkuDetails();
        } else showAdminToast(data.error || 'L·ªói', 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ PRODUCTS (SKU) CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadProducts() {
      try {
        var r = await fetch(BASE + '/admin-inventory?action=list_skus', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var skus = data.skus || [];
        document.getElementById('productsBody').innerHTML = skus.length
          ? skus.map(function (s) {
            var statusBadge = s.is_active
              ? '<span class="pill active">Ho·∫°t ƒë·ªông</span>'
              : '<span class="pill inactive">T·∫Øt</span>';
            return '<tr>' +
              '<td class="col-sku"><span class="code-chip" style="font-size:11px">' + escHtml(s.sku_code) + '</span></td>' +
              '<td style="font-weight:600;white-space:nowrap">' + escHtml(s.name) + '</td>' +
              '<td class="muted">' + escHtml(s.category || '--') + '</td>' +
              '<td style="text-align:right;white-space:nowrap">' + fmtVND(s.price) + '</td>' +
              '<td class="muted" style="font-size:11px">' + escHtml(s.delivery_type || 'auto') + '</td>' +
              '<td style="text-align:center;color:#10b981;font-weight:600">' + (s.available || 0) + '</td>' +
              '<td style="text-align:center" class="muted">' + (s.sold || 0) + '</td>' +
              '<td>' + statusBadge + '</td>' +
              '<td class="col-actions">' +
              '<button onclick="openEditSkuModal(' + s.id + ',\'' + escAttr(s.sku_code) + '\',\'' + escAttr(s.name) + '\',\'' + escAttr(s.category || '') + '\',' + (s.price || 0) + ',\'' + escAttr(s.delivery_type || 'auto') + '\',' + (s.duration_days || 30) + ',' + (s.is_active ? 1 : 0) + ')" class="btn-ghost primary" style="margin-right:2px;font-size:11px;padding:2px 6px">S·ª≠a</button>' +
              '<button onclick="deleteSku(' + s.id + ',\'' + escAttr(s.sku_code) + '\')" class="btn-ghost danger" style="font-size:11px;padding:2px 6px">Xo√°</button>' +
              '</td></tr>';
          }).join('')
          : '<tr><td colspan="9" class="empty">Ch∆∞a c√≥ SKU n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] products', e); }
    }

    async function createSku() {
      var code = document.getElementById('newSkuCode').value.trim();
      var name = document.getElementById('newSkuName').value.trim();
      if (!code || !name) return showAdminToast('Nh·∫≠p m√£ SKU v√† t√™n!', 'error');
      try {
        var r = await fetch(BASE + '/admin-inventory', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'create_sku',
            sku_code: code,
            name: name,
            category: document.getElementById('newSkuCategory').value.trim(),
            price: parseInt(document.getElementById('newSkuPrice').value) || 0,
            delivery_type: document.getElementById('newSkuDelivery').value,
            duration_days: parseInt(document.getElementById('newSkuDuration').value) || 30
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('newSkuCode').value = '';
          document.getElementById('newSkuName').value = '';
          loadProducts();
        } else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    function openEditSkuModal(id, code, name, category, price, delivery, duration, active) {
      document.getElementById('editSkuId').value = id;
      document.getElementById('editSkuCode').textContent = code;
      document.getElementById('editSkuName').value = name;
      document.getElementById('editSkuCategory').value = category;
      document.getElementById('editSkuPrice').value = price;
      document.getElementById('editSkuDelivery').value = delivery;
      document.getElementById('editSkuDuration').value = duration;
      document.getElementById('editSkuActive').checked = !!active;
      document.getElementById('editSkuModal').style.display = 'flex';
    }

    async function submitEditSku() {
      var id = document.getElementById('editSkuId').value;
      if (!id) return;
      try {
        var r = await fetch(BASE + '/admin-inventory', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            action: 'update_sku',
            id: parseInt(id),
            name: document.getElementById('editSkuName').value.trim(),
            category: document.getElementById('editSkuCategory').value.trim(),
            price: parseInt(document.getElementById('editSkuPrice').value) || 0,
            delivery_type: document.getElementById('editSkuDelivery').value,
            duration_days: parseInt(document.getElementById('editSkuDuration').value) || 30,
            is_active: document.getElementById('editSkuActive').checked
          })
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('editSkuModal').style.display = 'none';
          loadProducts();
        } else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function deleteSku(id, code) {
      if (!confirm('Xo√° SKU "' + code + '"?')) return;
      try {
        var r = await fetch(BASE + '/admin-inventory', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete_sku', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast(data.message, 'success'); loadProducts(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ CUSTOMERS CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCustomers() {
      try {
        var r = await fetch(BASE + '/customers', { headers: authHeaders() });
        if (r.status === 401) return handleUnauth();
        var data = await r.json();
        var customers = data.customers || [];
        document.getElementById('customersBody').innerHTML = customers.length
          ? customers.map(function (c) {
            var sourceLabel = c.source === 'orders' ? '<span class="pill" style="background:#e0f2fe;color:#0284c7">ƒê∆°n</span>'
              : c.source === 'manual' ? '<span class="pill" style="background:#fef3c7;color:#d97706">Th·ªß c√¥ng</span>'
                : '<span class="pill" style="background:#d1fae5;color:#059669">C·∫£ hai</span>';
            var actions = '';
            if (c.id && c.source !== 'orders') {
              actions += '<button onclick="openEditCustomerModal(' + c.id + ',\'' + escAttr(c.name || '') + '\',\'' + escAttr(c.email || '') + '\',\'' + escAttr(c.phone || '') + '\',\'' + escAttr(c.note || '') + '\')" class="btn-ghost primary" style="margin-right:4px;font-size:11px">S·ª≠a</button>';
              actions += '<button onclick="deleteCustomer(' + c.id + ',\'' + escAttr(c.name || '') + '\')" class="btn-ghost danger" style="font-size:11px">Xo√°</button>';
            } else {
              actions = '<span class="muted" style="font-size:11px">--</span>';
            }
            return '<tr>' +
              '<td style="font-weight:600">' + escHtml(c.name || '--') + '</td>' +
              '<td class="muted">' + escHtml(c.email || '--') + '</td>' +
              '<td class="muted">' + escHtml(c.phone || '--') + '</td>' +
              '<td style="font-weight:600">' + (c.total_orders || 0) + '</td>' +
              '<td>' + fmtVND(c.total_spent || 0) + '</td>' +
              '<td class="muted">' + (c.last_order_date ? fmtTime(c.last_order_date) : '--') + '</td>' +
              '<td>' + sourceLabel + '</td>' +
              '<td>' + actions + '</td></tr>';
          }).join('')
          : '<tr><td colspan="8" class="empty">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
        updateClock();
      } catch (e) { console.error('[admin] customers', e); }
    }

    function openCreateCustomerModal() {
      document.getElementById('customerModalTitle').textContent = 'T·∫°o kh√°ch h√†ng';
      document.getElementById('customerModalId').value = '';
      document.getElementById('customerModalName').value = '';
      document.getElementById('customerModalEmail').value = '';
      document.getElementById('customerModalPhone').value = '';
      document.getElementById('customerModalNote').value = '';
      document.getElementById('customerModalSubmitBtn').textContent = 'T·∫°o';
      document.getElementById('customerModal').style.display = 'flex';
    }

    function openEditCustomerModal(id, name, email, phone, note) {
      document.getElementById('customerModalTitle').textContent = 'S·ª≠a kh√°ch h√†ng';
      document.getElementById('customerModalId').value = id;
      document.getElementById('customerModalName').value = name;
      document.getElementById('customerModalEmail').value = email;
      document.getElementById('customerModalPhone').value = phone;
      document.getElementById('customerModalNote').value = note;
      document.getElementById('customerModalSubmitBtn').textContent = 'L∆∞u';
      document.getElementById('customerModal').style.display = 'flex';
    }

    async function submitCustomerModal() {
      var id = document.getElementById('customerModalId').value;
      var name = document.getElementById('customerModalName').value.trim();
      if (!name) return showAdminToast('Nh·∫≠p t√™n!', 'error');
      var action = id ? 'update' : 'create';
      var body = {
        action: action,
        name: name,
        email: document.getElementById('customerModalEmail').value.trim(),
        phone: document.getElementById('customerModalPhone').value.trim(),
        note: document.getElementById('customerModalNote').value.trim()
      };
      if (id) body.id = parseInt(id);
      try {
        var r = await fetch(BASE + '/customers', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify(body)
        });
        var data = await r.json();
        if (data.success) {
          showAdminToast(data.message, 'success');
          document.getElementById('customerModal').style.display = 'none';
          loadCustomers();
        } else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    async function deleteCustomer(id, name) {
      if (!confirm('Xo√° kh√°ch h√†ng "' + name + '"?')) return;
      try {
        var r = await fetch(BASE + '/customers', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'delete', id: id })
        });
        var data = await r.json();
        if (data.success) { showAdminToast(data.message, 'success'); loadCustomers(); }
        else showAdminToast(data.error, 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    // ‚îÄ‚îÄ LOGS CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function clearAllLogs() {
      if (!confirm('Xo√° t·∫•t c·∫£ nh·∫≠t k√Ω? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
      try {
        var r = await fetch(BASE + '/webhook-logs', {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ action: 'clear_all' })
        });
        var data = await r.json();
        if (data.success) { showAdminToast(data.message, 'success'); loadLogs(); }
        else showAdminToast(data.error || 'L·ªói', 'error');
      } catch (e) { showAdminToast('L·ªói: ' + e.message, 'error'); }
    }

    function showAdminToast(msg, type) {
      var t = document.getElementById('globalToast');
      if (!t) return;
      t.textContent = msg;
      t.className = 'toast show ' + (type || '');
      setTimeout(function () { t.className = 'toast'; }, 3000);
    }

    // ‚îÄ‚îÄ UNAUTH handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleUnauth() {
      sessionStorage.removeItem('tbq_admin_token');
      ADMIN_TOKEN = '';
      document.getElementById('loginOverlay').style.display = 'flex';
      document.getElementById('shell').style.display = 'none';
      document.getElementById('loginErr').textContent = 'Token h·∫øt h·∫°n - ƒëƒÉng nh·∫≠p l·∫°i';
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }

    // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.onload = async function () {
      if (ADMIN_TOKEN) {
        try {
          var r = await fetch(BASE + '/admin-orders', { headers: { Authorization: 'Bearer ' + ADMIN_TOKEN } });
          if (r.ok) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('shell').style.display = 'flex';
            startAutoRefresh();
            loadDashboard();
            return;
          }
        } catch (e) {
          console.error('Session restore failed:', e);
        }
        // Token c≈© kh√¥ng h·ª£p l·ªá ‚Üí xo√° v√† hi·ªán login
        sessionStorage.removeItem('tbq_admin_token');
        ADMIN_TOKEN = '';
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('loginErr').textContent = 'Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
      }
    };
  </script>
</body>

</html>