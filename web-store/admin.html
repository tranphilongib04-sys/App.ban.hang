<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBQ Admin â€“ Dashboard</title>
<style>
/* â”€â”€â”€â”€â”€ reset + tokens â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#232736;--border:#2e3244;
  --text:#e2e4ea;--text2:#8b8fa3;--accent:#5b8def;--accent-dim:#5b8def33;
  --green:#34c759;--green-dim:#34c75933;--yellow:#ffd60a;--yellow-dim:#ffd60a33;
  --red:#ff453a;--red-dim:#ff453a33;--purple:#bf5af2;--radius:10px;
  --font:'Inter',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px}

/* â”€â”€â”€â”€â”€ layout â”€â”€â”€â”€â”€ */
.shell{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:24px 0;display:flex;flex-direction:column;flex-shrink:0}
.sidebar-logo{padding:0 20px;margin-bottom:32px;font-size:18px;font-weight:700;color:var(--accent);letter-spacing:-0.5px}
.sidebar-logo span{color:var(--text2);font-weight:400}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;color:var(--text2);border-left:3px solid transparent;transition:.15s}
.nav-item:hover{background:var(--accent-dim);color:var(--text)}
.nav-item.active{border-left-color:var(--accent);background:var(--accent-dim);color:var(--accent);font-weight:600}
.nav-icon{width:18px;text-align:center;font-size:16px}
.sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text2)}

.main{flex:1;overflow-y:auto;padding:32px}
.page{display:none}
.page.active{display:block}

/* â”€â”€â”€â”€â”€ header row â”€â”€â”€â”€â”€ */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-header h1{font-size:22px;font-weight:700;letter-spacing:-.5px}
.refresh-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:var(--radius);cursor:pointer;font-size:13px;transition:.15s}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent)}

/* â”€â”€â”€â”€â”€ stat cards â”€â”€â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:28px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.stat-card .label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
.stat-card .value{font-size:28px;font-weight:700}
.stat-card.green .value{color:var(--green)}
.stat-card.yellow .value{color:var(--yellow)}
.stat-card.red .value{color:var(--red)}
.stat-card.purple .value{color:var(--purple)}
.stat-card.blue .value{color:var(--accent)}

/* â”€â”€â”€â”€â”€ table â”€â”€â”€â”€â”€ */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:12px 16px;font-size:11px;text-transform:uppercase;letter-spacing:.7px;color:var(--text2);border-bottom:1px solid var(--border);font-weight:600;white-space:nowrap}
td{padding:11px 16px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:#1e2130}

/* â”€â”€â”€â”€â”€ badges â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap}
.badge-pending{background:var(--yellow-dim);color:var(--yellow)}
.badge-paid{background:var(--accent-dim);color:var(--accent)}
.badge-fulfilled{background:var(--green-dim);color:var(--green)}
.badge-failed,.badge-cancelled,.badge-expired{background:var(--red-dim);color:var(--red)}
.badge-refunded{background:var(--purple-dim);color:var(--purple)}

/* â”€â”€â”€â”€â”€ filter bar â”€â”€â”€â”€â”€ */
.filter-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:var(--radius);font-size:13px;font-family:inherit}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent)}
.filter-bar label{color:var(--text2);font-size:13px}

/* â”€â”€â”€â”€â”€ login overlay â”€â”€â”€â”€â”€ */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:380px;text-align:center}
.login-box h2{margin-bottom:8px;font-size:20px}
.login-box p{color:var(--text2);margin-bottom:24px;font-size:14px}
.login-box input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:15px;margin-bottom:16px;font-family:inherit}
.login-box input:focus{outline:none;border-color:var(--accent)}
.login-box button{width:100%;padding:11px;background:var(--accent);border:none;border-radius:var(--radius);color:#fff;font-size:15px;font-weight:600;cursor:pointer}
.login-box button:hover{opacity:.85}
.login-err{color:var(--red);font-size:13px;margin-top:12px;min-height:18px}

/* â”€â”€â”€â”€â”€ empty / loading â”€â”€â”€â”€â”€ */
.empty{color:var(--text2);text-align:center;padding:48px 0;font-size:15px}
.loading{color:var(--text2);padding:24px 0;text-align:center;font-size:14px}

/* â”€â”€â”€â”€â”€ responsive â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .shell{flex-direction:column}
  .sidebar{flex-direction:row;width:100%;padding:12px 16px;gap:8px;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border)}
  .sidebar-logo{margin-bottom:0;margin-right:12px;font-size:15px}
  .nav-item{padding:8px 10px;border-left:none;border-bottom:2px solid transparent;white-space:nowrap}
  .nav-item.active{border-left-color:transparent;border-bottom-color:var(--accent)}
  .sidebar-footer{display:none}
  .main{padding:16px}
}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>ğŸ” TBQ Admin</h2>
    <p>Nháº­p Admin Token Ä‘á»ƒ Ä‘Äƒng nháº­p</p>
    <input type="password" id="tokenInput" placeholder="Admin tokenâ€¦" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">ÄÄƒng nháº­p</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- â”€â”€ SHELL â”€â”€ -->
<div class="shell" id="shell" style="display:none">

  <!-- sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">TBQ<span>Admin</span></div>
    <div class="nav-item active" onclick="nav('dashboard')"><span class="nav-icon">ğŸ“Š</span> Dashboard</div>
    <div class="nav-item" onclick="nav('orders')"><span class="nav-icon">ğŸ“¦</span> Orders</div>
    <div class="nav-item" onclick="nav('inventory')"><span class="nav-icon">ğŸ·ï¸</span> Inventory</div>
    <div class="nav-item" onclick="nav('logs')"><span class="nav-icon">ğŸ“</span> Audit Logs</div>
    <div class="sidebar-footer">Last sync: <span id="lastSync">â€”</span></div>
  </aside>

  <!-- main -->
  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <h1>Dashboard</h1>
        <button class="refresh-btn" onclick="loadDashboard()">â†» Refresh</button>
      </div>
      <div class="stats-row" id="statsRow">
        <div class="stat-card blue"><div class="label">Tá»•ng Ä‘Æ¡n</div><div class="value" id="statTotal">â€”</div></div>
        <div class="stat-card yellow"><div class="label">Chá» thanh toÃ¡n</div><div class="value" id="statPending">â€”</div></div>
        <div class="stat-card green"><div class="label">ÄÃ£ giao</div><div class="value" id="statFulfilled">â€”</div></div>
        <div class="stat-card purple"><div class="label">Doanh thu</div><div class="value" id="statRevenue">â€”</div></div>
      </div>
      <!-- Recent orders table (top 10) -->
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>MÃ£ Ä‘Æ¡n</th><th>KhÃ¡ch</th><th>Sá»‘ tiá»n</th><th>Tráº¡ng thÃ¡i</th><th>Thá»i gian</th>
          </tr></thead>
          <tbody id="dashboardOrders"><tr><td colspan="5" class="loading">Äang táº£iâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ORDERS -->
    <div class="page" id="page-orders">
      <div class="page-header">
        <h1>Orders</h1>
        <button class="refresh-btn" onclick="loadOrders()">â†» Refresh</button>
      </div>
      <div class="filter-bar">
        <label>Status:</label>
        <select id="orderStatusFilter" onchange="loadOrders()">
          <option value="">Táº¥t cáº£</option>
          <option value="pending_payment">Chá» thanh toÃ¡n</option>
          <option value="paid">ÄÃ£ thanh toÃ¡n</option>
          <option value="fulfilled">ÄÃ£ giao</option>
          <option value="failed">Lá»—i</option>
          <option value="cancelled">Há»§y</option>
          <option value="refunded">HoÃ n tiá»n</option>
        </select>
        <label>TÃ¬m:</label>
        <input type="text" id="orderSearch" placeholder="TBQâ€¦ hoáº·c email" oninput="loadOrders()">
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>MÃ£ Ä‘Æ¡n</th><th>KhÃ¡ch</th><th>Email</th><th>Sá»‘ tiá»n</th><th>Tráº¡ng thÃ¡i</th><th>Tx ID</th><th>Táº¡o lÃºc</th>
          </tr></thead>
          <tbody id="ordersBody"><tr><td colspan="7" class="loading">Äang táº£iâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- INVENTORY -->
    <div class="page" id="page-inventory">
      <div class="page-header">
        <h1>Inventory</h1>
        <button class="refresh-btn" onclick="loadInventory()">â†» Refresh</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Product Code</th><th>CÃ³ sáºµn</th><th>ÄÃ£ bÃ¡n</th><th>ÄÃ£ giá»¯</th><th>Tá»•ng</th>
          </tr></thead>
          <tbody id="inventoryBody"><tr><td colspan="5" class="loading">Äang táº£iâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- AUDIT LOGS -->
    <div class="page" id="page-logs">
      <div class="page-header">
        <h1>Audit Logs</h1>
        <button class="refresh-btn" onclick="loadLogs()">â†» Refresh</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Event</th><th>Entity</th><th>ID</th><th>Source</th><th>Payload</th><th>Thá»i gian</th>
          </tr></thead>
          <tbody id="logsBody"><tr><td colspan="6" class="loading">Äang táº£iâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resolveBase() {
  // Allow override: admin.html?base=https://your-site.com/.netlify/functions
  const qs = new URLSearchParams(location.search);
  const fromQuery = (qs.get('base') || '').trim();
  if (fromQuery) return fromQuery.replace(/\/+$/, '');

  // When opening via file://, relative "/.netlify/functions" cannot work.
  // Default Netlify Dev runs at http://localhost:8888
  if (location.protocol === 'file:') return 'http://localhost:8888/.netlify/functions';

  return '/.netlify/functions';
}

const BASE = resolveBase();
let ADMIN_TOKEN = '';                          // set after login
const POLL_INTERVAL = 10_000;                  // auto-refresh every 10 s
let pollTimer = null;

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const t = document.getElementById('tokenInput').value.trim();
  if (!t) return;

  // Quick auth check: call admin-orders with the token
  try {
    const r = await fetch(`${BASE}/admin-orders`, {
      headers: { Authorization: `Bearer ${t}` }
    });
    if (r.status === 401) {
      document.getElementById('loginErr').textContent = 'âŒ Token khÃ´ng há»£p lá»‡';
      return;
    }
    // 200 or 500 (db issue) both mean token OK
    ADMIN_TOKEN = t;
    sessionStorage.setItem('tbq_admin_token', t);
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('shell').style.display = 'flex';
    startAutoRefresh();
    loadDashboard();
  } catch (e) {
    const hint = (location.protocol === 'file:')
      ? 'Báº¡n Ä‘ang má»Ÿ báº±ng file://. HÃ£y cháº¡y "netlify dev" vÃ  má»Ÿ admin táº¡i http://localhost:8888/admin.html (hoáº·c truyá»n ?base=...).'
      : 'Kiá»ƒm tra máº¡ng / endpoint Netlify Functions.';
    document.getElementById('loginErr').textContent = `âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c mÃ¡y chá»§. (${hint})`;
  }
}

// â”€â”€ AUTO-RESTORE session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function () {
  const saved = sessionStorage.getItem('tbq_admin_token');
  if (saved) { ADMIN_TOKEN = saved; /* will validate on first fetch */ }
})();

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(page) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');

  // load data for the page
  const loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs };
  if (loaders[page]) loaders[page]();
}

// â”€â”€ AUTO REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoRefresh() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(() => {
    // refresh whichever page is active
    const active = document.querySelector('.page.active');
    if (!active) return;
    const id = active.id.replace('page-', '');
    const loaders = { dashboard: loadDashboard, orders: loadOrders, inventory: loadInventory, logs: loadLogs };
    if (loaders[id]) loaders[id]();
  }, POLL_INTERVAL);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders() {
  return { Authorization: `Bearer ${ADMIN_TOKEN}`, 'Content-Type': 'application/json' };
}
function fmtTime(iso) {
  if (!iso) return 'â€”';
  try { return new Date(iso).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'medium' }); } catch { return iso; }
}
function fmtVND(n) { return (Number(n) || 0).toLocaleString('vi-VN') + ' â‚«'; }
function badgeClass(s) {
  const map = { pending_payment:'badge-pending', paid:'badge-paid', fulfilled:'badge-fulfilled',
                failed:'badge-failed', cancelled:'badge-cancelled', expired:'badge-expired', refunded:'badge-refunded' };
  return map[s] || 'badge-pending';
}
function badgeLabel(s) {
  const map = { pending_payment:'Chá» TT', paid:'ÄÃ£ TT', fulfilled:'ÄÃ£ giao', failed:'Lá»—i', cancelled:'Há»§y', expired:'Háº¿t háº¡n', refunded:'HoÃ n tiá»n' };
  return map[s] || s;
}
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function updateClock() { document.getElementById('lastSync').textContent = new Date().toLocaleTimeString('vi-VN'); }

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const r = await fetch(`${BASE}/admin-orders?limit=10`, { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    const data = await r.json();

    // Stats
    const s = data.stats || {};
    document.getElementById('statTotal').textContent     = s.total || 0;
    document.getElementById('statPending').textContent   = s.pending || 0;
    document.getElementById('statFulfilled').textContent = s.delivered || s.fulfilled || 0;
    document.getElementById('statRevenue').textContent   = fmtVND(s.total_revenue || 0);

    // Recent orders
    const rows = (data.orders || []);
    document.getElementById('dashboardOrders').innerHTML = rows.length
      ? rows.map(o => `<tr>
          <td style="font-weight:600;color:var(--accent)">${escHtml(o.order_code)}</td>
          <td>${escHtml(o.customer_name || o.customerName || 'â€”')}</td>
          <td>${fmtVND(o.amount_total || o.price)}</td>
          <td><span class="badge ${badgeClass(o.status)}">${badgeLabel(o.status)}</span></td>
          <td style="color:var(--text2)">${fmtTime(o.created_at)}</td>
        </tr>`).join('')
      : '<tr><td colspan="5" class="empty">ChÆ°a cÃ³ Ä‘Æ¡n nÃ o</td></tr>';

    updateClock();
  } catch (e) { console.error('[admin] dashboard', e); }
}

// â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  try {
    const status = document.getElementById('orderStatusFilter').value;
    const search = document.getElementById('orderSearch').value.trim();
    let url = `${BASE}/admin-orders?limit=100`;
    if (status) url += `&status=${status}`;

    const r = await fetch(url, { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    const data = await r.json();

    let rows = data.orders || [];

    // Client-side search filter (order_code or email)
    if (search) {
      const q = search.toLowerCase();
      rows = rows.filter(o =>
        (o.order_code||'').toLowerCase().includes(q) ||
        (o.customer_email||'').toLowerCase().includes(q) ||
        (o.customerEmail||'').toLowerCase().includes(q)
      );
    }

    document.getElementById('ordersBody').innerHTML = rows.length
      ? rows.map(o => `<tr>
          <td style="font-weight:600;color:var(--accent)">${escHtml(o.order_code)}</td>
          <td>${escHtml(o.customer_name || o.customerName || 'â€”')}</td>
          <td style="color:var(--text2)">${escHtml(o.customer_email || o.customerEmail || 'â€”')}</td>
          <td>${fmtVND(o.amount_total || o.price)}</td>
          <td><span class="badge ${badgeClass(o.status)}">${badgeLabel(o.status)}</span></td>
          <td style="color:var(--text2);font-size:12px">${escHtml(o.payment_tx_id || 'â€”')}</td>
          <td style="color:var(--text2)">${fmtTime(o.created_at)}</td>
        </tr>`).join('')
      : '<tr><td colspan="7" class="empty">KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n</td></tr>';

    updateClock();
  } catch (e) { console.error('[admin] orders', e); }
}

// â”€â”€ INVENTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInventory() {
  try {
    const r = await fetch(`${BASE}/inventory?action=all`);
    const data = await r.json();
    const rows = data.inventory || [];

    document.getElementById('inventoryBody').innerHTML = rows.length
      ? rows.map(i => `<tr>
          <td style="font-weight:600">${escHtml(i.code || i.product_code)}</td>
          <td style="color:var(--green);font-weight:600">${i.available_units || i.available || 0}</td>
          <td style="color:var(--red)">${i.sold_units || i.sold || 0}</td>
          <td style="color:var(--yellow)">${i.reserved_units || i.reserved || 0}</td>
          <td>${i.total_units || i.total || 0}</td>
        </tr>`).join('')
      : '<tr><td colspan="5" class="empty">ChÆ°a cÃ³ hÃ ng trong kho</td></tr>';

    updateClock();
  } catch (e) { console.error('[admin] inventory', e); }
}

// â”€â”€ AUDIT LOGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses audit_logs table via a tiny inline query (admin-orders doesn't expose it,
// so we query order-status per-order or just read webhook-logs + fallback).
async function loadLogs() {
  try {
    // webhook-logs endpoint returns audit data if table exists
    const r = await fetch(`${BASE}/webhook-logs?limit=50`, { headers: authHeaders() });
    if (r.status === 401) return handleUnauth();
    const data = await r.json();
    const rows = data.logs || [];

    document.getElementById('logsBody').innerHTML = rows.length
      ? rows.map(l => `<tr>
          <td style="font-weight:600;color:var(--accent)">${escHtml(l.event_type || l.event || 'â€”')}</td>
          <td>${escHtml(l.entity_type || 'â€”')}</td>
          <td>${escHtml(l.entity_id || l.order_id || 'â€”')}</td>
          <td style="color:var(--text2)">${escHtml(l.source || l.actor || 'â€”')}</td>
          <td style="color:var(--text2);font-size:12px;max-width:260px;overflow:hidden;text-overflow:ellipsis">${escHtml(l.payload || l.message || 'â€”')}</td>
          <td style="color:var(--text2)">${fmtTime(l.created_at)}</td>
        </tr>`).join('')
      : '<tr><td colspan="6" class="empty">ChÆ°a cÃ³ log nÃ o</td></tr>';

    updateClock();
  } catch (e) { console.error('[admin] logs', e); }
}

// â”€â”€ UNAUTH handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleUnauth() {
  sessionStorage.removeItem('tbq_admin_token');
  ADMIN_TOKEN = '';
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('shell').style.display = 'none';
  document.getElementById('loginErr').textContent = 'âš ï¸ Token háº¿t háº¡n â€“ Ä‘Äƒng nháº­p láº¡i';
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function () {
  if (ADMIN_TOKEN) {
    // try auto-login with saved token
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('shell').style.display = 'flex';
    startAutoRefresh();
    loadDashboard();
  }
};
</script>
</body>
</html>
